---
title: "HF prognosis with CKB Data v18.0"
author: "Valirie N. Agbor"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r Import packages and data}

# setting WD and loading required packages 
setwd ("J:/DPhil/First year/HF prognosis/Data analysis/Analysis for TOS")

rm (list = ls())

# Silence dplyr messages 
options(tidyverse.quiet = TRUE)


#Loading required packages

pacman::p_load(
   # Descriptive tables 
   DirectStandardisation, compareGroups, Epi, lubridate,
   
   # Data manipulation 
   tidyverse, dplyr, purrr, stringr,forcats, 
   
   #For plotting 
   Jasper, ggplot2, gridExtra,ggpubr, showtext,
   
   #Survival analysis
   survival,survminer, cmprsk,
   
   # Meta-analysis 
   meta, metafor)


# font_import()
# loadfonts(device = c("all", "pdf", "postscript", "win"), quiet = TRUE)

#loading baseline data
baseline <- read_csv("K:/kadoorie/Staff_Folders/Valirien/DAR-2022-00245-V1 - Copy/data_baseline_questionnaires.csv", col_types = cols())
endpoint <- read_csv("K:/kadoorie/Staff_Folders/Valirien/DAR-2022-00245-V1 - Copy/endpoints.csv", col_types = cols())


knitr::opts_chunk$set(echo = TRUE)
```


# Load functions --

```{r}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/prepare_lancet_barplot_data.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/add_table_header.R")
source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/trend_het_test.R")
```


# Data cleaning and manipulation

Five data sets are available

-   Baseline questionnaire
-   Endpoints: This dataset only contains first events (based on my
    discussion with Sam at the data access unit)
-   Endpoints_events: This contains detailed information about recurrent
    events and will be used to analyse recurrence
-   Resurvey (first and second)


The different event **sources** are as follows

-   **dis_ep**   = Disease episode statistics
-   **hiip_ep**  = Health insurance INPATIENT
-   **hiiop_ep** = Health insurance OUTPATIENT
-   **da_ep**    = Death from any cause
-   **du_ep**    = Underlying cause of death

-   *icase* and *pvd* are 



```{r Endpoint definition}

# Endpoint headers

end_new_names <- c("Asthma","PHD", "HF","RD", "MACE", 
                   "COPD", "Acute_MI", "IHD", "CVD")

end_pattern   <- c("ep_CKB0063", "ep_CKB0012", "ep_CKB0080", "ep_CKB0032", 
                   "ep_CKB0072", "ep_CKB0033", "ep_CKB0004", "ep_CKB0003", 
                   "ep_CKB0071")


for (i in 1:length(end_new_names)) {
  colnames(endpoint) <- str_replace_all (names(endpoint), end_pattern[i], end_new_names[i])
}


# define inpatient events 

endpoint <- 
    endpoint %>% 
    dplyr::mutate(
      phd_inpatient = case_when(PHD_combined_ep == 1 & PHD_hiop_ep == 0 ~ 1,TRUE ~ 0), 
      hf_inpatient  = case_when(HF_combined_ep == 1  & HF_hiop_ep == 0 ~ 1, TRUE ~ 0))  %>% 
    dplyr::select(
      csid, 
      hf_inpatient, 
      phd_inpatient, 
      contains(c("combined", "hiop_ep"))
      )

endpoint <- endpoint %>% select(!contains(c("Asthma", "MACE", "CVD", "RD"))) 


# Define participants with co-occurence of HF and PHD 
endpoint <- 
  endpoint %>%
  dplyr::mutate(
    
    co_hf_phd = factor(case_when(hf_inpatient == 1 & phd_inpatient == 1 ~ "Yes", TRUE ~ "No"), levels = c("Yes", "No")), 
    
    hf_phd_timing = case_when(co_hf_phd == "Yes" & (PHD_combined_datedeveloped <= HF_combined_datedeveloped) ~ "Before", 
                              co_hf_phd == "Yes" & (PHD_combined_datedeveloped > HF_combined_datedeveloped) ~ "After", 
                              TRUE ~ "No PHD"),
               
    phd_hf_timing = case_when(co_hf_phd == "Yes" & (HF_combined_datedeveloped <= PHD_combined_datedeveloped) ~ "Before", 
                              co_hf_phd == "Yes" & (HF_combined_datedeveloped > PHD_combined_datedeveloped) ~ "After", 
                              TRUE ~ "No HF")
    
    )


# Outpatient HF and PHD events 
sum(endpoint$HF_combined_ep) - sum(endpoint$hf_inpatient); sum(endpoint$PHD_combined_ep) - sum(endpoint$phd_inpatient)

# 

```


```{r merging all data sets}

# baseline_resurv <-  merge(baseline, resurveys, by = "csid", all = TRUE)
# merged_data <- merge(baseline_resurv, endpoint, by = "csid", all=TRUE)

merged_data <- merge(baseline, endpoint, by = "csid", all=TRUE)

```

# Summarising baseline characteristics of study participants

-   Remember that there are some overlaps of heart failure and PHD
    cases, and as a results the number of events n the columns of this
    summary table will not be mutually exclusive.

-   Ever-regular smokers were defined by as current smoker and **those
    who stopped smoking because of a disease condition** See:
    [https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(15)00340-2/fulltext](https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(15)00340-2/fulltext){.uri}
    
    
> Categorising alcohol consumption in the CKB (based on discussion with Huaidong)
- Regular drinkers = current drinkers 
- categories 3-5 can be combined into a single category 
- 

```{r Baseline characteristics}

    #1. Demographic characteristics: Age, sex, area, region, marital status, education, household income, occupation
 
 merged_data <- merged_data %>% 
  
                 mutate(age = age_at_study_date_x100/100, # Age in years 
                        
                        #10 years age groups 
                        age_group10 = factor(case_when(age <  40 ~ "30-39", 
                                                       age >= 40 & age < 50 ~ "40-49", 
                                                       age >= 50 & age < 60 ~ "50-59",
                                                       age >= 60 & age < 70 ~ "60-69",
                                                       age >= 70 & age < 80 ~ "70-79")), 
                        
                        age_group3  = factor(case_when(age <  50 ~ "Below 50", 
                                                       age >= 50 & age < 70 ~ "50-69", 
                                                       age >= 70 ~ "70+")),
                        
                        age65       = factor(ifelse(age >= 65, "65 and over", "Below 65")),
                         
                        
                        #Sex
                        sex = factor(ifelse(is_female == 1, "Women", "Men")), 
                        
                        #Area (urban and rural)
                        area = factor(region_is_urban, 
                                             levels = c(1, 0), 
                                             labels = c("Urban", "Rural")), 
                        
                        #Region (All 10 regions)
                        region = factor(region_code,
                                         levels = c(12, 16, 26, 36, 46, 52, 58, 68, 78, 88),
                                         labels = c("Qingdao", "Harbin", "Haikou", "Suzhou", "Liuzhou",
                                                    "Sichuan", "Gansu", "Henan", "Zhejiang", "Hunan")), 
                        
                        #Marital status 
                        marital_status_married = as.factor(ifelse(marital_status == 0, "Married", "Other")),
          
                        #Level of education
                        edu = factor(case_when(highest_education == 0 ~ "No formal", 
                                               highest_education == 1 ~ "Primary", 
                                               highest_education == 2 ~ "Middle", 
                                               highest_education >= 3 ~ "High school or higher"), 
                                     
                                     levels = c("No formal", "Primary", "Middle", "High school or higher")),
                        
                        edu_bin = factor(case_when(edu == "No formal" ~ "No formal", 
                                                   edu == "Primary"   ~ "Primary", 
                                                   TRUE ~ "Middle school or higher")),
                        
                        #Household income 
                        h_income = factor(case_when(household_income <= 2 ~ "<10k", 
                                                    household_income == 3 ~ "10k-29.9k", 
                                                    household_income == 4 ~ "30k-34.9k", 
                                                    TRUE ~ ">=35k"), 
                                          
                                          levels = c("<10k", "10k-29.9k", "30k-34.9k", ">=35k")),
                        
                        h_income_bin = factor(ifelse(household_income <= 2 & !is.na(household_income), "<10k", "10k and over")),
                        
                        #Occupation 
                        occupation_fct = as.factor(occupation), 
                        occupation = fct_recode(occupation_fct, agriculture_and_related   = "0",  
                                                                factory_worker            = "1", 
                                                                administrator_or_manager  = "2", 
                                                                professional_or_technical = "3", 
                                                                sales_and_service_workers = "4", 
                                                                retired                   = "5", 
                                                                housewife_or_husband      = "6", 
                                                                self_employed             = "7", 
                                                                unemployed                = "8", 
                                                                other_or_not_stated       = "9"),
                        
                        occu_farmer = factor(ifelse(occupation == "agriculture_and_related", "agriculture_and_related", "Others")))

 

    #2. Lifestyle factors: Ever-regular smokers, weekly drinkers, total physical activity 

merged_data %>% 
      mutate(smoking_status = factor(case_when(smoking_category == 1 ~ "Never smoker", 
                                               smoking_category == 2 | smoking_category == 3 ~ "Ever-smoker", 
                                               TRUE ~ "Current")),              
             
             ever_reg_smoker = factor(ifelse(smoking_status != "Never smoker", "Ever regular", "Never")),
             
             #Weekly drinkers 
             alcohol_category = as.factor(alcohol_category),
             alcohol_category = fct_recode(alcohol_category, "Never regular drinkers" = "1", 
                                                             "Ex-regular drinkers"    = "2", 
                                                             "Reduced intake"         = "3", 
                                                             "Occasional drinkers"    = "4", 
                                                             "Occasional drinkers"    = "5", 
                                                             "Regular drinker"        = "6"), 
             
             alcohol_recode  = factor(case_when (alcohol_category == "Regular drinker"        ~ "Current",
                                                 alcohol_category == "Ex-regular drinkers"    ~ "Ex-drinkers",
                                                 alcohol_category == "Never regular drinkers" ~ "Never", 
                                                 TRUE ~ "Others"
                                                 ),
                                      
                                      levels = c("Current", "Ex-drinkers", "Never", "Others")), 
             
             current_drinkers = factor(ifelse(alcohol_category == "Regular drinker", "Yes", "No"), 
                                       levels = c("Yes", "No")
                                       ),
             
             #Total physical activity 
             PA_met = met,  
             
             bmi_cat = factor(case_when(bmi_calc  < 18.5 ~ "Underweight", 
                                         bmi_calc >= 18.5 & bmi_calc < 23 ~ "Normal", 
                                         bmi_calc >= 23 & bmi_calc < 25 ~ "Overweight", 
                                         bmi_calc >= 25 ~ "Obesity", 
                                         TRUE ~ as.character(NA)), 
                               
                               levels = c("Underweight", "Normal", "Overweight", "Obesity")))  ->  merged_data 

 
   #4. Self reported health and prevalent disease

lab_yesno <- c("Yes", "No")


merged_data <- 
  
  merged_data %>%  
      mutate(## CVD and metabolic diseases
         rhd        = factor(ifelse(rheum_heart_dis_diag == 1, "Yes", "No"), levels = lab_yesno),
         
         chd        = factor(ifelse(chd_diag == 1, "Yes", "No"), levels = lab_yesno),          
         
         stroke_tia = factor(ifelse(stroke_or_tia_diag == 1, "Yes", "No"), levels = lab_yesno),
         
         HTN        = factor(ifelse(hypertension_diag == 1          | 
                                    used_blood_pressure_drugs == 1 | 
                                    sbp_mean >= 140               | 
                                    dbp_mean >= 90, "Yes", "No"), 
                             levels = lab_yesno), 
         
         diabetes       = factor(ifelse(has_diabetes == 1, "Yes", "No"), levels = lab_yesno),  
         
         chd_stroke_tia = factor(ifelse(chd == "Yes" | stroke_tia == "Yes", "Yes", "No"), levels = lab_yesno),
         
         # Chronic lung disease 
         copd                 = factor(ifelse(has_copd == 1, "Yes", "No"), levels = lab_yesno),
         
         tuberculosis         = factor(ifelse(tb_diag == 1, "Yes", "No"), levels = lab_yesno), 
         
         emphysema_bronchitis = factor(ifelse(emph_bronc_diag == 1, "Yes", "No"), levels = lab_yesno), 
         
         asthma               = factor(ifelse(asthma_diag == 1, "Yes", "No"), levels = lab_yesno),
         
         emphy_bronc_asthma   = factor(ifelse(emphysema_bronchitis == "Yes" | 
                                            asthma == "Yes", "Yes", "No"), levels = lab_yesno),
         
         CLD = factor(case_when(emphy_bronc_asthma == "Yes" | copd == "Yes" ~ "Yes", 
                                
                                TRUE ~ "No"), levels = lab_yesno),
         
         SOB_walking = factor(ifelse(walking_short_of_breath == 0, "Yes", "No"), levels = lab_yesno),                         
         
         # Others
         cirr_hepb  = factor(ifelse(cirrhosis_hep_diag == 1, "Yes", "No"), levels = lab_yesno), 
         
         rheum_art  = factor(ifelse(rheum_arthritis_diag == 1, "Yes", "No"),  levels = lab_yesno), 
         
         kidney_dis = factor(ifelse(kidney_dis_diag == 1, "Yes", "No"), levels = lab_yesno), 
         
         cancer     = factor(ifelse(cancer_diag == 1, "Yes", "No"), levels = lab_yesno),
         
         self_rated_health = factor(case_when(self_rated_health <= 1 ~ "Excellent or good", 
                                              self_rated_health == 2 ~ "Fair", 
                                              self_rated_health == 3 ~ "Poor")),
         
         poor_health = factor(ifelse(self_rated_health == "Poor", "Yes", "No"))) #For summary table 


## Define comorbidities 

# Variable names 
comobid_vars <- merged_data %>% select(rhd:cancer) %>% names(.)

# Dropped irrelevant variables
comobid_vars <- comobid_vars[-which(comobid_vars%in%c("chd_stroke_tia", "emphy_bronc_asthma", "CLD", "SOB_walking"))]

# Number of comorbidity without hypertension 
comobid_vars_noHT <- comobid_vars[-which(comobid_vars%in%c("chd_stroke_tia", "emphy_bronc_asthma", "CLD", "SOB_walking", "HTN"))]

# create variable 
merged_data <- 
    merged_data %>% 
           mutate(
             n_comobid = merged_data %>% 
                              select(csid, all_of(comobid_vars)) %>% 
                              mutate(across(all_of(comobid_vars), ~ifelse(.x== "Yes", 1, 0))) %>% 
                              mutate(n_com = !!str2lang(paste0(comobid_vars, collapse = "+"))) %>% 
                              pull(n_com) %>% 
                              as.double(.), 
             
             n_comobid_noHT = merged_data %>% 
                              select(csid, all_of(comobid_vars_noHT)) %>% 
                              mutate(across(all_of(comobid_vars_noHT), ~ifelse(.x== "Yes", 1, 0))) %>% 
                              mutate(n_com = !!str2lang(paste0(comobid_vars_noHT, collapse = "+"))) %>% 
                              pull(n_com) %>% 
                              as.double(.)
           ) 

paste0(comobid_vars, collapse = ", ")






merged_data <- merged_data %>% filter(!is.na(bmi_calc)) 
#Remove missing data for BMI. 

rm("baseline", "endpoint")





```

```{r Descriptive Table 1}

require(Hmisc)

## Set appropriate variable labels before tabulations

n_var <- c("age_group10", "age", "edu_bin", "h_income_bin",
           "ever_reg_smoker", "alcohol_reg_drinkers", 
           "bmi_calc", "sbp_mean", "dbp_mean", "heart_rate_mean", 
           "HTN", "chd", "stroke_tia", "copd", "emphy_bronc_asthma", "CLD", "SOB_walking", "poor_health",
           "co_hf_phd", "hf_phd_timing", "phd_hf_timing")


l_var <- c("Age group, year, n (%)", "Age, mean (SD), year", 
           "Level of education, n (%)", "Annual household income < 10 000 Yuan, n (%)",
           
           "Ever-regular smoker, n (%)", "Regular alcohol drinker, n (%)", 
           
           "BMI, mean (SD), kg/m2","SBP, mean (SD), mmHg", 
           "DBP, mean (SD), mmHg", "Resting heart rate, mean (SD), bpm",
           
           "Hypertension, n (%)", "Coronary heart disease, n (%)", 
           "Stroke and TIA, n (%)", "COPD, n (%)", "Emphysema, bronchitis or asthma, n (%)", "Chronic lung disease, n (%)", 
           "Shortness of breath on walking, n (%)", "Poor self-rated health, n (%)", 
           "HF and PHD Co-occurrence, n (%)", "Timing of HF occurrence, n (%)", "Timing of PHD occurrence, n (%)")


for (i in seq_along(n_var)) {
  Hmisc::label(merged_data[ ,n_var[i]]) <- l_var[[i]]
}


#1. Heart failure

tab_hf <-  descrTable(hf_inpatient ~ age + sex + area + edu_bin + h_income_bin + occupation +                   
                      ever_reg_smoker + alcohol_reg_drinkers +                                                                
                      bmi_calc + sbp_mean + dbp_mean + heart_rate_mean +                                               
                      HTN + diabetes + chd + stroke_tia + copd + emphysema_bronchitis + CLD + tuberculosis +
                      asthma + emphy_bronc_asthma + SOB_walking + poor_health + 
                      co_hf_phd + hf_phd_timing, merged_data, hide.no = "No")


# 2. Pulmonary heart disease
tab_phd <- descrTable(phd_inpatient ~ age + sex + area + edu_bin + h_income_bin + occupation +                   
                      ever_reg_smoker + alcohol_reg_drinkers +                                                                
                      bmi_calc + sbp_mean + dbp_mean + heart_rate_mean +                                               
                      HTN + diabetes + chd + stroke_tia + copd + emphysema_bronchitis + CLD + tuberculosis +
                      asthma + emphy_bronc_asthma + SOB_walking + poor_health + 
                      co_hf_phd + phd_hf_timing, merged_data, hide.no = "No")


# 3. Overall
all_participants <- merged_data %>%
                          select(age, sex, area, edu_bin, h_income_bin, occupation,
                                 
                                 ever_reg_smoker, alcohol_reg_drinkers,
                                 
                                 bmi_calc, sbp_mean, dbp_mean, heart_rate_mean, 
                                 
                                 HTN, diabetes, chd, stroke_tia, copd, emphysema_bronchitis, CLD, tuberculosis,
                                 asthma, emphy_bronc_asthma, SOB_walking, poor_health, 
                                 
                                 co_hf_phd, hf_phd_timing, phd_hf_timing)


tab_overall <- descrTable(all_participants, hide.no = "No")


# Extract tables into excel

export2xls(tab_hf, file = "Table_HF.xlsx")
export2xls(tab_phd, file = "Table_PHD.xlsx")
export2xls(tab_overall, file = "Table_ALL.xlsx")


# Obtain sex-specific n(%) for men and women

all_gender <- merged_data %>% select(sex, ever_reg_smoker, alcohol_reg_drinkers, tuberculosis )

tab_gen1 <- list()
tab_gen2 <- list()
tab_gen3 <- list()


for (i in seq_along(c("Men", "Women"))) {
  
  tab_gen1[[i]] <- descrTable(hf_inpatient ~ ever_reg_smoker + alcohol_reg_drinkers, 
                            selec = list(ever_reg_smoker = sex == c("Men", "Women")[[i]],
                                         alcohol_reg_drinkers = sex == c("Men", "Women")[[i]]),
                            merged_data, hide.no = "No")
  
  tab_gen2[[i]] <- descrTable(phd_inpatient ~ ever_reg_smoker + alcohol_reg_drinkers, 
                            selec = list(ever_reg_smoker = sex == c("Men", "Women")[[i]],
                                        alcohol_reg_drinkers = sex == c("Men", "Women")[[i]]),
                            merged_data, hide.no = "No")
  
  tab_gen3[[i]] <- descrTable(all_gender,

                            selec = list(ever_reg_smoker = sex == c("Men", "Women")[[i]],
                                         alcohol_reg_drinkers = sex == c("Men", "Women")[[i]]), hide.no = "No")
}
 

tab_gen1 <- descrTable(hf_inpatient ~ tuberculosis, merged_data, hide.no = "No")

tab_gen2 <- descrTable(phd_inpatient ~ tuberculosis,merged_data, hide.no = "No")
  
tab_gen3 <- descrTable(all_gender, hide.no = "No")

rm("tab_hf", "tab_phd", "all_participants", "tab_overall", "all_gender", "tab_gen1", "tab_gen2", "tab_gen3")


#Summarise number of comorbidties 

## All participants 
merged_data %>% 
  select(n_comobid) %>% 
  transmute(over_one_comobid = ifelse(n_comobid >= 1, "Yes", "No")) %>% 
  {addmargins(table(.))}

## Heart failure 
merged_data %>% 
  filter(hf_inpatient == 1) %>% 
  select(n_comobid) %>% 
  transmute(over_one_comobid = ifelse(n_comobid >= 1, "Yes", "No")) %>% 
  {addmargins(table(.))}

## PHD
merged_data %>% 
  filter(phd_inpatient == 1) %>% 
  select(n_comobid) %>% 
  transmute(over_one_comobid = ifelse(n_comobid >= 1, "Yes", "No")) %>% 
  {addmargins(table(.))}



#Summarise number of comorbidties (Excluding Hypertension)

## All participants 
merged_data %>% 
  select(n_comobid_noHT) %>% 
  transmute(over_one_comobid = ifelse(n_comobid_noHT >= 1, "Yes", "No")) %>% 
  {addmargins(table(.))}

## Heart failure 
merged_data %>% 
  filter(hf_inpatient == 1) %>% 
  select(n_comobid_noHT) %>% 
  transmute(over_one_comobid = ifelse(n_comobid_noHT >= 1, "Yes", "No")) %>% 
  {addmargins(table(.))}

## PHD
merged_data %>% 
  filter(phd_inpatient == 1) %>% 
  select(n_comobid_noHT) %>% 
  transmute(over_one_comobid = ifelse(n_comobid_noHT >= 1, "Yes", "No")) %>% 
  {addmargins(table(.))}


detach("package:Hmisc", unload = TRUE)

```


## Filter datasets
````{r}


filt_variables <- c(
  
  "HF_combined_datedeveloped", 
  "PHD_combined_datedeveloped", 
  "hf_inpatient", 
  "phd_inpatient", 
  "censoring_reason",
  "COPD_combined_ep", 
  "COPD_combined_datedeveloped", 
  "Acute_MI_combined_ep", 
  "Acute_MI_combined_datedeveloped", 
  "IHD_combined_ep", 
  "IHD_combined_datedeveloped", 
  
  "dob_anon", 
  "study_date", 
  
    # Subgroup variables
  # "agegrp",
  "age65",
  "sex", 
  "area", 
  "region",
  "edu",
  "highest_education",
  "bmi_cat", 
  "HTN", 
  "diabetes", 
  "copd", 
  "chd", 
  "ever_reg_smoker",
  "alcohol_recode",
  "n_comobid"
  
)

```


## Heart and PHD standardised incidence rate (OVERALL)

All incidence rates were calculated across different age-at-risk categories. 

Incidence rates were adjusted by **direct standardisation** to the entire CKB population 
** Participants with outpatient HF and PHD diagnosis were excluded from the analysis

I made use of the function developed by **Neil**
I separate the function in two (the Lexis expansion and standard parts) to fit my end

### Age-specific incidence rate

-   Fit Poisson models with random intercepts to calculate the pool
    age-specific incidence rate. (use age-at-risk instead)
-   Estimates where log-transformed before pooling
-   The Restricted Maximum Likelihood Estimator was used to estimate
    tau^2




```{r Age-specific incidence rate}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/standardised incidence.R")


# Create list to hold datasets
# Drop outpatient events (hf_outpatient == 1)
 
data_expanded   <- list(merged_data %>% filter(HF_hiop_ep == 0) %>% select(all_of(filt_variables)), 
                        merged_data %>% filter(PHD_hiop_ep == 0)%>% select(all_of(filt_variables))) 

 
# Vectors of necessary labels 
exit_date_lab   <- c("HF_combined_datedeveloped", "PHD_combined_datedeveloped")
exit_status_lab <- c("hf_inpatient", "phd_inpatient")


# Expand datasets
for (df in seq_along(data_expanded)) { 
  
  data_expanded[[df]] <-  lexis_expansion(data          = data_expanded[[df]], 
                                          birth_date    = "dob_anon", 
                                          entry_date    = "study_date", 
                                          exit_date     = exit_date_lab[df],
                                          agegrp_breaks = c(30, 50, 60, 70, 80, 100),
                                          status        = exit_status_lab[df])
}

# Descriptives: Number of events and length of follow-up 
# map(.x = data_expanded, ~ summary.Lexis(.x, timeScales = TRUE))

```

## Age-specific incidence --

Age-specific IR by age-at-risk and sex 

 + Split dataset by sex and area (urban/rural)
 + Run overall age-specific analysis (no more need for stratification)
 + Manipulation
 

```{r Age-specific incidence}


data_expanded <- map(.x = data_expanded, ~dplyr::mutate(.x, all = 1))

# Overall standardised incidence rate (by age, sex, and area)

std_ir_overall <- 
  
  map( 
    .x = data_expanded,
    ~incidence_rates (
      data     = .x, 
      group    = "all",  
      strata   = c("agegrp", "sex", "area"), 
      per_pyar = 100000) %>% 
      pluck(., 2) %>% 
      mutate(
         lci      = std_ir - 1.96*std_ir_se, 
         uci      = std_ir + 1.96*std_ir_se,
         stdir_ci = paste0(round(std_ir), " (", round(lci), " - ", round(uci), ")")) 
    ) 
               

std_ir_all <- map(.x = std_ir_overall, ~.x$stdir_ci)


# Figure 1: Age-specific IR by sex and area

data_expanded <- map2(.x = data_expanded, 
                      .y = seq_along(data_expanded),
                      ~dplyr::mutate(.x, outcome = c("hf", "phd")[.y]) # Indicator for the dataset
                      )  


df_ir <- map(.x = data_expanded, 
             ~dplyr::group_by(.x, sex, area) %>% 
              dplyr::group_split() %>%             
               
             # Calculate IR for each dataset
             map(~ incidence_rates (
                         data     = .x, 
                         group    = "agegrp",  # Age-at-risk 
                         strata   = "all",
                         per_pyar = 100000) %>%  
             pluck(., 2) %>% 
             mutate(
                mean_age =  group_by(.x, agegrp) %>%  
                            summarise(mean_age = mean(age_lexis, na.rm = TRUE), .groups = "drop") %>% 
                            pull(mean_age),
                
                sex     = unique(as.character(.x$sex)),     
                area    = unique(as.character(.x$area)),
                outcome = unique(as.character(.x$outcome)), # Get name of outcome 
                
                lci = std_ir - 1.96*std_ir_se, 
                lci = ifelse(lci < 1, 1, lci), # Fix lci < 1 for plotting 
                uci = std_ir + 1.96*std_ir_se)
                 
             )
             
             
        )   
 
for(j in seq_along(df_ir)) { 
 
  df_ir[[j]] <- list(bind_rows(df_ir[[j]][ seq_len(2)]),  bind_rows(df_ir[[j]][ 3:4 ]))
  
  }


df_ir <- df_ir %>% flatten() 



# Get standardised incidence by sex and area for plotting --

ir_sexArea <- map(.x = data_expanded, 
                 ~dplyr::group_by(.x, sex) %>% 
                  dplyr::group_split() %>%             # Split into sex and area datasets 
                   
                   # Calculate IR for each dataset
                   map(~ incidence_rates (
                               data     = .x, 
                               group    = "area", 
                               strata   = "agegrp",    # Standardise by age-at-risk 
                               per_pyar = 100000) %>%  
                   pluck(., 2) %>% 
                   mutate(
                      sex     = unique(as.character(.x$sex)),    
                      outcome = unique(as.character(.x$outcome)), # Get name of outcome 
                      
                      lci = std_ir - 1.96*std_ir_se, 
                      uci = std_ir + 1.96*std_ir_se, 
                      std_ir = paste0(round(std_ir), " (", round(lci), " - ", round(uci), ")")
                   ) %>% 
                  
                     arrange(std_ir)
             
                 )) %>% flatten()  


# Get overall incidence rate for men and women--

ir_sex <- 
    
    map(
      .x = data_expanded,
      ~ incidence_rates (
                 data     = .x, 
                 group    = "sex", 
                 strata   = c("agegrp", "area"),    
                 per_pyar = 100000) %>%  
       pluck(., 2) %>% 
       mutate(
          outcome = unique(as.character(.x$outcome)), # Get name of outcome 
          lci = std_ir - 1.96*std_ir_se, 
          uci = std_ir + 1.96*std_ir_se,
          std_ir = paste0(round(std_ir), " (", round(lci), " - ", round(uci), ")"))
        
        )

# Split datasets to have a list of length 4 as the others 
# This will be helpful when looping through datasets 
ir_sex_split <- map(.x = ir_sex, ~group_by(.x, sex) %>% group_split()) %>% flatten() 


# Bind urban - rural data to main dataset -- 
df_ir <- 
  map2(
    .x = df_ir, 
    .y = ir_sexArea, 
    ~inner_join(
      .x, 
      .y %>% 
        transmute(
          area = area, sex = sex, std_ir_area = std_ir), by = c("area", "sex")) %>% 
      mutate(area = factor(paste0(area, ":"))) %>% 
      arrange(area)
  )

```


## Figure 1: Age-specific analysis --

 
```{r}
# Create sex and area plot 

plot.title  <- c("Heart failure\n", NA, "Pulmonary heart disease\n", NA)
y_lab_title <- list(
                  expression(paste("Hospitalisation rate / ", 10^5, " person-years", sep = "")), "",
                  expression(paste("Hospitalisation rate / ", 10^5, " person-years", sep = "")), ""
                  )

area_levels <- levels(data_expanded[[1]]$area)
font_style  <- ""
x_age_text  <- 40



plot_list <- 

  map2(
    .x = df_ir, 
    .y =seq_along(df_ir), 
    
    ~ ggplot(data = .x, aes(x = mean_age, y = std_ir, group = area)) + 
          geom_line(linewidth = 0.7, aes(linetype = area)) + 
          geom_point(shape = 15, size = 1.5) + 
          geom_errorbar(aes(x = mean_age, std_ir, ymin = lci, ymax = uci), width = 0.5, linewidth = 0.6) + 
  
    # Get theme  
      theme_void() +
      theme(axis.text.x  = element_text(size   = 13, vjust = 5),
            axis.text.y  = element_text(size   = 13, hjust = 1), 
            axis.title.x = element_text(size   = 13, vjust = -1), 
            axis.title.y = element_text(size   = 14, angle = 90)) +
      
    # Use geom_seqment to draw axes that do not touch
      geom_segment(mapping = aes(x = 38, xend = 38, y = 1, yend = 10000), linewidth = 0.7) + 
      geom_segment(mapping = aes(x = 40, xend = 90, y = 0.65, yend = 0.65), linewidth = 0.7) +
    
      theme(axis.ticks        = element_line(linewidth = 0.6),
            axis.ticks.length = unit(0.25, "cm"), 
            plot.margin       = unit(c(2, 0.5, 1, 0.5), "cm"),
            legend.position   = list(c(0.2, 0.9), "none", c(0.2, 0.9), "none")[[.y]]
            ) + 
     
      # Edit legend 
      guides(
         linetype = guide_legend(
                          title       = "", 
                          title.theme = element_text(size = 11.5, face = "bold"), title.hjust = 0,
                          label.theme = element_text(size = 11.5, lineheight = 0.9), label.hjust = 0)
                ) +  
        
      
     # Axes 
      coord_cartesian(xlim = c(38, 90.01), ylim = c(1, 10000), clip = "off") +
      
      scale_x_continuous(expand = c(0, 0), 
                         limits = c(38, 90),
                         breaks = seq(40, 90, 10), 
                         labels = paste0("\n", seq(40, 90, 10))) +
      
      scale_y_log10(expand =  c(0.05, 0), breaks = scales::breaks_log(7)) + 
       
      scale_linetype_manual(
            values = c("dashed", "solid"), 
            limits = levels(.x$area)
            ) +
     
      # Figures for SIR
      geom_text(x      = rep(c(58, 40), 2)[.y], 
                y      = log10(4000), 
                label  = paste0(unique(.x$std_ir_area), collapse = "\n"), 
                size   = 4, 
                lineheight = 1.3,
                color  = "black", 
                hjust  = 0) +
      
      # Panel title 
      geom_text(x      = 37, 
                y      = log10(10^4 + 9000), 
                label  = paste0(LETTERS[.y], ". ", unique(ir_sexArea[[.y]]$sex)), 
                size   = 3.7, 
                color  = "black", 
                fontface = 2, 
                hjust  = 0) + 
      
      # Plot title
      geom_text(x        = c(25, 25, 28, 28)[.y], 
                y        = log10(5 * 10^4), 
                label    = plot.title[.y], 
                size     = 5, 
                color    = "black", 
                hjust    = 0, 
                fontface = 2) +
    
      ylab(y_lab_title[[.y]]) +
      xlab( c("", "", "Age at risk (years)", "Age at risk (years)")[.y] )

  
 ) 
 

## Export plot 
plot <- ggarrange (plotlist = plot_list, 
                   ncol     = 2,
                   nrow     = 2,
                   widths   = rep(1, 4), 
                   heights  = rep(1.5,4))
   
 
ckbplotr::save_figure(
   plot, 
   ext = c("png", "png"),
   pagesize    = c("A4"),
   # pagedim = unit(c(3, 7.5), "in"),
   margin  = unit(c(0.1, 1.1, 0.5, 0.8), units = "cm"),
   landscape = FALSE, 
   cropped = TRUE,
   name = paste0(Sys.Date(), "_", "Figure 1. Age-specific hospitalisation rate manuscript"),  
   title = "",
   args = list(bg = "white",pointsize = 1),
   args_cropped = list(bg = "white",pointsize = 1)
 )      
  
   
``` 


### Standardised incidence rate by SUBGROUPS 


```{r Standardised incidence rate}



# Recode number of comorbidties 
data_expanded <- map(.x = data_expanded, 
                     ~mutate(.x, 
                             n_combid_cat = factor(ifelse(n_comobid >= 2, "2+", n_comobid)), 
                             ageatrisk65  = ifelse(age_lexis >= 65, "65+", "Below 65")))
 
# Automating the process 
strata_var    <- c("ageatrisk65", "sex", "area")
grouping_var  <- c("edu", "HTN", "diabetes", "copd", "chd", "n_combid_cat")
group_labels  <- list(
                  "Trend" = "Level of education",
                  "Heterogeneity" = "Hypertension",  
                  "Heterogeneity" = "Diabetes", 
                  "Heterogeneity" = "COPD", 
                  "Heterogeneity" = "Coronary heart disease", 
                  "Trend" = "Number of comorbidities")



# Subgroup analysis ####

subgroup2_temp <- list()
trend_het_test <- list()

for (df in seq_along(data_expanded)) {
  
  subgroup2_temp[[df]] <- 
    
    map2(
      .x = grouping_var,
      .y = seq_along(grouping_var),  
                              
      ~incidence_rates (data     = data_expanded[[df]], 
                        group    = .x, 
                        strata   = strata_var,
                        per_pyar = 100000) %>% 
        
      pluck (., 2) %>% 
      rename("Strata_level" = 1) %>%
      mutate(
        test_type = names(group_labels[.y]), 
        Strata         = group_labels[[.y]],
        crude_pyar1000 = round(crude_pyar/1000),
        lci            = std_ir - 1.96*std_ir_se,
        uci            = std_ir + 1.96*std_ir_se
        ) %>% 
      relocate(Strata, .before = 1)
    )
   
  
  # Perform heterogeneity test -- 
  trend_het_test[[df]] <- 
    
    map(
      .x = subgroup2_temp[[df]], 
      ~if(unique(.x$test_type) == "Trend"){trend(.x$std_ir, .x$std_ir_se) 
      }else{heterogeneity(.x$std_ir, .x$std_ir_se)}
    ) 
  
}
 

subgroup2_list <- list()


for (df in seq_along(subgroup2_temp)) {

  # Join heterogeneity test to subgroup data --
  subgroup2_list[[df]] <-
    
    map2_dfr(
      .x = subgroup2_temp[[df]], 
      .y = trend_het_test[[df]], 
      
      ~.x %>% 
        mutate(
          df   = c(rep(NA, nrow(.)-1), .y$df), 
          chi2 = c(rep(NA, nrow(.)-1), round(.y$`test statistic`, 1)), 
          p    = ifelse(.y$p < 0.0001, "<0.0001", as.character(round(.y$p, 4))),
          p    = ifelse(is.na(df), NA, p)
        )
    ) 
  
       
}    
 






```


### Plotting standardised incidence rate for SUBGROUPS

```{r Plotting standardised incidence rate}

## Format dataframe subgroup analysis for plotting in Jasper 

group_headers <- map(.x = subgroup2_list, ~unique(.x$Strata)) %>% pluck(., 1) 

i_order <- 1:length(group_headers)


# Reoder dataframes for forest plots 

## Edit df headings 


subgroup_ir <-  
  
  map(
    .x = subgroup2_list,   
                    
    ~select(.x, 1:4, std_ir, test_type, lci:p) %>% 
     transmute(
        Strata     = factor(Strata, levels = group_headers), 
        Heading    = Strata_level,
        ne         = crude_nevents,
        py1000     = round(crude_pyar/1000), 
        std_ir     = std_ir,
        LCI        = lci, 
        UCI        = uci, 
        Het        = ifelse(!is.na(df) & test_type == "Heterogeneity", paste(df, chi2, p, sep = ","), NA), 
        Trend      = ifelse(!is.na(df) & test_type == "Trend", paste(df, chi2, p, sep = ","), NA),     
        IsDiamond  = 0, 
        FillColour = 1) %>% 
      
      dplyr::group_by(Strata) %>%
             group_split () %>% 
             map2(.y = group_headers, ~add_row(.x, .before  = 1, Heading  = c(.y)))
    
    )  
 
   
  ## Format and add heading for overall estimates

overall_ir <- 
  map(
   .x = std_ir_overall, 
   ~transmute(
       .x, 
       Heading    = "All", 
       ne         = crude_nevents,
       py1000     = round(crude_pyar/1000),
       std_ir     = std_ir,
       LCI        = lci, 
       UCI        = uci, 
       Het        = NA, 
       Trend      = NA,
       IsDiamond  = 1,  
       FillColour = 0) %>%  
     
    add_row(.before =  1)  
                     # dplyr::mutate(across(.cols = everything(), ~ ifelse(is.na(.x), "", .x)))
    ) 
  
# Bind both datasets --

subgroup_ir <- 
  map(.x = subgroup_ir, ~bind_rows(.x) %>% select(-Strata) %>% add_row(.before = 1)) %>% 
  map2(.y = overall_ir, ~bind_rows(.x, .y))
 


# Make forest plot 
# lab_plot  <- "Figure S2: Standardised hospitalisation rates for heart failure and pulmonary heart disease\nby subgroups\n"

## Try converting to dataframes 
## Was getting the following error: "Warning: Unknown or uninitialised column: `ColHeadings`."
## Converting the tibble into a dataframe fixed the error 

subgroup_ir <- 
  map2(
    .x = subgroup_ir, 
    .y = seq_along(subgroup_ir),
    ~dplyr::rename(
      .x,
      !!paste0("Het", .y) := Het,  
      !!paste0("Trend", .y) := Trend,   
      !!paste0("IsDiamond", .y) := IsDiamond, 
      !!paste0("FillColour", .y) := FillColour
    ) %>% 
      as.data.frame(.)
  ) 
 
forest_dat <- map2(.x = subgroup_ir, 
                   .y = seq_along(subgroup_ir),
                  
                  ~ FormatForest(rawdata     = .x, 
                                 forest.n    = .y,  
                                 EstimateCol = "std_ir",
                                 LCICol      = "LCI", 
                                 UCICol      = "UCI", 
                                 logData     = FALSE, 
                                 getBlanks   = TRUE,  
                                 getHets     = TRUE,  
                                 getTrends   = TRUE))
                  
names(forest_dat) <- c("hf", "phd") 


blank.rows   <- forest_dat$hf$blank.rows 
 
# find labels to put in the left most column
left.labels    <- convertUnicode(as.character(subgroup_ir[[1]]$Heading))
other.cols     <- c("ne", "py1000")

# find column headings
print.headings <- parseColHeadings(subgroup_ir[[1]]$ColHeadings, rd=subgroup_ir[[1]])



# set up the Jasper page
type <- "JPG"

SetPage(orient="PORTRAIT", 
        perpage=1, 
        type=type, 
        filestem = "Fig 2 Subgroup_incidence", 
        page_dpi        = 300,
        page_pointsize  = 20,
        png_bg = "white", 
        page_width = 12,
        # page_height = 10,
        append_datetime =FALSE, 
        suppress.date   =TRUE, 
        titlespace      =0.01,
        footerspace     = 0.01,
        # footer.cex      = 0., 
        footer    = "")

# Hospitalisation rates were directly standardised by age-at-risk, sex, and area (urban/urban). Comorbidity was defined as the presence of rheumatic heart disease, coronary heart disease, 
# stroke, transient ischemic attack, hypertension, diabetes, chronic obstructive pulmonary disease (COPD), tuberculosis, emphysema,  bronchitis, asthma, cirrhosis, hepatitis B, cancer, 
# rheumatoid arthritis, or kidney disease 
# py = person-years
#         \n \n


# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 8.14537797266251, 2))

mainfont <- 1.3
blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

spacing    <- 0.5
plot.width <- 14

x_label <- "Hospitalisation rate per 100,000\npy at risk"

# draw the Forest plot(s)
xaxmin1 <- 27.2542
xaxmax1 <- xaxmin1 + plot.width 
locs <- ForestBasic(forest_dat$hf,
                  	LogScale=FALSE,
                  	ExponentiateDataOnPlot=FALSE,
                  	xaxmin=xaxmin1,
                  	xaxmax=xaxmax1,
                  	xlim=c(-50, 600),
                  	xticks   = seq(0, 600, 200),
                  	ticklabs = seq(0, 600, 200),
                  	xlab= x_label,
                  	NLabel=FALSE,
                  	mainfont=1,
                  	ValueLabels=TRUE,
                  	ValueLabelsHeader="Rate (95% CI)",
                  	ValueDigits=0,
                  	lwd=1,
                  	separator = " - ",
                  	CISecond=TRUE,
                  	# spacing=spacing/2,
                  	pointGroupsFactor=1,
                  	verbose=FALSE,
                  	boxsizeoverride=FALSE,
                  	boxparm.stderr = 2)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x      = xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
     y      = 105, 
     labels = "A. Heart Failure\n", 
     adj    = c(0.5,0), 
     font   = 2, 
     cex    = 1.3,
     col    = "black")


# draw the Forest plot(s)
xaxmin2 <- 72.0592
xaxmax2 <- xaxmin2 + plot.width
locs2 <- ForestBasic(forest_dat$phd,
                    	LogScale=FALSE,
                    	ExponentiateDataOnPlot=FALSE,
                    	xaxmin=xaxmin2,
                    	xaxmax=xaxmax2,
                    	xlim=c(-50, 600),
                    	xticks   = seq(0, 600, 200),
                    	ticklabs = seq(0, 600, 200),
                    	xlab= x_label,
                    	NLabel=FALSE,
                    	mainfont=1,
                    	ValueLabels=TRUE,
                    	ValueLabelsHeader="Rate (95% CI)",
                    	ValueDigits=0,
                    	lwd=1,
                    	separator = " - ",
                    	CISecond=TRUE,
                    	# spacing=spacing/2,
                    	pointGroupsFactor=1,
                    	verbose=FALSE,
                    	boxsizeoverride=FALSE,
                    	boxparm.stderr = 0.9)

# add titles above forest 
text(x=xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2,
     y=105,
     labels="B. Pulmonary heart disease\n",
     adj=c(0.5,0),
     font=2,
     cex = 1.3,
     col="black")

segments(x0 = 0,  y0 = 98, x1 = 96.5, y1=98, lwd = 1)


# left hand column of labels
text(x=0, y=100, labels="Strata",
     adj=c(0,0), font=2, cex=1)

text(x=0, y=locs$YLocs,
     adj=0, cex=1,
     labels=left.labels[-blank.rows], font=ifelse(forest_dat$hf$IsDiamond, 2,1))

text(x=0, y=locs$BlankLocs,
     labels=left.labels[blank.rows], adj=0, font=2, cex=1)



### adding other columns  ####

# Events 1
column1.xpos <- xaxmin1 - 8
text(x=column1.xpos, y=100, labels=convertUnicode("Events(n)"), adj=c(1,0), font=2, cex=1)

text(x      = column1.xpos, 
     y      = locs$YLocs, 
     labels = convertUnicode(as.character(subgroup_ir[[1]][,other.cols[1]]))[-blank.rows], 
     font   = ifelse(forest_dat$hf$IsDiamond, 2, 1), adj=1, cex=1)

text(x=column1.xpos, 
     y=locs$BlankLocs, 
     labels=convertUnicode(as.character(subgroup_ir[[1]][,other.cols[1]]))[blank.rows], adj=1, cex=1)

# PYAR 1
column2.xpos <- xaxmin1 - 1.5
text(x      = column2.xpos, 
     y      = 100, 
     labels = convertUnicode("py/1000"), adj=c(1,0), font=2, cex=1)

text(x      = column2.xpos, 
     y      = locs$YLocs, 
     labels = convertUnicode(as.character(subgroup_ir[[1]][,other.cols[2]]))[-blank.rows], 
     font   = ifelse(forest_dat$hf$IsDiamond, 2, 1), adj=1, cex=1)

text(x      = column2.xpos, 
     y      = locs$BlankLocs, 
     labels = convertUnicode(as.character(subgroup_ir[[1]][,other.cols[2]]))[blank.rows], adj=1, cex=1)



# Event 2 (For PHD)
column3.xpos <- xaxmin2 - 8

text(x      = column3.xpos, 
     y      = 100, 
     labels = convertUnicode("Events(n)"), adj=c(1,0), font=2, cex=1)

text(x      = column3.xpos, 
     y      = locs2$YLocs, 
     labels = convertUnicode(as.character(subgroup_ir[[2]][,other.cols[1]]))[-blank.rows], 
     font   = ifelse(forest_dat$phd$IsDiamond, 2, 1), adj=1, cex=1)

text(x      = column3.xpos, 
     y      = locs2$BlankLocs, 
     labels = convertUnicode(as.character(subgroup_ir[[2]][,other.cols[1]]))[blank.rows], adj=1, cex=1)

# PYAR 2
column4.xpos <- xaxmin2 - 1.5

text(x      = column4.xpos, 
     y      = 100, 
     labels = convertUnicode("py/1000"), adj=c(1,0), font=2, cex=1)

text(x      = column4.xpos, 
     y      = locs2$YLocs, 
     labels = convertUnicode(as.character(subgroup_ir[[2]][,other.cols[2]]))[-blank.rows], 
     font   = ifelse(forest_dat$phd$IsDiamond, 2, 1), adj=1, cex=1)

text(x      = column4.xpos, 
     y      = locs2$BlankLocs, 
     labels = convertUnicode(as.character(subgroup_ir[[2]][,other.cols[2]]))[blank.rows], adj=1, cex=1)



##Plot title
# text(x      = 50.5,
#      y      = 110,
#      font   = 2,
#      cex    = 1.4,
#      adj    = c(0.5, 0),
#      col    = "black",
#      labels = lab_plot)


# Add heterogeneity labels -- 

# Heterogeneity labels 
x_coord <- list("hf"  = 41.8003646765421, 
                "phd" = 86.6423204683451)

# Number of trend and het tests 
chi_p_df <- map(.x = subgroup2_list, 
                ~filter(.x, !is.na(df)) %>% select(test_type, df:p))

n_trend_test   <- map(.x = chi_p_df, ~nrow(filter(.x, test_type == "Trend")))
n_het_test     <- map(.x = chi_p_df, ~nrow(filter(.x, test_type == "Heterogeneity")))


index = 1
# Labels for HF ---
# Heterogeneity labels for HF

for (H in seq_len(n_het_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$df[H]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$chi2[H]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$p[H]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# Trend labels for HF

for (TT in seq_len(n_trend_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$df[TT]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$chi2[TT]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$p[TT]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[TT], 
       adj    = 0, 
       cex    = 0.8,   
       labels = bquote(Trend: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# Labels for PHD ---

# Heterogeneity labels for PHD

index = 2

for (H in seq_len(n_het_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$df[H]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$chi2[H]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$p[H]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# Trend labels for HF

for (TT in seq_len(n_trend_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$df[TT]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$chi2[TT]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$p[TT]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[TT], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Trend: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}



# stop writing to file
closeFile(type)


```


### Plotting incidence by REGION 

```{r Plotting region-sepcific incidence}

# Adjust specific rates have been adjusted for sex and area
 grouping_var <- c("region" )
 strata       <- c("ageatrisk65", "sex")

 # Get names of urban regions 
 urban_region <- merged_data %>% 
                     filter(area == "Urban") %>% 
                     pull(region) %>%
                     as.character(.) %>% 
                     unique(.)
 
 
 df_region_ir <- 
  
    map(
      .x = data_expanded,
      ~incidence_rates (
         data     = .x, 
         group    = grouping_var, 
         strata   = strata,
         per_pyar = 100000) %>% 
                    
        pluck(., 2) %>% 
        mutate(
          lci  = std_ir - 1.96*std_ir_se, 
          uci  = std_ir + 1.96*std_ir_se,
          Area = factor(ifelse(region %in% urban_region, "Urban", "Rural"))) %>% 
      
        arrange(std_ir)
      )


# Get area data -- 

df_area_ir <- 
    
    map(
      .x = data_expanded,
      ~ incidence_rates (
           data     = .x, 
           group    = "area", 
           strata   = c("agegrp", "sex"),    # Standardise by age-at-risk 
           per_pyar = 100000) %>%  
       pluck(., 2) %>% 
       mutate(
          area = as.character(area),
          lci    = std_ir - 1.96*std_ir_se, 
          uci    = std_ir + 1.96*std_ir_se,  
          std_ci = paste0(round(std_ir), " (", round(lci), " - ", round(uci), ")")) %>% 
        
       select(area, std_ci) %>% 
       arrange(area)
      )


# Get region level to maintain sorting when inserting missing rows
region_level_plot <- map(.x = df_region_ir,  ~.x$region)

bar_df_ir <- map(.x = df_region_ir, ~barplot_data(dataset = .x, region_var = "region"))    

 
``` 


```{r}
 
## Create barplot  ####

outcome_lab    <- c("hf", "phd")
outcome_title  <- c("Heart failure", "Pulmonary heart disease")
lab_eventr     <- list(expression("Rate, per 10"^5*" person-years"), "")
font_style     <- ""


x_region_text  = 0.5
x_region_title = 7.5

y_max = 500


barplot_region_ir <- 
  
  map2(
    .x = bar_df_ir, 
    .y = seq_along(bar_df_ir),
                 
    ~ ggplot(data = .x) + 
         geom_col(
           aes(x = region, y = std_ir, fill = Area),
           color = "black", 
           alpha = 0.9, 
           width = 1) +
      
         geom_errorbar(
           aes(x = region, y = std_ir, ymin = lci, ymax = uci), 
           width = 0.3, 
           linewidth = 0.5) + 
      
         geom_text(
           aes(x = region, y = uci, label = round(std_ir)),
           size   = 4,
           vjust  = -0.5,
           color  = "black", 
           fontface = 2,
           hjust  = 0.5) +
    
    #Setting theme 
    theme_void() +
    
    #Theme text 
    theme(
        text              = element_text(family = font_style),
        axis.text.x       = element_text(size = 12, vjust =  0.5, hjust = 1, angle = 90),
        axis.text.y       = element_text(size = 12, hjust = -0.1), 
        axis.title.x      = element_text(size = 14, vjust = -1), 
        axis.title.y      = element_text(size = 14, vjust =  20, angle = 90)) +
   
    theme(
        legend.position   = list(c(0.1, 0.9), "none")[[.y]],  
        axis.line         = element_line(colour = "black", size = 0.6, linetype = "solid"), 
        axis.ticks        = element_line(linewidth = 0.6),
        axis.ticks.x      = element_line(colour = c(rep(c("black", NA), 10), "black")),
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin       = unit(c(1, 0.5, 0.5, 0.5), "cm")
        ) + 
      
    scale_fill_manual(
      values = c("grey70", "white"), 
      limits = df_area_ir[[.y]]$area, 
      labels = paste0(df_area_ir[[.y]]$area, ":")) + 
    
    # Edit legend 
    guides(
       fill = guide_legend(
                        title       = "", 
                        title.theme = element_text(size = 11.5, face = "bold"), title.hjust = 0,
                        label.theme = element_text(size = 12, lineheight = 1), label.hjust = 0)) +
      
    coord_cartesian(
      xlim = c(0, as.numeric( paste0(nrow(bar_df_ir[[1]]), ".1")) ), 
      ylim = c(0, 500), 
      clip = "off") +
    
    scale_x_discrete (expand = c(0, 0), breaks = .x$region, labels = .x$x_label) + 
    scale_y_continuous(
      expand = c(0, 0), 
      breaks = seq(0, 500, 100), 
      labels = list(seq(0, 500, 100), NULL)[[.y]]) + 
  
    geom_text(x          = c(3.95, 0.5)[.y], 
              y          = y_max - 70, 
              label      = paste0(df_area_ir[[.y]]$std_ci, collapse = "\n"),  
              size       = 4.1, 
              family     = font_style, 
              color      = "black", 
              hjust = 0) +
    
      
    # Panel title
    geom_text(x        = 10, 
              y        = y_max + 120, 
              size     = 5.5, 
              family   = font_style, 
              color    = "black", 
              hjust    = 0.5, 
              fontface = 2,
              label    = paste0(LETTERS[.y], ". ", outcome_title[.y])) +
      
    # Plot title
    geom_text(x        = -3, 
              y        = y_max + 50, 
              size     = 5.5, 
              family   = font_style, 
              color    = "black", 
              hjust    = 0, 
              fontface = 2,
              label    = c("Hospitalisation rate", "")[.y]) +
    
      # Y label 
    annotate("text", 
             x        = -2.2, 
             y        = 250, 
             label    = list(expression("Hospitalisation rate per 10"^5*" person-years"), "")[[.y]], 
             size     = 5, 
             fontface = 2, 
             angle    = 90, 
             family   = font_style, 
             color    = "black")  +
      
    ylab(NULL) +
  
    xlab(NULL) 

)   


```



# Survival after first diagnosis for HF and PHD

**Key Considerations**

-   Only participants with HF or PHD diagnosis from the inpatient and
    death registries will be considered for the analysis.
-   Outcome = death from any cause

**Note**

-   If participants from outpatients are not excluded, it would seem
    like survival in the regions providing these cases is better than
    the rest of the regions (because ofcourse these are chronic cases)

-   In addition, outpatient events were provided by a single sites and
    therefore has poor coverage.

-   Long term survival probabilities might balance with time but there
    is very likely to be huge discrepancies in 28 day mortality If
    outpatient events are not excluded


```{r Data manipulation: Survival HF and PHD}

#1. Defining follow-up time for HF 

merged_data <- merged_data %>% 
  
                  mutate(dob = ymd(dob_anon), 
                         
                         # Date of HF diagnosis 
                         date_hf_diag = ymd(HF_combined_datedeveloped),                                           
                         
                         #Age at diagnosis of HF 
                         age_hf = interval(dob, date_hf_diag) / dyears(1),
                         
                         # Date of PHD diagnosis
                         date_phd_diag = ymd(PHD_combined_datedeveloped), 
                         
                         #Age at diagnosis of PHD 
                         age_phd = interval(dob, date_phd_diag)/dyears(1), 
                         
                         #Age at censoring 
                         age_censor = interval(dob, censoring_date)/ddays(1),
                          
                         #Education (three groups)
                         edu3 = factor(ifelse(highest_education == 0, "None", 
                                       ifelse(highest_education == 1, "Primary", "Secondary or higher"))))


#2. Create separate data sets for inpatient HF and PHD 
 
data_hf <- merged_data %>% 
            filter(hf_inpatient == 1) %>%
  
            mutate(futime_day    = interval(date_hf_diag, censoring_date)/ddays(1),
                   futime_yr     = interval(date_hf_diag, censoring_date)/dyears(1), 
                   futime_age    = (age_censor - age_hf)/365,
                   
                   # fatal_event   = ifelse(HF_du_ep == 1 | HF_da_ep == 1, 1, 0),
                   
                   age_diag_10   = cut(age_hf, breaks = c(35, 50, 60, 70, 80, 100),  
                                               labels = c("30-49", "50-59", "60-69", "70-79", "80+")),
                   
                   age_diag65    = factor(ifelse(age_hf >= 65, "65 or over", "Below 65")),
                   
                   year_diag     = as.integer(substr(date_hf_diag, 1, 4)),
                   year_diag_cat = case_when(year_diag <= 2010 ~ "2010 or earlier", 
                                             year_diag > 2010 & year_diag <= 2012 ~ "2011-2012", 
                                             year_diag > 2012 & year_diag <= 2014 ~ "2013-2014", 
                                             year_diag > 2014 & year_diag <= 2016 ~ "2015-2016", 
                                             year_diag > 2016 ~ "2017+", 
                                             TRUE ~ NA_character_), 
                   n_combid_cat = factor(ifelse(n_comobid >= 2, "2+", n_comobid)),
                   outcome = "hf"  # Indicator of dataset
                   ) 

# Mean age at diagnosis 
mean(merged_data$age_hf); sd(merged_data$age_hf)

data_hf %>% dplyr::group_by(sex) %>% 
                   summarise (mean_age = mean(age_hf), sd_age = sd(age_hf))

              
data_phd <- merged_data %>% 
              filter(phd_inpatient == 1) %>% 
  
              mutate(futime_day    = interval(date_phd_diag, censoring_date)/ddays(1),
                     futime_yr     = interval(date_phd_diag, censoring_date)/dyears(1),
                     futime_age    = (age_censor - age_phd)/365,
                     
                     # fatal_event   = ifelse(PHD_du_ep == 1 | PHD_da_ep == 1, 1, 0),
                     
                     age_diag_10   = cut(age_phd,  
                                         breaks = c(35, 50, 60, 70, 80, 100),
                                         labels = c("30-49", "50-59", "60-69", "70-79", "80+")),
                     
                     age_diag65    = factor(ifelse(age_phd >= 65, "65 or over", "Below 65")),
                     
                     year_diag     = as.integer(substr(date_phd_diag, 1, 4)),
                     
                     year_diag_cat = case_when(year_diag <= 2010 ~ "2010 or earlier", 
                                               year_diag > 2010 & year_diag <= 2012 ~ "2011-2012", 
                                               year_diag > 2012 & year_diag <= 2014 ~ "2013-2014", 
                                               year_diag > 2014 & year_diag <= 2016 ~ "2015-2016", 
                                               year_diag > 2016 ~ "2017+", 
                                               TRUE ~ NA_character_), 
                     
                     n_combid_cat = factor(ifelse(n_comobid >= 2, "2+", n_comobid)),
                     
                     outcome = "phd")

mean(merged_data$age_phd); sd(merged_data$age_phd)

data_phd %>% dplyr::group_by(sex) %>% summarise (mean_age = mean(age_phd), sd_age = sd(age_phd))




# Define outcome for 28-day CFR--

data_hf %>% mutate(death_28 = ifelse(censoring_reason =="Dead" & futime_day <= 28,  1, 0)) -> data_hf        
data_phd %>% mutate(death_28 = ifelse(censoring_reason == "Dead" & futime_day <= 28, 1, 0)) -> data_phd      

# Define COPD (prevalent + incident COPD) and IHD (coronary or ischemic HD + MI)~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

data_phd <- 
  data_phd %>%
  mutate(
    
     incident_copd_PHD = ifelse(COPD_combined_ep == 1 & COPD_combined_datedeveloped <= PHD_combined_datedeveloped, 1, 0),
     develop_copd      = factor(ifelse(copd == "Yes" | incident_copd_PHD == 1, "Yes", "No"), levels = c("Yes", "No")),
    
     incident_MI_PHD   = ifelse(Acute_MI_combined_ep == 1 & Acute_MI_combined_datedeveloped <= PHD_combined_datedeveloped, 1, 0),
     incident_IHD_PHD  = ifelse(IHD_combined_ep == 1 & IHD_combined_datedeveloped <= PHD_combined_datedeveloped, 1, 0),
     
     develop_IHD  = factor(ifelse(chd == "Yes" | incident_MI_PHD == 1 | incident_IHD_PHD == 1, "Yes", "No"), 
                                levels = c("Yes", "No")),
    
     age_diag_merge    = fct_recode(age_diag_10, 
                                    "30-59" = "30-49", 
                                    "30-59" = "50-59", 
                                    "60-69" = "60-69", 
                                    "70-79" = "70-79", 
                                    "80+"   = "80+"), 
     
     all_death         = ifelse(censoring_reason == "Dead", 1, 0)
     
     )


data_hf <- 
  data_hf %>%
  mutate(
     incident_copd_HF = ifelse(COPD_combined_ep == 1 & COPD_combined_datedeveloped <= HF_combined_datedeveloped, 1, 0), 
     develop_copd     = factor(ifelse(copd == "Yes" | incident_copd_HF == 1, "Yes", "No"), levels = c("Yes", "No")),
                  
     incident_MI_HF   = ifelse(Acute_MI_combined_ep == 1 & Acute_MI_combined_datedeveloped <= HF_combined_datedeveloped, 1, 0), 
     incident_IHD_HF  = ifelse(IHD_combined_ep == 1 & IHD_combined_datedeveloped <= HF_combined_datedeveloped, 1, 0), 
     
     develop_IHD      = factor(ifelse(chd == "Yes" | 
                                      incident_MI_HF == 1 | 
                                      incident_IHD_HF == 1, "Yes", "No"), levels = c("Yes", "No")), 
  
     age_diag_merge   = fct_recode(age_diag_10, 
                                    "30-59" = "30-49", 
                                    "30-59" = "50-59", 
                                    "60-69" = "60-69", 
                                    "70-79" = "70-79", 
                                    "80+"   = "80+"), 
     
     all_death        = ifelse(censoring_reason == "Dead", 1, 0)
     )


```

**Note:** Incident disease was defined as those developed the disease of interest (e.g. MI) **on** 
          or before a first diagnosis for HF or PHD
          
          

# 28-day mortality

### Age-specific case-fatality ratio

Estimates of CFR and their respective CIs were round down so that the overall estimate (for example, for women)
should agree with the area-specific estimates.


```{r Age specific CFR by sex and area}

strata_var       <- "age_diag_merge"
adjust_var       <- c("sex", "area")
adjust_var_label <- c("Age at diagnosis", "sex", "area")
age_diag         <- list("age_hf", "age_phd")

dat              <- list(data_hf, data_phd)
outcome.name     <- list("hf", "phd")


# Age-specific CFRs --

df_cfr_age <- 
 
  map(.x = dat, 
      ~.x %>% 
        dplyr::group_by(sex, area) %>% 
        group_split() %>% 
        map(
           ~dplyr::group_by(.x, age_diag_merge) %>% 
            summarise(
              n_deaths   = sum(death_28),
              n_sample   = n(),
              prop_death = n_deaths/n_sample, 
              se_prop    = sqrt( (prop_death * (1 - prop_death)) / n_sample), 
              lci        = prop_death - 1.96*se_prop, 
              lci        = ifelse(lci < 0, 0.00005, lci),  # Replace -ve confidence intervals with very small + number
              uci        = prop_death + 1.96*se_prop, 
              prev100    = prop_death*100, 
              lci100     = lci*100, 
              uci100     = uci*100,
              mean_age   = mean(age_hf), 
              sex_group  = unique(as.character(.x$sex)), 
              area_group = paste0(unique(as.character(.x$area)), ":"), 
              outcome    = unique(outcome)
              )
            
          )
  
      )

df_age_men   <- map(.x = df_cfr_age, ~bind_rows(.x[1:2]))
df_age_women <- map(.x = df_cfr_age, ~bind_rows(.x[3:4]))
df_age_sim   <- map2(.x = df_age_men, .y = df_age_women, ~list(.x, .y)) %>% flatten()



# Area-specific CFR by sex -- 
# Split datasets per sex, then calculate the standardised area-specific CFR 

sex_level <- levels(data_hf$sex)

area_sex_list <- list()


for (df in seq_along(dat)) { # Loop over datasets -- 
  
  temp_list <- list() # Temporary list to hold sex-specific cfr
  
      for(s in sex_level) {
    
        data_temp <- dat[[df]] %>% filter(sex == s) # filter data by sex
                    
         adjusted_prop <- 
           
            adjprop(
              dataset                = data_temp,
              outcome_vars           = "death_28",
              categorical_vars       = "area", 
              categorical_var_labels = list(list("area",levels(data_temp[["area"]]))),
              adjustment_vars        = "age_diag_merge")    # Functions returns a dataframe 
  
          
          adjusted_prop <-  
            
            adjusted_prop %>% 
            
            dplyr::select(
              death_28.variable, 
              death_28.levels, 
              death_28.N.Freq, 
              death_28.proportion.1, 
              death_28.se.1) %>%

            dplyr::rename(
              "strata"     = death_28.variable, 
              "area_group"  = death_28.levels, 
              "n_deaths"   = death_28.N.Freq, 
              "prop_death" = death_28.proportion.1, 
              "se"         = death_28.se.1) %>% 

            dplyr::mutate(
              prev100 = prop_death*100, 
              lci100  = (prop_death - 1.96*se)*100,  
              uci100  = (prop_death + 1.96*se)*100, 
              prev_ci = paste0(round(prev100), " (", round(lci100), " - ", round(uci100), ")"), 
              outcome = unique(data_temp$outcome),
              area_group = paste0(area_group, ":"),
              sex     = s)  
          
         row.names(adjusted_prop) <- NULL
         
         # extract crude number of events for reporting 
          
         n_death_temp <-  data.frame(table(data_temp[["area"]], data_temp[["death_28"]])) 
         n_death_temp <-  pivot_wider(n_death_temp, values_from = Freq, names_from  = Var2) 
           
         colnames(n_death_temp) <- c("area", "alive", "death")
         
  
         adjusted_prop$crude_death <- n_death_temp$death
         adjusted_prop$crude_alive <- n_death_temp$alive
         adjusted_prop$outcome     <- outcome.name[[df]]
                  
           
       temp_list[[s]] <- adjusted_prop
       
      } 
      
   area_sex_list[[df]] <- temp_list
   
   data_temp <- NULL 
      
  } 

area_sex_sim <- 
  flatten(area_sex_list) %>% 
  map(~select(.x, area_group, prev_ci))



# Bind sex-area-specific datasets --
df_age_sim <- 
  
  map2(
    .x = df_age_sim, 
    .y = area_sex_sim, 
    ~left_join(.x %>% select(-c(2:7)), .y, by = "area_group") %>% 
      mutate(area_group = factor(area_group, levels = c("Rural:", "Urban:"))))


# Get standardised cfr for men and women -- 


sex_area_list <- list()


 for (df in seq_along(dat)) { # Loop over datasets -- 
   
    
      data_temp <- dat[[df]] 
      
      temp_list <- list()
      
      for(j in c("sex", "area")){
        
        grp_var <- j
        adj_vars <- c("age_diag_merge", 
                      c("sex", "area")[-which(c("sex", "area") == grp_var)])
                  
         adjusted_prop <- 
           
            adjprop(
              dataset                = data_temp,
              outcome_vars           = "death_28",
              categorical_vars       = grp_var, 
              categorical_var_labels = list(list(grp_var, levels(data_temp[[grp_var]]))),
              adjustment_vars        = adj_vars)    
  
          
          adjusted_prop <-  
            
            adjusted_prop %>% 

            dplyr::select(
              death_28.variable, 
              death_28.levels, 
              death_28.N.Freq, 
              death_28.proportion.1, 
              death_28.se.1) %>%

            dplyr::rename(
              "strata"     = death_28.variable, 
              "levels"     = death_28.levels, 
              "n_deaths"   = death_28.N.Freq, 
              "prop_death" = death_28.proportion.1, 
              "se"         = death_28.se.1) %>% 

            dplyr::mutate(
              prev100 = prop_death*100, 
              lci100  = (prop_death - 1.96*se)*100, 
              uci100  = (prop_death + 1.96*se)*100, 
              prev_ci = paste0(round(prev100), " (", round(lci100), " - ", round(uci100), ")"), 
              outcome = unique(data_temp$outcome))  
                          
         row.names(adjusted_prop) <- NULL
         
         # extract crude number of events for reporting 
         n_death_temp <-  data.frame(table(data_temp[[grp_var]], data_temp[[grp_var]])) 
         n_death_temp <-  pivot_wider(n_death_temp, values_from = Freq, names_from  = Var2) 
           
         colnames(n_death_temp) <- c(grp_var, "alive", "death")
         adjusted_prop$crude_death <- n_death_temp$death
         adjusted_prop$crude_alive <- n_death_temp$alive
           
      
   temp_list[[j]] <- adjusted_prop %>% select(levels, prev_ci, outcome)
   
   
      } 
      
   data_temp <- NULL    
   
   sex_area_list[[df]] <- temp_list

 }

# expand sex list to make it convenient for plotting 
# sex_sim <- map(.x = sex_list, ~group_by(.x, levels) %>% group_split()) %>% flatten()

```


## Plot Age-specific CFR (sex, area)

```{r Plot age-specific CFR}


plot_list <- 

  map2(
    .x = df_age_sim, 
    .y =seq_along(df_age_sim), 
    
    ~ ggplot(data = .x, aes(x = mean_age, y = prev100, group = area_group)) + 
          geom_line(linewidth = 0.7, aes(linetype = area_group)) + 
          geom_point(shape = 15, size = 1.5) + 
          geom_errorbar(aes(x = mean_age, 
                            y = prev100, 
                            ymin = lci100, 
                            ymax = uci100, 
                            linetype = area_group), width = 0.5, linewidth = 0.6) + 
  
    # Get theme  
      theme_void() +
      theme(axis.text.x  = element_text(size   = 13, vjust = 5),
            axis.text.y  = element_text(size   = 13, hjust = 1), 
            axis.title.x = element_text(size   = 13, vjust = -1), 
            axis.title.y = element_text(size   = 14, angle = 90)) +
      
    # Use geom_seqment to draw axes that do not touch
      geom_segment(mapping = aes(x = 48, xend = 48, y = 0, yend = 100),linewidth = 0.7) + 
      geom_segment(mapping = aes(x = 50, xend = 90, y = -5, yend = -5), linewidth = 0.7) +
    
      theme(axis.ticks        = element_line(linewidth = 0.6),
            axis.ticks.length = unit(0.25, "cm"), 
            plot.margin       = unit(c(2, 0.5, 1, 0.5), "cm"),
            legend.position   = list(c(0.2, 0.9), "none", c(0.2, 0.9), "none")[[.y]]
            ) + 
     
      # Edit legend 
      
      guides(
         linetype = guide_legend(
                          title       = "", 
                          title.theme = element_text(size = 11.5, face = "bold"), title.hjust = 0,
                          label.theme = element_text(size = 11.5, lineheight = 0.9), label.hjust = 0)
                ) + 
        
      
     # Axes 
      coord_cartesian(xlim = c(48, 90.01), ylim = c(0, 100), clip = "off") +
              
      scale_x_continuous(expand = c(0, 0), 
                         limits = c(48, 90),
                         breaks = seq(50, 90, 10), 
                         labels = paste0("\n", seq(50, 90, 10))) +
      
      scale_y_continuous(expand =  c(0.05, 0), 
                         breaks =  seq(0, 100, 20), 
                         labels =  seq(0, 100, 20)) + 
       
      
     # Adding labels for SIR
      # geom_text(x      = 50, 
      #           y      = 90,
      #           size   = 4,  
      #           color  = "black", 
      #           hjust  = 0,
      #           lineheight = 1,
      #           label  = paste0(
      #                      paste0("Overall, ", unique(area_sex_sim[[.y]]$sex), "\n"), 
      #                      paste0(area_sex_sim[[.y]]$levels, collapse = "\n")
      #                      )
      #           ) +
    
      # Figures for SIR
      geom_text(x      = rep(c(63, 50), 2)[.y],
                y      = 90.5,
                label  = paste0(# Necessary to capture all prev_ci labels --
                           group_split(group_by(.x, area_group)) %>% 
                            map_chr(
                                ~unique(.x$prev_ci)), collapse = "\n"),
                size   = 3.9,
                lineheight = 1.3,
                color  = "black",
                hjust  = 0) +
      
      # Panel title 
      geom_text(x      = 47, 
                y      = 108, 
                label  = paste0(LETTERS[.y], ". ", sex_sim[[.y]]$levels), 
                size   = 4, 
                color  = "black", 
                fontface = 2, 
                hjust  = 0) + 
      
      # Plot title
      geom_text(x        = c(35, 35, 38, 38)[.y], 
                y        = 120, 
                label    = c("Heart failure", "", "Pulmonary heart disease", "")[.y], 
                size     = 5, 
                color    = "black", 
                hjust    = 0, 
                fontface = 2) +
    
      ylab(rep(c("28-day case-fatality ratio, % (95% CI)", " "), 2)[.y]) +
      xlab( c("", "", "Age at diagnosis (years)", "Age at diagnosis (years)")[.y] )

  
 ) 
 

## Export plot 
plot <- ggarrange (plotlist = plot_list, 
                   ncol     = 2,
                   nrow     = 2,
                   widths   = rep(1, 4), 
                   heights  = rep(1.5,4))
   
 
ckbplotr::save_figure(
   plot, 
   ext = c("png", "png"),
   pagesize    = c("A4"),
   # pagedim = unit(c(3, 7.5), "in"),
   margin  = unit(c(0.1, 1.1, 0.5, 0.8), units = "cm"),
   landscape = FALSE, 
   cropped = TRUE,
   name = paste0(Sys.Date(), "_", "Figure 2. Age-specific CFR by sex and area"),  
   title = "",
   args = list(bg = "white",pointsize = 1),
   args_cropped = list(bg = "white",pointsize = 1)
 )      
  


```


## Overall CFR 
- Calculate age-specific CFR adjusted for sex and area
- Combine the results in a FEMA to account for heterogeneity by age

```{r Age-specific prevalence adjusted by sex and area}

strata_var       <- "age_diag_merge"
adjust_var       <- c("sex", "area")
adjust_var_label <- c("Age at diagnosis", "sex", "area")
age_diag         <- list("age_hf", "age_phd")

dat              <- list(data_hf, data_phd)
outcome.name     <- list("hf", "phd")




df_list_adjprop <- vector(mode = "list", length = length(dat))



for (df in seq_along(dat)) {

  data_temp <- dat[[df]]
                
       adjusted_prop <- adjprop(dataset                = data_temp,
                                outcome_vars           = "death_28",
                                categorical_vars       = strata_var, 
                                categorical_var_labels = list(list(strata_var,levels(data_temp[ ,strata_var]))),
                                adjustment_vars        = adjust_var)    # Functions returns a dataframe 

        
        adjusted_prop <-  adjusted_prop %>% 
          
                          dplyr::select(death_28.variable, 
                                        death_28.levels, 
                                        death_28.N.Freq, 
                                        death_28.proportion.1, 
                                        death_28.se.1) %>%
    
                          dplyr::rename("strata"     = death_28.variable, 
                                        "levels"     = death_28.levels, 
                                        "n_deaths"   = death_28.N.Freq, 
                                        "prop_death" = death_28.proportion.1, 
                                        "se"         = death_28.se.1) %>% 
    
                          dplyr::mutate(prev100 = round(prop_death*100, 2), 
                                        ll_ci   = round((prop_death - 1.96*se)*100, 2), 
                                        ul_ci   = round((prop_death + 1.96*se)*100, 2),
                                        prev_ci = paste0(prev100, " (", ll_ci, " - ", ul_ci, "), %")
                                        )  
                        
       row.names(adjusted_prop) <- NULL
       
       # extract crude number of events for reporting 
        
       n_death_temp <-  data.frame(table(data_temp[ ,strata_var],
                                         data_temp[ , "death_28"])) 
           
       n_death_temp <-  pivot_wider(n_death_temp, values_from = Freq, names_from  = Var2) 
         
       colnames(n_death_temp) <- c(strata_var, "alive", "death")
       

       adjusted_prop$crude_death <- n_death_temp$death
       adjusted_prop$crude_alive <- n_death_temp$alive
       adjusted_prop$outcome     <- outcome.name[[df]]
              
       
df_list_adjprop[[df]] <- adjusted_prop
                            
} 

 # Bind mean age to datasets 

df_list_adjprop <- map2(
  
  .x = df_list_adjprop, .y = 1:2, 
  ~dplyr::mutate(
             .x, 
             mean_age = dat[[.y]] %>% 
                         dplyr::group_by(age_diag_merge) %>% 
                         dplyr::summarise(mean_age = mean(.data[[ age_diag[[.y]] ]])) %>%  
                         pull(mean_age))
  ) 
  

## Calculate standardised incidence rate 

std_ma  <- map(.x = df_list_adjprop, ~rma(yi=prop_death, vi=se^2, method = "FE", data = .x)) %>%
           map( ~ tibble(b   = .x$b[1,1],
                         lci = .x$ci.lb,
                         uci = .x$ci.ub,
                         bci = paste0(round(b*100), " (", round(lci*100), " - ", round(uci*100), "), %"))
                )
      
std_cfr <- map(.x = std_ma, ~.x$bci)

```



### SUBGROUPS

**CHD and IHD:** Prevalent CHD and incident IHD
**COPD:** Prevalent and incident COPD

```{r}

adjust_var       <- c("age_diag65", "sex", "area")
adjust_var_label <- c("Age at diagnosis", "sex", "area")

strata_var       <- c("edu3", "HTN", "diabetes", "develop_IHD", 
                      "stroke_tia", "develop_copd", "co_hf_phd", "n_combid_cat")

group_labels     <- list(
                      "Trend" = "Level of education", 
                      "Heterogeneity" = "Hypertension", 
                      "Heterogeneity" = "Diabetes", 
                      "Heterogeneity" = "CHD or IHD", 
                      "Heterogeneity" = "Stroke or TIA", 
                      "Heterogeneity" = "COPD",
                      "Heterogeneity" = "HF and PHD co-occurence", 
                      "Trend" = "Number of comorbidities")


outcome_col_name <- "death_28"
dat              <- list(data_hf, data_phd)
data_label       <- c("hf", "phd")


#Create a list to hold individual data frames
df_subgroup_temp <- vector(mode = "list")
df_subgroup_list <- vector(mode = "list")
trend_het_cfr    <- vector(mode = "list")


for (df in seq_along(dat)) {

   # extract crude number of events for reporting --
   n_death_temp <- 
     
     map(
       .x = strata_var, 
       ~dat[[df]] %>% 
          dplyr::group_by(across(all_of(c(.x, outcome_col_name)))) %>% 
              summarise(n = n(), .groups = "keep") %>% 
              pivot_wider(
                ., 
                values_from = n, 
                names_from = all_of(outcome_col_name)) %>% 
              `colnames<-`(c(.x, "alive", "death"))
                      
       )
     
   # Standardised proportion --
   df_subgroup_temp[[df]] <-  
     
     map2(
        .x = strata_var, 
        .y = seq_along (strata_var),
         ~adjprop(dataset             = dat[[df]],
                  outcome_vars        = outcome_col_name,
                  categorical_vars    = .x,
                  adjustment_vars     = adjust_var) %>% 
           
         dplyr::transmute(test_type  = names(group_labels[.y]),
                          strata     = group_labels[[.y]], 
                          levels     = death_28.levels, 
                          n          = death_28.N.Freq, 
                          prop_death = death_28.proportion.1, 
                          se         = death_28.se.1,
                          prev100    = format(round(prop_death*100, 2)),
                          LCI      = format(round((prop_death - 1.96*se)*100, 2)), 
                          UCI      = format(round((prop_death + 1.96*se)*100, 2)),
                          prev_ci    = paste0(prev100, "%", " (", LCI, " - ", UCI, ")")) %>% 
         `row.names<-`(NULL)
       ) %>% 
  
    map2(.y = n_death_temp, 
         ~dplyr::mutate(.x, 
                        crude_death = .y$death, 
                        alive = .y$alive, 
                        death_N = paste0(crude_death, " / ", n) )) 
  
    
   # Perform test for heterogeneity --
   trend_het_cfr[[df]] <- 
    
    map(
      .x = df_subgroup_temp[[df]], 
      ~if(unique(.x$test_type) == "Trend"){trend(.x$prop_death, .x$se) 
      }else{heterogeneity(.x$prop_death, .x$se)}
    ) 
   
   
   # Join heterogeneity dataset to the main data --
   df_subgroup_list[[df]] <-
    
    map2_dfr(
      .x = df_subgroup_temp[[df]], 
      .y = trend_het_cfr[[df]], 
      
      ~mutate(
          .x, 
          df   = c(rep(NA, nrow(.)-1), .y$df), 
          chi2 = c(rep(NA, nrow(.)-1), round(.y$`test statistic`, 1)), 
          p    = ifelse(.y$p < 0.0001, "<0.0001", as.character(round(.y$p, 4))),
          p    = ifelse(is.na(df), NA, p)
        )
    ) 
   
   
   }



```



### SUBGROUP: Merge datasets 

```{r merging data for other subgroups}



# Add heading to levels 

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/add_table_header.R")

subgroup_cfr_df <- 
  
  map(
    .x = df_subgroup_list, 
    ~add_table_header(
        data            = .x, 
        group_var       = strata, 
        group_level_var = levels, 
        extra_space     = TRUE) %>%
      
    dplyr::mutate(
       Het        = ifelse(!is.na(df) & test_type == "Heterogeneity", paste(df, chi2, p, sep = ","), NA), 
       Trend      = ifelse(!is.na(df) & test_type == "Trend", paste(df, chi2, p, sep = ","), NA), 
       IsDiamond  = ifelse(!is.na(prev100), 0, prev100), 
       FillColour = ifelse(!is.na(prev100), 1, prev100)) %>% 
    
    select(levels, death_N, prev100, LCI, UCI, Het:FillColour) 
     
    )

# Add all 
n_death <- map(.x = dat, ~ sum(.x$death_28))
n_total <- map(.x = dat, ~nrow(.x))
death_N <- map2(.x = n_death, .y = n_total, ~paste0(.x, " / ", .y))


all_cfr <- map2(.x = std_ma, 
                .y = seq_along(dat), 
                
                ~transmute(
                  .x, 
                  levels       = "All",
                  death_N      = death_N[[.y]],
                  prev100      = b*100, 
                  LCI          = lci*100, 
                  UCI          = uci*100,
                  Het          = NA_character_, 
                  Trend        = NA_character_,
                  IsDiamond    = 1, 
                  FillColour   = 0) %>% 
                  
                add_row(.before = 1))


## Bind datasets 

subgroup_df <- 
  
  map2(
    .x = subgroup_cfr_df, 
    .y = all_cfr, 
    ~rbind(.x, .y) %>% 
      dplyr::mutate(across(.cols = c(prev100:UCI, IsDiamond, FillColour), ~as.numeric(.))))


# write.csv(subgroup_df[[1]], file = "cfr_hf.csv")
# write.csv(subgroup_df[[2]], file = "cfr_phd.csv")
subgroup_df 

```


```{r Plotting standardised 28-day CFR}

# read in the raw data
rawdata   <- 
  
  map2(
    .x = subgroup_df, 
    .y = seq_along(subgroup_df),
     ~rename(
       .x, 
       "Heading" = levels, 
       !!paste0("Het", .y) := Het,  
       !!paste0("Trend", .y) := Trend,   
       !!paste0("IsDiamond", .y) := IsDiamond, 
       !!paste0("FillColour", .y) := FillColour) %>% 
       # dplyr::mutate(Heading = ifelse(is.na(Heading), "", Heading)) %>% 
       as.data.frame(.)
                 
    )

lab_plot  <- "Figure S3: Standardised 28-day case-fatality ratio for heart failure and pulmonary heart disease\nby subgroup"

  
# set up an object that stores the forest and associated metadata

forest.hf <- FormatForest(rawdata     = rawdata[[1]], 
                          forest.n    = 1, 
                          EstimateCol = "prev100", 
                          LCICol      = "LCI", 
                          UCICol      = "UCI", 
                          logData     = FALSE, 
                          getBlanks   = TRUE, 
                          getHets     = TRUE, 
                          getTrends   = TRUE)

# Forest object of PHD (panel 2)
forest.phd <- FormatForest(rawdata      = rawdata[[2]] %>% select(-1), 
                            forest.n    = 2, 
                            EstimateCol = "prev100", 
                            LCICol      = "LCI", 
                            UCICol      = "UCI", 
                            logData     = FALSE, 
                            getBlanks   = TRUE, 
                            getHets     = TRUE, 
                            getTrends   = TRUE)

blank.rows <- forest.hf$blank.rows 

 

# find labels to put in the left most column
left.labels <- convertUnicode(as.character(rawdata[[1]]$Heading))
other.cols  <- "death_N"

# find column headings
print.headings <- parseColHeadings(rawdata[[1]]$ColHeadings, rd=rawdata[[1]])


##################################################################################

# set up the Jasper page
type <- "JPG"

SetPage(orient="PORTRAIT", 
        perpage=1, 
        type=type, 
        filestem = "Fig S3 CFR_subgroup", 
        page_dpi = 600,
        page_pointsize = 9,
        page_height = 13,
        page_width  = 11,
        append_datetime=FALSE, 
        suppress.date=TRUE, 
        titlespace=0.05, 
        footerspace     = 0.05, 
        footer.cex      = 1.7, 
        footer    = "Case-fatality ratios (CFRs) were directly standardised by age at diagnosis, sex and area (Urban and rural)\nCOPD = Chronic obstructive pulmonary disease, CHD = Prevalent coronary heart disease, IHD = incident ischaemic heart disease,\nTIA = Transient ischaemic attack, Het = Heterogeneity
        \n \n")

# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 8.14537797266251, 2))

mainfont <- 1.2
blankPlot(c(0,100), c(0,100), mainfont)
par(xpd=NA)

spacing <- 0.9
plot.width <- 15

x_label <- "28-day case-fatality\nratio(%)"

# draw the Forest plot(s)
xaxmin1 <- 25.2542
xaxmax1 <- xaxmin1 + plot.width
locs <- ForestBasic(forest.hf,
                  	LogScale=FALSE,
                  	ExponentiateDataOnPlot=FALSE,
                  	xaxmin=xaxmin1,
                  	xaxmax=xaxmax1,
                  	xlim=c(-5, 40),
                  	xticks=seq(0, 40, 20),
                  	ticklabs=seq(0, 40, 20),
                  	xlab= x_label,
                  	NLabel=FALSE,
                  	mainfont=1,
                  	ValueLabels=TRUE,
                  	ValueLabelsHeader="CFR (95% CI)",
                  	ValueDigits=0,
                  	lwd=1,
                  	separator = " - ",
                  	CISecond=TRUE,
                  	# spacing=spacing/2,
                  	pointGroupsFactor=1,
                  	verbose=FALSE,
                  	boxsizeoverride=FALSE,
                  	boxparm.stderr = 0.7)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x=xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
     y=107.5, 
     labels="Heart Failure", 
     adj=c(0.5,0), 
     font=2, 
     cex = 1.3)

text(x=xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2,
     y=104,
     labels=paste("(N=", nrow(data_hf), ")", sep = ""),
     adj=c(0.5,0),
     font=1,
     cex = 1.2)


# draw the Forest plot(s)
xaxmin2 <- 70.0592
xaxmax2 <- xaxmin2 + plot.width
locs2 <- ForestBasic(forest.phd,
                    	LogScale=FALSE,
                    	ExponentiateDataOnPlot=FALSE,
                    	xaxmin=xaxmin2,
                    	xaxmax=xaxmax2,
                    	xlim=c(-5, 80),
                    	xticks=seq(0, 80, 20),
                    	ticklabs=seq(0, 80, 20),
                    	xlab= x_label,
                    	NLabel=FALSE,
                    	mainfont=1,
                    	ValueLabels=TRUE,
                    	ValueLabelsHeader="CFR (95% CI)",
                    	ValueDigits=0,
                    	lwd=1,
                    	separator = " - ",
                    	CISecond=TRUE,
                    	spacing=spacing/2,
                    	pointGroupsFactor=1,
                    	verbose=FALSE,
                    	boxsizeoverride=FALSE,
            	        boxparm.stderr = 0.4)

# add titles above forest 
text(x=xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2,
     y=107.5,
     labels="Pulmonary heart disease",
     adj=c(0.5,0),
     font=2,
     cex = 1.3)

segments(x0 = 0,  y0 = 98, x1 = 100, y1=98, lwd = 1)

text(x=xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2,
     y=104,
     labels=paste("(N=", nrow(data_phd), ")", sep = ""),
     adj=c(0.5,0),
     font=1,
     cex = 1.2)

# left hand column of labels
text(x=0, y=100, labels="Strata",
     adj=c(0,0), font=2, cex=1)

text(x=0, y=locs$YLocs,
     adj=0, cex=1,
     labels=left.labels[-blank.rows], font=ifelse(forest.hf$IsDiamond, 2,1))

text(x=0, y=locs$BlankLocs,
     labels=left.labels[blank.rows], adj=0, font=2, cex=1)


### adding other columns  ####

# Death 1
column1.xpos <- xaxmin1 - 1
text(x=column1.xpos, y=100, labels=convertUnicode("Death(n)/Total"), adj=c(1,0), font=2, cex=1)

text(x      = column1.xpos, 
     y      = locs$YLocs, 
     labels = convertUnicode(as.character(rawdata[[1]][,other.cols[1]]))[-blank.rows], 
     font   = ifelse(forest.hf$IsDiamond, 2, 1), adj=1, cex=1)

text(x=column1.xpos, 
     y=locs$BlankLocs, 
     labels=convertUnicode(as.character(rawdata[[1]][,other.cols[1]]))[blank.rows], adj=1, cex=1)




# Death 2 (For PHD)
column3.xpos <- xaxmin2 - 1

text(x      = column3.xpos, 
     y      = 100, 
     labels = convertUnicode("Death(n)/Total"), adj=c(1,0), font=2, cex=1)

text(x      = column3.xpos, 
     y      = locs2$YLocs, 
     labels = convertUnicode(as.character(rawdata[[2]][,other.cols[1]]))[-blank.rows], 
     font   = ifelse(forest.phd$IsDiamond, 2, 1), adj=1, cex=1)

text(x      = column3.xpos, 
     y      = locs2$BlankLocs, 
     labels = convertUnicode(as.character(rawdata[[2]][,other.cols[1]]))[blank.rows], adj=1, cex=1)



# Add heterogeneity labels -- 

# Heterogeneity labels 
x_coord <- list("hf"  = 41.8003646765421, 
                "phd" = 86.6423204683451)

# Number of trend and het tests 
chi_p_df <- map(.x = df_subgroup_list, ~filter(.x, !is.na(df)) %>% select(test_type, df:p))

n_trend_test   <- map(.x = chi_p_df, ~nrow(filter(.x, test_type == "Trend")))
n_het_test     <- map(.x = chi_p_df, ~nrow(filter(.x, test_type == "Heterogeneity")))


index = 1
# Labels for HF ---
# Heterogeneity labels for HF

for (H in seq_len(n_het_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$df[H]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$chi2[H]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$p[H]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# Trend labels for HF

for (TT in seq_len(n_trend_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$df[TT]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$chi2[TT]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$p[TT]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[TT], 
       adj    = 0, 
       cex    = 0.8,   
       labels = bquote(Trend: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# Labels for PHD ---

# Heterogeneity labels for PHD

index = 2

for (H in seq_len(n_het_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$df[H]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$chi2[H]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$p[H]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# Trend labels for HF

for (TT in seq_len(n_trend_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$df[TT]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$chi2[TT]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$p[TT]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[TT], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Trend: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}




##Plot title
text(x=50.5,
     y= 113,
     font=2,
     cex = 1.4,
     adj=c(0.5, 0),
     col="black",
     labels=lab_plot)

# stop writing to file
closeFile(type)

```


### Region Subgroup 

```{r Region-sepcific CFR}

adjust_var       <- c("age_diag65", "sex")
adjust_var_label <- c("age_diag65", "sex")
strata_var       <- c("region", "area")
group_labels     <- list("region", "Area")

outcome_col_name <- "death_28"
dat              <- list(data_hf, data_phd)
data_label       <- c("hf", "phd")


#Create a list to hold individual data frames

temp_list <- vector(mode = "list", length = length(strata_var))
df_region_cfr <- vector(mode = "list", length = length(dat)) 


for (df in seq_along(dat)) {

  data_temp <- dat[[df]] 
  
     for (v in seq_along(strata_var)) { 
              
                
              temp_list[[v]] <- adjprop(dataset = data_temp,
                                      outcome_vars = outcome_col_name,
                                      categorical_vars = strata_var[v], 
                                      categorical_var_labels = list(list(strata_var[v], levels(data_hf[ ,strata_var[v]]))),
                                      adjustment_vars = adjust_var, 
                                      adjustment_var_labels = adjust_var_label) 
              
              temp_list[[v]] <- temp_list[[v]] %>% 
                
                                      dplyr::select(death_28.variable, 
                                                    death_28.levels, 
                                                    death_28.N.Freq, 
                                                    death_28.proportion.1, 
                                                    death_28.se.1
                                                    ) %>%
                
                                      dplyr::rename("strata" = death_28.variable, 
                                                    "levels" = death_28.levels, 
                                                    "n_deaths" = death_28.N.Freq, 
                                                    "prop_death" = death_28.proportion.1, 
                                                    "se" = death_28.se.1
                                                    ) %>% 
                
                                      dplyr::mutate(strata  = group_labels[[v]],
                                                    prev100 = round(prop_death*100, 2), 
                                                    ll_ci   = round((prop_death - 1.96*se)*100, 2), 
                                                    ul_ci   = round((prop_death + 1.96*se)*100, 2),
                                                    prev_ci = paste0(prev100, "%", " (", ll_ci, " - ", ul_ci, ")")
                                                    )  
                                    
              row.names(temp_list[[v]]) <- NULL
              
              # extract crude number of events for reporting ........................................................................
              
               n_death_temp <-  data.frame(table(data_temp[ ,strata_var[v]], data_temp[ ,outcome_col_name])) 
               n_death_temp  <-  pivot_wider(n_death_temp, values_from = Freq, names_from = Var2) 
               colnames(n_death_temp) <- c(strata_var[v], "alive", "death")
                                

               # Bind crude number of events to the standardised dataset .............................................................
               temp_list[[v]]$crude_death <- n_death_temp$death
               temp_list[[v]]$crude_alive <- n_death_temp$alive

              } 
       
df_region_cfr[[df]] <- bind_rows(temp_list)
                            
}

names(df_region_cfr) <- data_label


# Wrangle AREA data  
df_area_cfr <- map(.x = df_region_cfr, 
                   ~filter(.x, strata == "Area") %>%  
                    select(levels, prev100:ul_ci) %>% 
                    mutate(
                      Area = levels, 
                      prev_ci = paste0(round(prev100), " (", round(ll_ci), " - ", round(ul_ci), ")")) %>% 
                    arrange(Area))  

# Wrangle URBAN data 

 urban_region <- merged_data %>% 
                     filter(area == "Urban") %>% 
                     pull(region) %>% 
                     as.character(.) %>% 
                     unique(.)

 
 df_bar.cfr <- 
   
   map(.x = df_region_cfr, 
       ~filter(.x, strata != "Area") %>% 
        select(levels, prev100:ul_ci) %>% 
        mutate(Area = factor(case_when(levels %in% urban_region ~ "Urban", TRUE ~ "Rural"))) %>% 
        arrange(prev100)) %>% 
    
   # Make barplot data
   map( ~barplot_data(dataset = .x, region_var = "levels")) 


```


```{r Plotting 28-day mortality by region}

# Create barplot 
outcome_title  <- c("C. Heart failure", "D. Pulmonary heart disease")
lab_eventr     <- list("28-day CFR", "")
font_style     <- ""

n_groups <- map_dbl(.x = df_bar.cfr, ~filter(.x, !is.na(Area)) %>% nrow(.))

x_region_text  = 0.5
x_region_title = 7.5
y_max          = 100


barplot_region_cfr <- map2( 
  
  .x = df_bar.cfr,
  .y = seq_along(df_bar.cfr),
  
  ~ggplot(data = .x) +
    
    geom_col(
      aes(x = levels, y = prev100, fill = Area), 
      colour = "black", 
      alpha = 1, 
      width = 1) +
    
    geom_errorbar(
      aes(x = levels, y = prev100, ymin = ll_ci, ymax = ul_ci), 
      width = 0.3, 
      linewidth = 0.5) +
    
    geom_text(
      
      aes(x = levels, y = ul_ci, label = round(prev100)),
      size   = 4,
      vjust  = -0.5,
      color  = "black", 
      fontface = 2,
      hjust  = 0.5) +
          
    #Setting theme  
    theme_void() +
    
    #Theme text 
    theme(
        text              = element_text(family = font_style),
        axis.text.x       = element_text(size = 12, vjust =  0.5, hjust =  1, angle = 90),
        axis.text.y       = element_text(size = 12, hjust = 1), 
        axis.title.x      = element_text(size = 14,   vjust = -1), 
        axis.title.y      = element_text(size = 14,   angle = 90)) +
  
    theme(
        legend.position   = "none",
        axis.line         = element_line(colour = "black", linewidth = 0.6, linetype = "solid"), 
        axis.ticks        = element_line(linewidth = 0.6),
        axis.ticks.x      = element_line(colour = c(rep(c("black", NA), n_groups[.y]), "black")),
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin       = unit(c(1, 0.5, 0.5, 0.5), "cm")
        ) +                
  
    guides(
        fill = guide_legend(
                      title       = "", 
                      title.theme = element_text(size = 11.5, face = "bold"), title.hjust = 0,  
                      label.theme = element_text(size = 12, lineheight = 1), label.hjust = 0)) +
    
    scale_fill_manual(
      values = c("grey70", "white"), 
      limits = df_area_cfr[[.y]]$levels
      ) +
    
    coord_cartesian (
      xlim = c(0,  as.numeric( paste0(nrow(.x), ".1") )), 
      ylim = c(0, 100), 
      clip = "off") +
    
    scale_x_discrete (expand = c(0, 0), breaks = .x$levels, labels = .x$x_label) + 
    scale_y_continuous (
      expand = c(0, 0), 
      breaks = seq(0, 100, 20), 
      labels = list(seq(0, 100, 20), NULL)[[.y]]) + 
    
    # Add prevalence 
    geom_text(x      = 0.5,  
              y      = 89, 
              label  = paste0(df_area_cfr[[.y]]$prev_ci, collapse = "\n"),  
              size   = 4.1,  
              color  = "black", 
              hjust  = 0) +
    
    #  title
    geom_text(x      = -3, 
              y      = y_max + 10, 
              size   = 5.5, 
              family = font_style, 
              color  = "black", 
              hjust  = 0, fontface = 2,
              label  = c("28-day case-fatality", "")[.y]) +
  
    ylab(c("Case-fatality ratio, % (95% CI)", "")[.y]) +
    xlab("") 

)




```




# CUMULATIVE mortality after diagnosis of HF and HF

**Note:** Tried expanding the follow-up by age-at-risk by the function excluded too 
  many rows with short term follow up 


```{r Mortality after HF and PHD (ALL)}

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/my_ipw_fn.R")


dat          <- list(data_hf, data_phd)
fu.time      <- "futime_yr"
outcome      <- "all_death"
disease.name <- c("heart failure", "phd")

surv_all_df_list <- list(length = length(disease.name))
surv_0_9_df_list <- list(length = length(disease.name))


 
for (i in seq_along(disease.name)) {
  
  form1 <- as.formula(paste(sprintf("%s","Surv ("), fu.time, ",", outcome, ") ~","1", collapse=" "))
  
  surv_obj_temp  <- survfit(form1, data = dat[[i]])
  surv_summ_temp <- summary(surv_obj_temp)                                        
  surv_0_9_temp  <- summary(surv_obj_temp, times = c(0:9))
  
  
  #Create a dataframe from the survival objects
    
          #Including all survival times 
          surv_summ_temp_df <- data.frame(cbind(time      = surv_summ_temp$time, 
                                                n.risk    = surv_summ_temp$n.risk, 
                                                n.event   = surv_summ_temp$n.event, 
                                                n.censor  = surv_summ_temp$n.censor, 
                                                survival  = surv_summ_temp$surv, 
                                                std.err   = surv_summ_temp$std.err, 
                                                uci       = as.numeric(1 - surv_summ_temp$lower), 
                                                lci       = as.numeric(1 - surv_summ_temp$upper),
                                                cum_death = as.numeric(1 - surv_summ_temp$surv), 
                                                disease   = disease.name[[i]]))
          
        
          #Including specific times points (0:9)
          surv_0_9_temp_df <- data.frame(cbind(time      = surv_0_9_temp$time, 
                                               n.risk    = surv_0_9_temp$n.risk, 
                                               n.event   = surv_0_9_temp$n.event, 
                                               n.censor  = surv_0_9_temp$n.censor, 
                                               survival  = surv_0_9_temp$surv, 
                                               std.err   = surv_0_9_temp$std.err, 
                                               uci       = as.numeric(1 - surv_0_9_temp$lower), 
                                               lci       = as.numeric(1 - surv_0_9_temp$upper),
                                               cum_death = as.numeric(1 - surv_0_9_temp$surv),
                                               disease   = disease.name[[i]]))  


          #Store the resulting dataframes in a list
          surv_all_df_list[[i]] <- surv_summ_temp_df
          surv_0_9_df_list[[i]] <- surv_0_9_temp_df
          
}  
   
# Combind dataframes for HF and PHD 

    #All FU time 
surv_all_df_all <-  map(.x = surv_all_df_list, ~dplyr::mutate(.x, across(.cols = time:cum_death,~as.numeric(.x))))

    #0-9 years
surv_0_9_df_all <-  map(.x = surv_0_9_df_list, 
                        ~dplyr::mutate(
                          .x, 
                          across(.cols = time:cum_death, ~as.numeric(.x)), 
                          cum_death_95ci =  paste0(round((cum_death)*100), " (", round((lci)*100), " - ", round((uci)*100), "), %"))
                        )
  

# transpose dataset for reporting in table 

surv_0_9_df_transp <- list()


for (i in 1:2){
  
 surv_0_9_df_transp[[i]] <- surv_0_9_df_all[[i]] %>% t() %>% as.data.frame()
 colnames(surv_0_9_df_transp[[i]]) <- paste(c(0:(nrow(surv_0_9_df_all[[1]])-1)), "years") 

# write.csv(surv_0_9_df_transp[[i]], paste0("mortality_overall_all_death", i, ".csv"))               
}     



## Plotting overall cumulative mortality======
 
# Labels 
font_style <- ""

x_risk_title  = -2.8
y_risk_title  = -0.13
x_event_text  = 0.2

n_risk_lab <- c("HF:", "PHD:")
plot.title <- c("A. Heart failure\n", "B. Pulmonary heart disease\n")
y_label    <- c("Cumulative mortality risk (95% CI), %", "")


#Datasets
lab_risk <- map(
             .x = surv_0_9_df_all, 
              ~dplyr::mutate(.x, risk_censor = paste0(n.risk, "\n", n.censor)) %>%
               dplyr::select(time, risk_censor, disease))

surv_df_1_9 <- map(.x = surv_0_9_df_all, ~filter(.x, time > 0 & time <= 9)) 
surv_all_df <- map(.x = surv_all_df_all, ~filter(.x, time < 9.1))

# Get labels for overall five-year risk 
df_5year <- map(.x = surv_0_9_df_all,  ~filter(.x, time == 5) %>% pull(cum_death_95ci))


# Plot ---
plot_list_cmr <- 
  
  map2(
    .x = surv_all_df, 
    .y = seq_along(surv_all_df), 
    
    ~ggplot(data = .x, aes (x = time,  y=cum_death)) +
      
      geom_step(linewidth = 0.7) +
      
      geom_point(
        aes(x = time, y = cum_death), 
        shape = 15, 
        size = 1, 
        data = surv_df_1_9[[.y]])  +
      
      geom_errorbar(
        aes(x = time, y = cum_death, ymin = lci,ymax = uci),
        width = 0.1, 
        linewidth = 0.7, 
        data = surv_df_1_9[[.y]]) +
  
  #Setting theme 
  theme_void() + 
  
  #Theme text 
  theme(text         = element_text(family = font_style),
        axis.text.x  = element_text(size = 13, vjust = 0),
        axis.text.y  = element_text(size = 13, hjust = 1), 
        axis.title.x = element_text(size = 14, vjust = -1), 
        axis.title.y = element_text(size = 14, angle = 90)) +

  theme(legend.position   = "none",  
        axis.line         = element_line(colour = "black", size = 0.6, linetype = "solid"), 
        axis.ticks        = element_line(linewidth = 0.6),
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin       = list(unit(c(2, 0.2, 1, 1.5), "cm"),  unit(c(2, 1, 1, 0.5), "cm"))[[.y]]) +  
  
  # Scales
  coord_cartesian(xlim = c(0, 9), ylim = c(0, 1), clip = "off") +
  scale_x_continuous(expand = c(0, 0), breaks = c(0:9)) + 
  scale_y_continuous(expand = c(0, 0), breaks = seq(0, 1, 0.2), labels = seq(0, 100, 20)) + 
  
  # Risk/Censored
  geom_text(x      = x_risk_title, 
            y      = y_risk_title, 
            label  = c(paste0("At risk (n):  ", "\n", "Censored (n):  "), "")[.y],  
            size   = 3.5, 
            family = font_style, 
            lineheight = 1,
            color  = "black", 
            hjust  = 0) +
  
  #Number at risk 
  geom_text(x = 0.3, y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[1]],  size = 3.5, family = font_style, color = "black") +
  geom_text(x = 3,   y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[4]],  size = 3.5, family = font_style, color = "black") +
  geom_text(x = 5,   y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[6]],  size = 3.5, family = font_style, color = "black") +
  geom_text(x = 7,   y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[8]],  size = 3.5, family = font_style, color = "black") +
  geom_text(x = 9,   y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[10]], size = 3.5, family = font_style, color = "black") +
 
    
  # Cumulative event rate
  geom_text(x        = 0.3, 
            y        = 0.95,    
            label    = paste0("5-year CMR (95% CI), %", "\n", df_5year[[.y]]), 
            size     = 4, 
            family   = font_style, 
            color    = "black", 
            hjust    = 0) +
  
  # Panel title  
  geom_text(x     = -0.5, 
            y     = 1.05, 
            label = c("A. Heart failure", "B. Pulmonary heart disease")[.y], 
            size  = 4.5, 
            color = "black", 
            hjust = 0, 
            fontface = 2) +  
    
  # Plot title 
  geom_text(x     = x_risk_title,
            y     = 1.15,
            label = c("Cumulative mortality risk", "")[.y],
            size  = 4.5, 
            color = "black", 
            hjust = 0, 
            fontface = 2) +

  ylab(y_label[[.y]]) + 
  xlab("")
  
)


 
```


Merge plots for mortality (28-day and cumulative)

```{r}

## Export plot 
plot <- ggarrange (plot_list_cfr[[1]], 
                   plot_list_cfr[[2]],
                   plot_list_cmr[[1]], 
                   plot_list_cmr[[2]],
                   ncol       = 2,
                   nrow       = 2,
                   widths     = rep(1, 4), 
                   heights    = rep(2,4)
                   )



 
 ckbplotr::save_figure(
   plot, 
   ext = c("png", "png"), 
   unit(c(11, 14), "in"),
   margin  = unit(c( 
                1, 
                0.1, 
                0.1, 
                0.1), 
                units = "cm"),
   landscape = FALSE, 
   cropped = TRUE,
   name = paste0(Sys.Date(), "_", "Figure 3. Short term and long term mortality"), 
   title = "",
   args = list(bg = "white", pointsize = 6),
   args_cropped = list(bg = "white", pointsize = 6)
   
 )  
 
```


To insert title and legend 
```{r}
 
grob_title_plot <-  annotate_figure(plot,
                 top = text_grob("Figure 2: 28-day case-fatality ratio and cumulative risk of mortality of heart failure\nand pulmonary heart disease
                                 ",
                                 color = "black",
                                 face  = "bold",
                                 size  = 16
                                 )) 
 
 
 
 ckbplotr::save_figure(
   grob_title_plot, 
   ext = c("png", "png"), 
   pagedim = unit(c(10, 15), "in"),
   margin  = unit(c(
                1, 
                1, 
                2, 
                1), 
                units = "cm"),
   landscape = FALSE, 
   cropped = TRUE,
   name = "Fig 2 mortality all", 
   title = "",
   args = list(
            bg = "white", 
            pointsize = 6
            ),
   footer.gpar = list(fontsize = 12),
   footer.pos  = grid::unit.c(unit(1.5, "cm"), unit(1/2, "cm")),
   footer = "\n \nAge-specific case-fatality ratios (CFR) were standardised by sex and area (urban and rural).
             Cumulative mortality risk (CMR) curves\n were standardised by age at diagnosis, sex and area\n"
 )   
 
 

```


## SUBGROUP: Age, sex, and area

```{r Standardised mortality after HF and PHD (By Age, sex, and area)}


# Variables for subgroup
grouping_var <- c("age_diag65", "sex", "area")

#Data 
dat        <- list(data_hf, data_phd)
data_label <- c('hf', 'phd')

#Follow up time and outcome 
fu.time <- "futime_yr"
outcome <- "all_death"

 
# Obtaining adjusted survival with mutual adjustments for age, sex, and area--


#To hold datasets temporarily 
temp_surv_all_df_list2 <-  list(length = length(grouping_var))
temp_surv_0_9_df_list2 <-  list(length = length(grouping_var))

#To hold datasets
surv_all_df_list2 <-  list(length = length(dat))
surv_0_9_df_list2 <-  list(length = length(dat))


for (df in seq_along(dat)) {

  data_temp <- dat[[df]]
  
     for (v in seq_along(grouping_var)) {
              
            strata_vars_temp  <- grouping_var[v]
            grouping_var_temp <- grouping_var[-v]
            
          #Generate weights and add to the dataset--
      
            data_temp <- my_ipw_fn(data         = data_temp,
                                   grouping_var = grouping_var_temp,  
                                   strata       = strata_vars_temp) 
            

          #Fit survival model--
            
            form <- as.formula(paste(sprintf("%s","Surv ("), fu.time, ",", outcome, ") ~", 
                                             paste0(as.factor(strata_vars_temp), collapse=" "))) 
            
            surv_obj_temp  <- survfit(form, data = data_temp, weights = data_temp$weight)
            surv_summ_temp <- summary(surv_obj_temp, extend = TRUE)                                        
            surv_0_9_temp  <- summary(surv_obj_temp, times = c(0:8))
            
            
          #Create a dataframe from the survival objects--
      
            #Including all survival times 
            surv_summ_temp_df <- data.frame(cbind(time      = surv_summ_temp$time, 
                                                  strata    = factor(surv_summ_temp$strata),
                                                  n.risk    = surv_summ_temp$n.risk, 
                                                  n.event   = surv_summ_temp$n.event, 
                                                  n.censor  = surv_summ_temp$n.censor, 
                                                  survival  = surv_summ_temp$surv, 
                                                  std.err   = surv_summ_temp$std.err, 
                                                  uci       = 1 - surv_summ_temp$lower, 
                                                  lci       = 1 - surv_summ_temp$upper,
                                                  cum_death = 1 - surv_summ_temp$surv))
          
            surv_summ_temp_df$strata   <- factor(surv_summ_temp_df$strata, 
                                                 labels = levels(data_temp[[strata_vars_temp]]))  
            
            surv_summ_temp_df$exposure <- strata_vars_temp
          
            #Including specific times points (0:9)
            surv_0_9_temp_df <- data.frame(cbind(time      = surv_0_9_temp$time, 
                                                 strata    = factor(surv_0_9_temp$strata),
                                                 n.risk    = surv_0_9_temp$n.risk, 
                                                 n.event   = surv_0_9_temp$n.event, 
                                                 n.censor  = surv_0_9_temp$n.censor, 
                                                 survival  = surv_0_9_temp$surv, 
                                                 std.err   = surv_0_9_temp$std.err, 
                                                 uci       = 1 - surv_0_9_temp$lower, 
                                                 lci       = 1 - surv_0_9_temp$upper,
                                                 cum_death = 1 - surv_0_9_temp$surv)) 
            
            
            surv_0_9_temp_df$strata   <- factor(surv_0_9_temp_df$strata, 
                                                labels = levels(data_temp[[strata_vars_temp]])) 
            
            surv_0_9_temp_df$exposure <- strata_vars_temp
    
    
          #Store the resulting dataframes in a list--
            temp_surv_all_df_list2[[v]] <- surv_summ_temp_df
            temp_surv_0_9_df_list2[[v]] <- surv_0_9_temp_df
            
            
            #End of for loop 
        
        }
   
  #Capture datasets 
  surv_all_df <- map_dfr(temp_surv_all_df_list2, ~rbind(.x)) %>% dplyr::mutate(disease = data_label[df])
  surv_0_9_df <- map_dfr(temp_surv_0_9_df_list2, ~rbind(.x)) %>% dplyr::mutate(disease = data_label[df])
  
  surv_all_df_list2[[df]] <- surv_all_df
  surv_0_9_df_list2[[df]] <- surv_0_9_df
                             
} 
  

# Compute age-adjusted five-year mortality by sex and area only--
# No need to conduct MA by subgroup here because the survival curves have been
# adjusted for age differences by direct standardisation   

# Get results for five-year cumulative mortality
ma_cmr_subg <- 
  map(.x = surv_0_9_df_list2,
      ~filter(.x, time == 5) %>%
       mutate(cmr100 = round(cum_death*100), 
              lci100 = round(lci*100), 
              uci100 = round(uci*100),
              cmr_ci = paste0(cmr100, "% (", lci100, " - ", uci100, ")"))) 

  

```

```{r Wrangle data}

# Split datasets and prepare for plotting--

# Convert exposure as factor and maintain order of exposures before splitting
order_exposure <- map(.x = surv_0_9_df_list2, ~unique(.x$exposure))

surv_0_9_df_list2 <- 
  
  map2(
    .x = surv_0_9_df_list2,
    .y = seq_along(surv_0_9_df_list2), 
    ~mutate(.x, exposure = factor(exposure, levels = order_exposure[[.y]])))


surv_all_df_list2 <- 
  
  map2(
    .x = surv_all_df_list2, 
    .y = seq_along(surv_all_df_list2), 
    ~mutate(.x, exposure = factor(exposure, levels = order_exposure[[.y]])))


#Data for 5-year CMR 
ma_cmr_subg <- 
  
  map2(
    .x = ma_cmr_subg, 
    .y = seq_along(ma_cmr_subg), 
    ~mutate(.x, exposure = factor(exposure, levels = order_exposure[[.y]])))


# Split data and flatten remove hierarchical structure 
df_sub_all_split  <- 
  
  map(
    .x = surv_all_df_list2, 
    ~dplyr::group_split(group_by(.x, exposure))) %>%flatten() %>% 
  map(~dplyr::filter(.x, time < 7.1))


df_sub_desc_split <- 
  
  map(
    .x = surv_0_9_df_list2, 
    ~dplyr::group_split(group_by(.x, exposure))) %>% flatten()


cmr_ci <- 
  map(
    .x = ma_cmr_subg, 
    ~dplyr::group_split(group_by(.x, exposure))) %>% flatten()


# Dataframe for confidence interval (filter out time = 0)
df_ci  <-  map(.x = df_sub_desc_split, ~dplyr::filter(.x, time > 0, time <8)) 


```


```{r Plot cumulative mortality by SUBGROUP}

# Create plot for subgroups 

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/my_gg_theme_text.R")


# Define labels --

strata_label <- c(
  list("Age at diagnosis, years", "Sex", "Area"), 
  rep(list(""), 3)) 

y_label <- rep(list("Cumulative risk, % (95% CI)", "", ""), 2)

x_label <- c(
  rep(list(""), 3), 
  rep(list("Time since first admission (years)"), 3))

y_tick_label <- rep(list(seq(0, 100, 20), NULL, NULL), 2)


#Turn off legend for bottom plots 
leg_position <- c(list(c(0.19, 0.95), c(0.15, 0.95), c(0.15, 0.95)), rep(list("none"), 3))

cust_margins <- list(c(2, 1, 2, 1.5), c(2, 1, 2, 1.5), c(2, 1, 2, 1.5), 
                      c(2, 1, 1, 1.5), c(2, 1, 1, 1.5), c(2, 1, 1, 1.5))

# Get group levels 
group_levels <- map(.x = df_sub_desc_split, 
                    ~pull(.x, strata) %>% as.character(.) %>% unique(.) %>% stringr::str_to_sentence(.))

group_levels <- map(.x = group_levels, ~paste0(.x, ":"))


# Number at risk
n_risk <- 
  map(
    .x = df_sub_desc_split, 
    ~dplyr::group_by(.x, time) %>% 
     dplyr::summarise(num_risk = paste0(round(n.risk), collapse = "\n")))

n_risk_title <- c(list("Number at risk"), rep(list(""), 5))

n_risk_body  <- list(pluck(group_levels, 1), 
                     pluck(group_levels, 2), 
                     pluck(group_levels, 3),
                     NULL, 
                     NULL, 
                     NULL)

data_label   <- list('Heart failure', "", "", 'Pulmonary heart disease', "", "")
font_style   <- ""


# Positioning text on plot 

x_risk_title = -2
y_risk_title = -0.2
y_decrement_risk = y_risk_title - 0.05

x_event_text = 0.1     

# Order of "y_decrement event: Main, group 1, group 2
y_event <- list(0.9, 0.9, 0.9, 0.2, 0.2, 0.2)


rm("strata") #Remove objects named strata to avoid conflicts. 



# Plotting ---
 
plot_list <- 
  
  map2(
    .x = df_sub_all_split, 
    .y = seq_along(df_sub_all_split), 
     
     ~ggplot(data = .x, mapping = aes(x = time, y = cum_death)) + 
      geom_step(aes(linetype = strata), linewidth = 0.7) + 
      
      geom_errorbar(data    = df_ci[[.y]], 
                    mapping = aes(x = time, y = cum_death, ymin = lci, ymax = uci, linetype = strata), 
                    width   = 0.1, linewidth = 0.7) + 
      
      geom_point(data = df_ci[[.y]], aes(x = time, y = cum_death), shape = 15, size = 1) + 
      
      #Setting theme --
    
      theme_void() + 
      
      theme(axis.text.x  = element_text(size = 13, vjust = 0),
            axis.text.y  = element_text(size = 13, hjust = 1), 
            axis.title.x = element_text(size = 14, vjust = -1), 
            axis.title.y = element_text(size = 14, angle = 90)) +

      theme(legend.position   = leg_position[[.y]],  
            axis.line         = element_line(colour = "black", size = 0.6, linetype = "solid"), 
            axis.ticks        = element_line(linewidth = 0.6),
            axis.ticks.length = unit(0.25, "cm"),
            plot.margin       = unit(cust_margins[[.y]], "cm")
            ) + 
      
      guides(
        linetype = guide_legend(title       = "", 
                                title.hjust = 0,
                                label.hjust = 0,
                                title.theme = element_text(size = 12, face = "bold", family = font_style),   
                                label.theme = element_text(size = 12, family = font_style))) + 
      
      # Modify axes -- 
      coord_cartesian(xlim = c(0, 7.0), ylim = c(0, 1), clip = "off") + 
      scale_x_continuous(
        expand = c(0, 0), 
        breaks = 0:7, 
        labels = c(rep(list(NULL), 3), rep(list(0:7), 3))[[.y]]
        ) + 
      scale_y_continuous(
        expand = c(0, 0), 
        breaks = seq(0, 1, 0.2), 
        labels = rep(list(seq(0, 100, 20), NULL, NULL), 2)[[.y]]
        ) + 
      
      # Modify legend
      guides(
         linetype = guide_legend(
                          title       = "", 
                          title.theme = element_text(size = 11.5, face = "bold"), title.hjust = 0,
                          label.theme = element_text(size = 11.5, lineheight = 1), label.hjust = 0)) +
      
      # Write number at risk (heading)
      geom_text(x          = c(-2.4, -1.65, -1.45, rep(x_risk_title, 3))[.y], 
                y          = y_risk_title, 
                label      = paste0(n_risk_title[[.y]], "\n", paste0(n_risk_body[[.y]], collapse = "\n")),   
                size       = 4,
                color      = "black",
                hjust      = 0) + 
                    
      # Number at risk
      geom_text(x = 0, y = y_risk_title, size = 4, color = "black", label = paste0("\n", n_risk[[.y]]$num_risk[[1]])) + 
      geom_text(x = 1, y = y_risk_title, size = 4, color = "black", label = paste0("\n", n_risk[[.y]]$num_risk[[2]])) + 
      geom_text(x = 3, y = y_risk_title, size = 4, color = "black", label = paste0("\n", n_risk[[.y]]$num_risk[[4]])) + 
      geom_text(x = 5, y = y_risk_title, size = 4, color = "black", label = paste0("\n", n_risk[[.y]]$num_risk[[6]])) + 
      geom_text(x = 7, y = y_risk_title, size = 4, color = "black", label = paste0("\n", n_risk[[.y]]$num_risk[[8]])) + 
      
      # # CMR Subtitles
      # geom_text(x     = x_event_text, 
      #           y     = rep(c(0.83, 0.91, 0.91), 2)[.y], 
      #           size  = 4.3, 
      #           color = "black", 
      #           hjust = 0,
      #           label = paste0(group_levels[[.y]], collapse = "\n")) +
                                   
      # CIF (95% CI) (numbers)
      geom_text(x     = list(2.7, 2.2, 2, 0.14, 0.14, 0.14)[[.y]], 
                y     = 0.91, 
                hjust = 0,
                size  = 3.8, 
                lineheight = 1.3,
                color = "black",
                label = paste0(paste0(cmr_ci[[.y]]$cmr_ci, collapse = "\n"))) + 
  
      # Panel title
      geom_text(x        = -0.3, 
                y        = 1.06, 
                size     = 4.5,  
                hjust    = 0, 
                color    = "black",
                fontface = 2,
                label    = strata_label[[.y]]) +
      
      # Plot title
      geom_text(x        = -2.5, 
                y        = c(1.15, 0, 0, 1.10, 0, 0)[.y], 
                size     = 6,  
                hjust    = 0,  
                color    = "black",
                fontface = 2,
                label    = data_label[[.y]]) +
                   
      ylab(y_label[[.y]]) +
      xlab(x_label[[.y]])
    )  


 plot <- ggarrange (plot_list[[1]],
                    plot_list[[2]],
                    plot_list[[3]],
                    plot_list[[4]],
                    plot_list[[5]],
                    plot_list[[6]],
                    ncol = 3, 
                    nrow = 2,
                    widths  = rep(1, 6), 
                    heights = rep(2, 6))


 ckbplotr::save_figure(
   plot, 
   ext = c("png", "png"),
   pagedim = unit(c(15, 12), "in"),
   margin  = unit(c(
                1, 
                1, 
                1.5, 
                1.5), 
                units = "cm"),
   landscape = FALSE, 
   name = "Fig 4 CMR subgroup", 
   title = "",
   args = list(
            bg = "white", 
            pointsize = 6
            ),
   footer.pos  = grid::unit.c(unit(1.9, "cm"), unit(1/2, "cm")),
   # footer = "Cumulative mortality risk (CMR) curves were directly standardised by age at diagnosis, sex and area as appropriate"
 )   
 

```


### SUBGROUP2
```{r}

# Variables for subgroup
grouping      <- c("age_diag65", "sex", "area")

strata_var    <- c("edu3", 
                   "HTN",  
                   "diabetes", 
                   "develop_IHD", 
                   "stroke_tia", 
                   "develop_copd", 
                   "co_hf_phd", 
                   "n_combid_cat")

strata_labels  <- list(
                    "Trend" = "Level of education", 
                    "Heterogeneity" = "Hypertension", 
                    "Heterogeneity" = "Diabetes", 
                    "Heterogeneity" = "CHD or IHD", 
                    "Heterogeneity" = "Stroke or TIA",
                    "Heterogeneity" = "COPD", 
                    "Heterogeneity" = "HF and PHD co-occurrence", 
                    "Trend" = "Number of comorbidities")


#Data 
dat        <- list(data_hf, data_phd)
data_label <- c('hf', 'phd')

#Follow up time and outcome 
fu.time <- "futime_yr"
outcome <- "all_death"


#Build loop --

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/my_ipw_fn.R")

surv_summ_df <- list()
surv_0_9_df  <- list()
cmr5         <- list()


for (df in seq_along(dat)) {
  
  data_temp <- dat[[df]]
  
  surv_summ_temp <- list()
  surv_0_9_temp  <- list()
  
  
        for (v in seq_along(strata_var)) {  
        
        #Generate weights and add to the dataset --
          
        data_temp <- 
          
        my_ipw_fn(
            data = data_temp, 
            grouping_var = grouping, 
            strata = strata_var[[v]])
        

         #Fit survival model --
                
        form <- as.formula(paste("Surv (", fu.time, ",", outcome, ") ~ ", "as.factor(", strata_var[v], ")" ))
        
        surv_obj_temp       <- survfit(form, data = data_temp, weights = data_temp$weight)
        surv_summ_temp[[v]] <- summary(surv_obj_temp)                                        
        surv_0_9_temp[[v]]  <- summary(surv_obj_temp, times = c(0:9))
                
        }
  
  
#Create a dataframe from the survival objects --

      # All survival times 
      surv_summ_df[[df]] <- 
        
         map2(.x = surv_summ_temp,
              .y = seq_along(surv_summ_temp),
             
              ~data.frame(cbind(time      = .x$time, 
                                strata    = factor(.x$strata),
                                n.risk    = .x$n.risk, 
                                n.event   = .x$n.event, 
                                n.censor  = .x$n.censor, 
                                survival  = .x$surv, 
                                std.err   = .x$std.err, 
                                uci       = 1 - .x$lower, 
                                lci       = 1 - .x$upper,
                                cum_death = 1 - .x$surv)) %>% 
             
              dplyr::mutate(strata   = factor(strata, labels = levels(dat[[df]][[ strata_var[.y] ]] )), 
                            exposure = factor(strata_labels[[.y]]), 
                            disease  = data_label[df])
           )
    
      # Discrete time (0:9)
      surv_0_9_df[[df]] <- 
        
         map2(.x = surv_0_9_temp,
              .y = seq_along(surv_0_9_temp),
             
              ~data.frame(cbind(time      = .x$time, 
                                strata    = factor(.x$strata),
                                n.risk    = .x$n.risk, 
                                n.event   = .x$n.event, 
                                n.censor  = .x$n.censor, 
                                survival  = .x$surv, 
                                std.err   = .x$std.err, 
                                uci       = 1 - .x$lower, 
                                lci       = 1 - .x$upper,
                                cum_death = 1 - .x$surv)) %>% 
               
               dplyr::mutate(strata   = factor(strata, labels = levels( dat[[df]][[strata_var[.y]]] )), 
                             exposure = factor(strata_labels[[.y]]), 
                             disease  = data_label[df]) %>% 
               
               `row.names<-`(NULL)
             ) %>% 
           map_dfr( ~rbind(.x))
      
      # Get 5-year CMR
      cmr5[[df]] <- 
        surv_0_9_df[[df]] %>% 
            filter(time == 5) %>% 
            dplyr::mutate(risk_event = paste0(round(n.risk), " (", round(n.event), ")")) %>%  
            dplyr::select(exposure, strata, risk_event, std.err:cum_death, disease)
                            
  
      rm("data_temp")

  
  # End of Loop --
  }

group_headers <- unique(cmr5[[1]]$exposure) 

# Perform heterogeneity test --
trend_het_cmr <-
  map(
    .x = cmr5,
    ~group_by(.x, exposure) %>%
      group_split() %>% 
      
      map2_dfr(
        .y = names(strata_labels),
        ~if(.y == "Trend"){trend(.x$cum_death, .x$std.err) 
         }else{heterogeneity(.x$cum_death, .x$std.err)}
      ) %>% 
      bind_cols(
        ., 
        exposure  = group_headers, 
        test_type = names(strata_labels)) %>% 
      group_by(exposure) %>% 
      group_split()
  )


# Join heterogeneity data to main subgroup df 

cmr5_split <- 
  map(
    .x = cmr5, 
    ~group_by(.x, exposure) %>% group_split())


for (c in seq_along(cmr5_split)) {
  

cmr5[[c]] <-

  map2_dfr(
    .x = cmr5_split[[c]],
    .y = trend_het_cmr[[c]],
  
    ~mutate(
        .x,
        df = c(rep(NA, nrow(.)-1), .y$df),
        chi2 = c(rep(NA, nrow(.)-1), round(.y$`test statistic`, 1)),
        p = ifelse(.y$p < 0.0001, "<0.0001", as.character(round(.y$p, 4))),
        p = ifelse(is.na(df), NA, p), 
        test_type = ifelse(is.na(df), NA, .y$test_type), 
        Het   = ifelse(!is.na(chi2) & test_type == "Heterogeneity", paste(df, chi2, p, sep = ","), NA), 
        Trend = ifelse(!is.na(df) & test_type == "Trend", paste(df, chi2, p, sep = ","), NA),  
        IsDiamond  = 0, 
        FillColour = 1
      ) %>% 
      
     select(-std.err)
  
    )

}  


```



### SUBGROUP: Merge datasets

```{r}

cmr5_df <- map(.x = cmr5, 
               ~add_table_header(data            = .x, 
                                 group_var       = exposure, 
                                 group_level_var = strata, 
                                 extra_space     = FALSE))

# Add all 
cmr_overall <- map(.x = surv_0_9_df_all, ~filter(.x, time == 5))

n_risk_cens <- 
  
  map2(
    .x = surv_0_9_df_all, 
    .y = seq_along(surv_0_9_df_all),
  
    ~filter(.x, time ==5) %>% 
     dplyr::transmute(strata      = "All", 
                      risk_event  = paste0(n.risk, " (", n.event, ")"), 
                      cum_death   = cmr_overall[[.y]]$cum_death, 
                      uci         = cmr_overall[[.y]]$uci, 
                      lci         = cmr_overall[[.y]]$lci, 
                      disease     = cmr_overall[[.y]]$disease, 
                      df          = NA, 
                      chi2        = NA, 
                      p           = NA_character_,
                      Het         = NA_character_,
                      Trend       = NA_character_,
                      test_type   = NA_character_,
                      IsDiamond   = 1, 
                      FillColour  = 0) %>% 
    
    add_row(.before = 1) %>% 
    as_tibble(.)
    ) 

## Bind datasets 
subgroup_df <- 
  
  map2(.x = cmr5_df, 
       .y = seq_along(n_risk_cens),  
       
        ~rbind(.x, n_risk_cens[[.y]]) %>% 
          dplyr::mutate(across(.cols = uci:cum_death, ~.x*100)) %>%
          relocate(disease, .after = FillColour) %>% 
          rename(
            "Heading" = strata, 
            !!paste0("Het", .y) := Het,  
            !!paste0("Trend", .y) := Trend,   
            !!paste0("IsDiamond", .y) := IsDiamond, 
            !!paste0("FillColour", .y) := FillColour) %>% 
          add_row(.before = 1) %>% 
          as.data.frame(.)
       )



```


### SUBGROUP: Forest plot 

```{r plotting subgroup}

rawdata <- subgroup_df


lab_plot  <- "Figure S4: Standardised 5-year cumulative mortality risk of heart failure and pulmonary heart\ndisease by subgroup"

  
# set up an object that stores the forest and associated metadata

forest.hf <- FormatForest(rawdata     = rawdata[[1]], 
                          forest.n    = 1, 
                          EstimateCol = "cum_death", 
                          LCICol      = "lci", 
                          UCICol      = "uci", 
                          logData     = FALSE, 
                          getBlanks   = TRUE, 
                          getHets     = TRUE, 
                          getTrends   = TRUE)

# Forest object of PHD (panel 2)
forest.phd <-  FormatForest(rawdata     = rawdata[[2]] %>% select(-1), 
                            forest.n    = 2, 
                            EstimateCol = "cum_death", 
                            LCICol      = "lci", 
                            UCICol      = "uci", 
                            logData     = FALSE, 
                            getBlanks   = TRUE, 
                            getHets     = TRUE, 
                            getTrends   = TRUE)

blank.rows <- forest.hf$blank.rows 

 
# find labels to put in the left most column
left.labels <- convertUnicode(as.character(rawdata[[1]]$Heading))

# Get other columns
other.cols <- "risk_event"

# find column headings
print.headings <- parseColHeadings(rawdata[[1]]$ColHeadings, rd=rawdata[[1]])


##################################################################################

# set up the Jasper page
type <- "JPG"

SetPage(orient="PORTRAIT", 
        perpage=1, type=type, 
        filestem="Fig S4 CMR_subgroup", 
        page_dpi = 600,
        page_pointsize = 9,
        # page_height = 13.5,
        page_width  = 11,
        append_datetime=FALSE, 
        suppress.date=TRUE, 
        titlespace=0.05, 
        footerspace     = 0.05, 
        footer.cex      = 1.7, 
        footer    = "Cumulative mortality risks (CMRs) were directly standardised by age at diagnosis, sex and area (Urban and rural)\nCOPD = Chronic obstructive pulmonary disease, CHD = Prevalent coronary heart disease, IHD = incident ischaemic heart disease,\nTIA = Transient ischaemic attack, Het = Heterogeneity
        \n \n")

# Set page margins: format is c(bottom, left, top, right)
par(mar=c(4.14537797266251, 2, 8.14537797266251, 2))

mainfont <- 1.15
blankPlot(c(0,100),c(0,100), mainfont)
par(xpd=NA)

spacing <- 0.9
plot.width <- 15

x_label <- "Five-year CMR (%)"

# draw the Forest plot(s)
xaxmin1 <- 27.2542
xaxmax1 <- xaxmin1 + plot.width
locs <- ForestBasic(forest.hf,
                  	LogScale=FALSE,
                  	ExponentiateDataOnPlot=FALSE,
                  	xaxmin=xaxmin1,
                  	xaxmax=xaxmax1,
                  	xlim=c(-5, 100),
                  	xticks=seq(0, 100, 20),
                  	ticklabs=seq(0, 100, 20),
                  	xlab= x_label,
                  	NLabel=FALSE,
                  	mainfont=1,
                  	ValueLabels=TRUE,
                  	ValueLabelsHeader="CMR (95% CI)",
                  	ValueDigits=0,
                  	lwd=1,
                  	separator = " - ",
                  	CISecond=TRUE,
                  	spacing=spacing/2,
                  	verbose=FALSE,
                  	boxsizeoverride=FALSE,
                  	boxparm.stderr = 0.7)

# add titles above forest (may be left empty, change labels="" to what you will)
text(x=xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2, 
     y=107.5, 
     labels="Heart Failure", 
     adj=c(0.5,0), 
     font=2, 
     cex = 1.3)

text(x=xaxmin1 + (xaxmax1 - xaxmin1 + (spacing) )/2,
     y=104,
     labels=paste("(N=", nrow(data_hf), ")", sep = ""),
     adj=c(0.5,0),
     font=1,
     cex = 1.2)


# draw the Forest plot(s)
xaxmin2 <- 69.0592
xaxmax2 <- xaxmin2 + plot.width
locs2 <- ForestBasic(forest.phd,
                    	LogScale=FALSE,
                    	ExponentiateDataOnPlot=FALSE,
                    	xaxmin=xaxmin2,
                    	xaxmax=xaxmax2,
                    	xlim=c(-5, 100),
                    	xticks=seq(0, 100, 20),
                    	ticklabs=seq(0, 100, 20),
                    	xlab= x_label,
                    	NLabel=FALSE,
                    	mainfont=1,
                    	ValueLabels=TRUE,
                    	ValueLabelsHeader="CMR (95% CI)",
                    	ValueDigits=0,
                    	lwd=1,
                    	separator = " - ",
                    	CISecond=TRUE,
                    	spacing=spacing/2,
                    	verbose=FALSE,
                    	boxsizeoverride=FALSE,
            	        boxparm.stderr = 0.7)

# add titles above forest 
text(x=xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2,
     y=107.5,
     labels="Pulmonary heart disease",
     adj=c(0.5,0),
     font=2,
     cex = 1.3)

segments(x0 = 0,  y0 = 98, x1 = 100, y1=98, lwd = 1)

text(x=xaxmin2 + (xaxmax2 - xaxmin2 + (spacing) )/2,
     y=104,
     labels=paste("(N=", nrow(data_phd), ")", sep = ""),
     adj=c(0.5,0),
     font=1,
     cex = 1.2)

# left hand column of labels
text(x=0, y=100, labels="Strata",
     adj=c(0,0), font=2, cex=1)

text(x=0, y=locs$YLocs,
     adj=0, cex=1,
     labels=left.labels[-blank.rows], font=ifelse(forest.hf$IsDiamond, 2,1))

text(x=0, y=locs$BlankLocs,
     labels=left.labels[blank.rows], adj=0, font=2, cex=1)


### adding other columns  ####

# Death 1
column1.xpos <- xaxmin1 - 1
text(x=column1.xpos, y=100, labels=convertUnicode("Number at risk\n(event)"), adj=c(1,0), font=2, cex=1)

text(x      = column1.xpos, 
     y      = locs$YLocs, 
     labels = convertUnicode(as.character(rawdata[[1]][,other.cols[1]]))[-blank.rows], 
     font   = ifelse(forest.hf$IsDiamond, 2, 1), adj=1, cex=1)

text(x=column1.xpos, 
     y=locs$BlankLocs, 
     labels=convertUnicode(as.character(rawdata[[1]][,other.cols[1]]))[blank.rows], adj=1, cex=1)


# Death 2 (For PHD)
column3.xpos <- xaxmin2 - 1

text(x      = column3.xpos, 
     y      = 100, 
     labels = convertUnicode("Number at risk\n(event)"), adj=c(1,0), font=2, cex=1)

text(x      = column3.xpos, 
     y      = locs2$YLocs, 
     labels = convertUnicode(as.character(rawdata[[2]][,other.cols[1]]))[-blank.rows], 
     font   = ifelse(forest.phd$IsDiamond, 2, 1), adj=1, cex=1)

text(x      = column3.xpos, 
     y      = locs2$BlankLocs, 
     labels = convertUnicode(as.character(rawdata[[2]][,other.cols[1]]))[blank.rows], adj=1, cex=1)



# Add heterogeneity labels -- 

# Heterogeneity labels 
x_coord <- list("hf"  = 43.8003646765421, 
                "phd" = 85.6423204683451)

# Number of trend and het tests 
chi_p_df <- map(.x = subgroup_df, ~filter(.x, !is.na(df)) %>% select(test_type, df:p))

n_trend_test   <- map(.x = chi_p_df, ~nrow(filter(.x, test_type == "Trend")))
n_het_test     <- map(.x = chi_p_df, ~nrow(filter(.x, test_type == "Heterogeneity")))


index = 1
# Labels for HF ---
# Heterogeneity labels for HF

for (H in seq_len(n_het_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$df[H]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$chi2[H]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$p[H]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# Trend labels for HF

for (TT in seq_len(n_trend_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$df[TT]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$chi2[TT]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$p[TT]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[TT], 
       adj    = 0, 
       cex    = 0.8,   
       labels = bquote(Trend: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# Labels for PHD ---

# Heterogeneity labels for PHD

index = 2

for (H in seq_len(n_het_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$df[H]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$chi2[H]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Heterogeneity", ]$p[H]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$HetLocs[H], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Het: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}

# Trend labels for HF

for (TT in seq_len(n_trend_test[[index]]) ) {
  
  chi_index <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$df[TT]
  chi_val   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$chi2[TT]
  p_value   <- chi_p_df[[index]][chi_p_df[[index]]$test_type == "Trend", ]$p[TT]
  p_value   <- ifelse(p_value == "<0.0001", paste0("p", "<0.0001"), paste0("p=", p_value))
  
  text(x      = x_coord[[index]], 
       y      = locs$TrendLocs[TT], 
       adj    = 0, 
       cex    = 0.8,  
       labels = bquote(Trend: ~ chi[.(chi_index)]^2 ~ "=" ~ .(chi_val) ~ (.(p_value))) )
  
}



##Plot title
text(x=50.5,
     y= 113,
     font=2,
     cex = 1.4,
     adj=c(0.5, 0),
     col="black",
     labels=lab_plot)

# stop writing to file
closeFile(type)

```



### SUBGROUP: Region

```{r}

# Get results for alcohol and smoking for men only 
grouping_var     <- c("age_diag65", "sex")
strata_var       <- c("region")
strata_labels    <- c("Region")

#Data 
dat        <- list(data_hf, data_phd)
data_label <- c('hf', 'phd')

#Follow up time and outcome 
fu.time <- "futime_yr"
outcome <- "all_death"


#Build loop --

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/my_ipw_fn.R")

surv_0_9_region  <- list()


for (df in seq_along(dat)) {
  
  data_temp <- dat[[df]] 
  
  surv_0_9_temp  <- list()
  
  
        for (v in seq_along(strata_var)) { 
        
        #Generate weights and add to the dataset --
          
        data_temp <- my_ipw_fn(data         = data_temp,
                               grouping_var = grouping_var, 
                               strata       = strata_var[[v]])
            

        #Fit survival model --
          
        form    <- as.formula(paste("Surv (", fu.time, ",", outcome, ") ~ ", "as.factor(", strata_var[v], ")" ))
      
        surv_obj_temp       <- survfit(form, data = data_temp, weights = data_temp$weight)                                     
        surv_0_9_temp[[v]]  <- summary(surv_obj_temp, times = c(0:9))
                
    }
  
  
#Create a dataframe from the survival objects.--
    
      # Discrete time (0:9)
  surv_0_9_region[[df]] <- map2(.x = surv_0_9_temp, 
                                .y = seq_along(surv_0_9_temp),
                               
                               ~ data.frame(cbind(time      = .x$time, 
                                                  strata    = factor(.x$strata),
                                                  n.risk    = .x$n.risk, 
                                                  n.event   = .x$n.event, 
                                                  n.censor  = .x$n.censor, 
                                                  survival  = .x$surv, 
                                                  std.err   = .x$std.err, 
                                                  uci       = 1 - .x$lower, 
                                                  lci       = 1 - .x$upper,
                                                  cum_death = 1 - .x$surv)
                                            ) %>% 
                                 dplyr::filter(time == 5) %>% 
                                 
                                 dplyr::mutate(strata   = factor(strata, 
                                                                 labels = levels(dat[[df]][[strata_var[.y]]] )), 
                                               
                                               exposure = strata_labels[.y], 
                                               disease  = data_label[df]) %>% 
                                 
                                 `row.names<-`(NULL)
                               
                               ) 
      

      rm("data_temp")
}


surv_0_9_region <- flatten(surv_0_9_region)


## Manipulate data and prepare for plotting --

# Get AREA data 
area_prev_ci <- map(.x = ma_cmr_subg, 
                    ~filter(.x, strata %in% c("Rural", "Urban")) %>% 
                     select(strata, cmr_ci) %>% 
                      rename("Area" = strata))

# Wrangle URBAN data 

 urban_region <- merged_data %>% 
                     filter(area == "Urban") %>% 
                     pull(region) %>% 
                     as.character(.) %>% 
                     unique(.)

 
 df_bar.cmr <- 
   map2(
     .x = surv_0_9_region,
     .y = area_prev_ci,
     ~mutate(
       .x, 
       Area = factor(case_when(strata %in% urban_region ~ "Urban", TRUE ~ "Rural")), 
       cum_death = cum_death*100,
       lci = lci*100, 
       uci = uci*100) %>% 
       arrange(cum_death) %>% 
     #Join area data 
      inner_join(., .y, by = "Area") %>% 
       
      # Paste area and cmr (Will help for labelling) --
       mutate(Area_cmr_ci = paste0(Area,": ", cmr_ci))
       ) %>% 
   
   # Get barplot data
   map(~barplot_data(dataset = .x, region_var = "strata"))

 
```


### SUBGROUP: Region Plot 

```{r Plotting cumulatie mortality by region}

Area_bar <- 
  
  map(.x = df_bar.cmr, 
      ~drop_na(.x) %>% 
        select(Area, cmr_ci) %>% 
        unique(.) %>% 
        arrange(Area))

n_groups <- map_dbl(.x = df_bar.cmr, ~filter(.x, !is.na(Area)) %>% nrow(.)) 


# Create barplot 
outcome_title  <- c("E. Heart failure", "F. Pulmonary heart disease")
lab_eventr     <-  list("Cumulative mortality risk, % (95% CI)", "")
font_style     <- ""


x_region_text  = 0.5
x_region_title = 7.5
y_max          = 100


barplot_region_cmr <- 
  
  map2(
    .x = df_bar.cmr,  
    .y = seq_along(df_bar.cmr),
    
    ~ggplot(data = .x) + 
                
     geom_col(
       aes(x = strata, y = cum_death, fill = Area), 
       colour = "black", 
       alpha = 1, 
       width = 1) + 
  
    geom_errorbar(aes(x = strata, y = cum_death, ymin = lci, ymax = uci), width = 0.3, linewidth = 0.5) +
    
    # Labels on bars
    geom_text(
      aes(x = strata, y = uci, label = round(cum_death)), 
      size = 4,
      color = "black", 
      vjust = -0.5,
      hjust = 0.5,
      fontface = 2) + 
    
    #Setting theme 
    theme_void() +
    
    #Theme text 
    theme(
        text              = element_text(family = font_style),
        axis.text.x       = element_text(size = 12, vjust =  0.6, hjust = 1, angle = 90),
        axis.text.y       = element_text(size = 12, hjust = 1), 
        axis.title.x      = element_text(size = 14,   vjust = -1), 
        axis.title.y      = element_text(size = 14,   angle = 90)
        ) +
  
    theme(
        legend.position   = "none",  
        axis.line         = element_line(colour = "black", size = 0.6, linetype = "solid"), 
        axis.ticks        = element_line(size = 0.6),
        axis.ticks.x      = element_line(colour = c(rep(c("black", NA), n_groups[.y]), "black")),
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin       = unit(c(1, 0.5, 0.5, 0.5), "cm")
        ) +                
  
    guides(
        fill = guide_legend(
                     title       = "",
                     title.theme = element_text(size = 11.5, face = "bold"), title.hjust = 0,
                     label.theme = element_text(size = 12, lineheight = 1), label.hjust = 0)) +
    
    scale_fill_manual(
      values = c("grey70", "white"), 
      limits = Area_bar[[.y]]$Area
      # labels = paste0(levels(.x$Area), ":")
      ) +
    
    coord_cartesian (
      xlim = c(0, as.numeric(paste0(nrow(.x), ".1")) ), 
      ylim = c(0, 100), 
      clip = "off") + 
      
    scale_x_discrete (expand = c(0, 0), breaks = .x$strata, labels = .x$x_label) + 
    scale_y_continuous (
      expand = c(0, 0), 
      breaks = seq(0, 100, 20), 
      labels = list(seq(0, 100, 20), NULL)[[.y]]) + 
     
    # Add prevalence 
    geom_text(x      = 0.5,
              y      = 89,
              label  = paste0(Area_bar[[.y]]$cmr_ci, collapse = "\n"),
              size   = 4.1,
              lineheight = 1.3,
              color  = "black",
              hjust  = 0) +
      
    # Plot title 
    geom_text(x      = -3, 
              y      = y_max + 10, 
              size   = 5.5, 
              family = font_style, 
              color  = "black", 
              hjust  = 0, fontface = 2,
              label  = c("5-year cumulative mortality", "")[.y]) +
  
    ylab(c("Cumulative mortality risk, % (95% CI)", "")[.y]) +
    xlab("") 
 
)


## Export plot 
plot <- ggarrange(barplot_region_ir[[1]], 
                  barplot_region_ir[[2]], 
                  barplot_region_cfr[[1]], 
                  barplot_region_cfr[[2]], 
                  barplot_region_cmr[[1]],
                  barplot_region_cmr[[2]], 
                  ncol = 2, 
                  nrow = 3)
 

 ckbplotr::save_figure(
   
   plot, 
   ext = c("png", "png"),
   pagedim = unit(c(14.0, 16.3), "in"),
   # pagedim = "A4",
   margin  = unit(c(
                3.5, 
                1, 
                2, 
                1.5), 
                units = "cm"),
   landscape = FALSE, 
   name = "Fig S2 barplots", 
   title = "Figure S2: First hospitalisation rate, 28-day case-fatality rate, and 5-year cumulative mortality risk\n by region\n",
   title.gpar  = list(fontsize = 18, fontface = "bold"),
   title.jus   = c(-0.01, 1),
   args = list(
            bg = "white", 
            pointsize = 2
            ),
   footer.gpar = list(fontsize = 13),
   footer.pos  = grid::unit.c(unit(3, "cm"), unit(1/2, "cm")),
   footer = "\nHospitalisation rates were directly standardised by age-at-risk and sex. Twenty eight-day case fatality ratio (CFR) and cumulative mortality risks (CMR) were directly standardised by age at diagnosis and sex"
 )   
  


```




# Risk of readmission --

## Cause-specific hospitalisation

### Heart failure

**Steps involved in manipulation**

1.  Import HF cases and exclude 

  (a) **Outpatients:** We are only concerned about inpatient
  (b) **First fatal events:** This analysis only involves participants with **non-fatal** first events
  (c) **Duplicated non-fatal events:** The aim is to tag events **for the same participant** from 
      multiple sources that were reported **on the same day** as duplicates and delete them. 
      
      Only one event will be used for the analysis 


2.  Events occurring after the first were coded as **2**. **1** indicates the first event (earliest event)

    Define recurrence as events occurring within the first 28 days of
    diagnosis.
    

5.  Further manipulation to convert the dataset from long to wide 
    (to use source of reporting as columns) to work with. 
    - Replace NA with 0 (no event was report from this source)

6.  Create new headings for the different event sources to indicate
    whether an event was reported from that source (**1**) or not
    (**0**).

7.  Drop events occurring after the first **recurrent** event by selecting
    the earliest event. The earliest recurrent event is consider the first recurrent event 

8.  Join (by CSID) the resulting event dataset with the dataset for HF
    containing other covariates.

9.  For those (CSID) with more than one event, we will exclude the first event
    - only the recurrent event will be used  (duplicates)
    - filter out the first event (n_event == 1 == "First event")

10. Define follow-up time for analysis and drop deaths (from any cause)
    that occurred on the same day as first event

11. Run competing risk analysis using the CumIncidence function


**Event ID**

1. "CKB0080" HF 
2. "CKB0012" PHD

 **Note:** 114 inpatient records of HF are present in the detailed event dataset
 but not the first events only dataset `length(setdiff(hf_events$csid, data_hf$csid))`


```{r Manipulating events for competing risk analysis}

endpoint_events <- read_csv("K:/kadoorie/Staff_Folders/Valirien/DAR-2022-00245-V1 - Copy/event_endpoints.csv", col_types = cols())

hf_events <- endpoint_events %>% filter(epid == "CKB0080", type != "hiop")
temp_df   <- hf_events[hf_events$csid %in% data_hf$csid, ]  


temp_df <- temp_df %>% 
             inner_join(data_hf %>% select(csid, HF_combined_datedeveloped)) %>%  
             dplyr::mutate(datedeveloped = as.Date(datedeveloped), 
                           HF_combined_datedeveloped = as.Date(HF_combined_datedeveloped)) %>% 

             dplyr::group_by(csid) %>% 
                         filter(!(type %in% c("da", "du") & datedeveloped == min(HF_combined_datedeveloped))) %>% ungroup()


# Remove remove duplicated events occurring on the same day -- 

df_dup     <- duplicated(temp_df[ , c("csid", "datedeveloped")])
df_dedup   <- temp_df[!df_dup, ]   


# Define first and recurrent events 
df_cmprisk <- df_dedup %>%  dplyr::group_by(csid) %>% 
                            dplyr::mutate (
                                    first.event = ifelse(datedeveloped == min(HF_combined_datedeveloped), 1, 2),  
                                    after_28d   = HF_combined_datedeveloped + 28, 
                                    recur.event = case_when(datedeveloped > after_28d ~ "Recurrence", TRUE ~ "No recurrence")) %>% 
                            dplyr::arrange(csid) %>% 
                            select(c(csid, type, datedeveloped, first.event, recur.event)) %>%
                            ungroup()


df_cmprisk_wider <- df_cmprisk %>% 
                         pivot_wider(names_from  = type, 
                                     values_from = first.event, 
                                     values_fill = 0)                



#Create new events column to indicate whether an event occurred (1) not not (0) -- 

col_headers <- names(df_cmprisk_wider)[-c(1:3)]

for (c in seq_along(col_headers)) {
  
  new_col_name <- paste0(col_headers[[c]], "_ep", sep = "")
  df_cmprisk_wider[ ,new_col_name] <- ifelse(df_cmprisk_wider[[col_headers[c]]] > 0, 1, 0)    
  
}
      
 
df_cmprisk_wider <- df_cmprisk_wider %>%
  
                          #Capture the number of events per participant
                          dplyr::arrange(csid, datedeveloped) %>%
                          dplyr::group_by(csid) %>% 
                          dplyr::mutate(n_event = 1:n(), 
                                        n_event_cat = factor(ifelse(n_event > 3, "3+", n_event))) %>% 
  
                          ungroup()  
           
# df_cmprisk_wider %>% ####
#                 group_split(csid) %>%
#                 map_dfr(~ .x %>% filter(n_event >= max(n_event))) %>%
#                 {table(.$n_event_cat)}

#    1    2    3   3+ 
# 4821  912  274  310 #####
  
# Controlled filtering 
# Split every events from each participant into recurrence or not
# For no recurrence group (select the earliest event == first event)
# For recurrence group, select the the earliest event == first recurrent event 

df_cmprisk_wider <- df_cmprisk_wider %>% 
                          group_split(csid, recur.event) %>%
                          map_dfr( ~filter(.x, datedeveloped <= min(datedeveloped))) %>% 
                          select(csid, datedeveloped, recur.event, n_event, da_ep) %>% 
  
                          # Recode n_event to facilitate manipulation
                          dplyr::group_by(csid) %>% 
                          dplyr::mutate(n_event = 1:n()) %>%  
                          ungroup()


df_cmrk <- df_cmprisk_wider %>% 
                  dplyr::group_by(csid) %>%
                  inner_join(data_hf, by= "csid") %>% ungroup()  %>% 

                  select(csid:da_ep, 
                         
                         censoring_date, censoring_reason, 
                         copd, HF_combined_ep, HF_combined_datedeveloped, 
                         
                         age_diag65, age_diag_merge, sex, area, region, edu3, 
                         smoking_status, ever_reg_smoker, alcohol_recode, current_drinkers, HTN, bmi_cat, 
                         diabetes, develop_IHD, develop_copd, stroke_tia, co_hf_phd) %>%  

                  dplyr::mutate(dupl_csid = duplicated(.[ , "csid"]), 
                                
                                #define outcome status 
                                status = factor(ifelse(n_event == 2 & da_ep == 0,  2,                          # 2: "recurrence"
                                                ifelse(n_event == 2 & da_ep == 1,  1,                          # 1: "death"
                                                ifelse(n_event == 1 & censoring_reason != "Dead", 0,           # 0: "censored"
                                                ifelse(n_event == 1 & censoring_reason == "Dead", 1, NA)))))
                                ) %>% 

                  relocate(status, .after = censoring_reason)



# Drop first event for those with duplicate events

dupl_csid <- df_cmrk %>% filter(dupl_csid == TRUE) %>% pull(csid) 
df_cmrk   <- df_cmrk[!(df_cmrk$csid %in% dupl_csid & df_cmrk$n_event == 1), ]


# Define follow-up time for analysis 
df_cmrk_hf <- 
  
  df_cmrk %>% 
  dplyr::mutate(
    
    futime = ifelse(status == 2, 
                    interval(HF_combined_datedeveloped, datedeveloped)/dyears(1),
                    interval(HF_combined_datedeveloped, censoring_date)/dyears(1)), 
                                    
    futime_day = ifelse(status == 2, 
                        interval(HF_combined_datedeveloped, datedeveloped)/ddays(1),
                        interval(HF_combined_datedeveloped, censoring_date)/ddays(1))
    ) %>% 
  
  relocate(futime,futime_day, .after = status)


## Drop deaths (from any cause) that occurred on the same day as first event 
df_cmrk_hf <- df_cmrk_hf %>% filter(!(futime_day == 0 & status == 1))

```


```{r Fit univariate competing risk model}

# Running the competing risk analysis ####

source("J:/DPhil/First year/HF prognosis/Data analysis/CumIncidence.R")

fit_cmrk_est = with (df_cmrk_hf, CumIncidence (futime, 
                                               status, 1, 
                                               cencode = 0, 
                                               xlab = "Years", 
                                               t=seq(0, 9, 1/365)))

fit_cmrk_ci  = with (df_cmrk_hf, CumIncidence (futime, 
                                               status, 1, 
                                               cencode = 0, 
                                               xlab = "Years", 
                                               t=seq(0, 9, 1), level = 0.95))


fit_surv <- list(length = 2)

for (i in 1:2) {
 fit_surv[[i]] <- survfit(Surv(futime, status == i) ~ 1, data = df_cmrk_hf)
 fit_surv[[i]] <- summary(fit_surv[[i]], times = 0:9) 
}



# Create a matrix of CIF estimate and time for plotting line graph 
df_cif_line_hf <- as.data.frame(t(rbind(time = seq(0, 9, 1/365), 
                                        cif = fit_cmrk_est$est[2, ]))) %>% dplyr::mutate(disease = "hf")

df_ci_hf <- as.data.frame(cbind(time = 0:9, 
                             t(fit_cmrk_ci$ci[, , 2 ]),
                             cif = fit_cmrk_ci$est[2, ],
                             n.event.death = fit_surv[[1]]$n.event, 
                             n.risk.death  = fit_surv[[1]]$n.risk,
                             n.event.recur = fit_surv[[2]]$n.event, 
                             n.risk.recur  = fit_surv[[2]]$n.risk)) %>%  
  
            dplyr::mutate(disease = "hf", 
                          cif_95ci = paste(round(cif*100), "%", " (", 
                                           round(lower*100), " - ", 
                                           round(upper*100), ")", sep = ""))


```



### Pulmonary heart disease


```{r Data manipulation}

phd_events <- endpoint_events %>% filter(epid == "CKB0012", type != "hiop")   
temp_df    <- phd_events[phd_events$csid %in% data_phd$csid, ]    


temp_df    <- temp_df %>% 
                inner_join(data_phd %>% select(csid, PHD_combined_datedeveloped)) %>%  

                dplyr::mutate(
                        datedeveloped = as.Date(datedeveloped), 
                        PHD_combined_datedeveloped = as.Date(PHD_combined_datedeveloped)) %>% 

                dplyr::group_by(csid) %>% 
                           filter(!(type %in% c("da", "du") & datedeveloped == min(PHD_combined_datedeveloped))) %>% ungroup()


# Remove remove duplicated events occurring on the same day --------------------------------------------------------------------

df_dup     <- duplicated(temp_df[ , c("csid", "datedeveloped")])
df_dedup   <- temp_df[!df_dup, ]   


# Define first and recurrent events 
df_cmprisk <- df_dedup %>%  dplyr::group_by(csid) %>% 
                            dplyr::mutate (first.event = ifelse(datedeveloped == min(PHD_combined_datedeveloped), 1, 2), 
                                           
                                           after_28d   = PHD_combined_datedeveloped + 28, 
                               
                                           recur.event = case_when(datedeveloped > after_28d ~ "Recurrence", 
                                                                                     TRUE ~ "No recurrence")) %>% 
                            dplyr::arrange(csid) %>% 
                            select(c(csid, type, datedeveloped, first.event, recur.event)) %>%
                            ungroup()


df_cmprisk_wider <- df_cmprisk %>% 
                         pivot_wider(names_from  = type, 
                                     values_from = first.event, 
                                     values_fill = 0)                


#Create new events column ------------------------------------------------------------------------------------------------------

col_headers <- names(df_cmprisk_wider)[-c(1:3)]

for (c in seq_along(col_headers)) {
  
    new_col_name <- paste0(col_headers[[c]], "_ep", sep = "")
    df_cmprisk_wider[ ,new_col_name] <- ifelse(df_cmprisk_wider[[col_headers[c]]] > 0, 1, 0)    
  
}
        

df_cmprisk_wider <- df_cmprisk_wider %>%
  
                          #Capture the number of events per participant
                          dplyr::arrange(csid, datedeveloped) %>%
                          dplyr::group_by(csid) %>% 
                          dplyr::mutate(n_event = 1:n(), 
                                        n_event_cat = factor(ifelse(n_event > 3, "3+", n_event))) %>% 
  
                          ungroup()  

#  df_cmprisk_wider %>% 
#                 group_split(csid) %>%
#                 map_dfr(~ .x %>% filter(n_event >= max(n_event))) %>%
#                 {table(.$n_event_cat)}
# 
# 
#    1    2    3   3+ 
# 1705  637  249  330                          
 
 
# Controlled filtering by recurrence status---------------------------------------------------------------------------------------
 
df_cmprisk_wider <- df_cmprisk_wider %>% 
                          group_split(csid, recur.event) %>%
  
                          map_dfr( ~ .x %>% 
                                        filter(datedeveloped <= min(datedeveloped))) %>% 
  
                          select(csid, datedeveloped, recur.event, n_event, da_ep) %>% 
  
                          # Recode n_event to facilitate manipulation
                          dplyr::group_by(csid) %>% 
                          dplyr::mutate(n_event = 1:n()) %>%  ungroup()


df_cmrk <- df_cmprisk_wider %>% 
                  dplyr::group_by(csid) %>%
                  inner_join(data_phd, by= "csid") %>% ungroup()  %>% 

                  select(csid:da_ep, 
                         
                         censoring_date, censoring_reason, 
                         copd, PHD_combined_ep, PHD_combined_datedeveloped, 
                         
                         age_diag65, age_diag_merge, sex, area, region, edu3, 
                         smoking_status, ever_reg_smoker, alcohol_recode, current_drinkers, HTN, bmi_cat, 
                         diabetes, develop_IHD, develop_copd, stroke_tia, co_hf_phd
                         ) %>%  

                  dplyr::mutate(dupl_csid = duplicated(.[ , "csid"]), 
                                
                                #define outcome status 
                                status = factor(ifelse(n_event == 2 & da_ep == 0,  2,                          # 2: "recurrence"
                                                ifelse(n_event == 2 & da_ep == 1,  1,                          # 1: "death"
                                                ifelse(n_event == 1 & censoring_reason != "Dead", 0,           # 0: "censored"
                                                ifelse(n_event == 1 & censoring_reason == "Dead", 1, NA)))))
                                ) %>% 

                  relocate(status, .after = censoring_reason)


# Drop first event for those with duplicate events

dupl_csid <- df_cmrk %>% filter(dupl_csid == TRUE) %>% pull(csid) 

df_cmrk   <- df_cmrk[!(df_cmrk$csid %in% dupl_csid & df_cmrk$n_event == 1), ]


# Define follow-up time for analysis 
df_cmrk_phd <- df_cmrk %>% dplyr::mutate(futime = ifelse(status == 2, 
                                                         interval(PHD_combined_datedeveloped, datedeveloped)/dyears(1),
                                                         interval(PHD_combined_datedeveloped, censoring_date)/dyears(1)), 
                                        
                                        futime_day = ifelse(status == 2, 
                                                         interval(PHD_combined_datedeveloped, datedeveloped)/ddays(1),
                                                         interval(PHD_combined_datedeveloped, censoring_date)/ddays(1))
                                        ) %>% 
  
                              relocate(futime, futime_day, .after = status)

## Drop deaths (from any cause) that occurred on the same day as first event 
df_cmrk_phd <- df_cmrk_phd %>% filter(!(futime_day == 0 & status == 1))

```


```{r fit univariate competing risk model}

# Running competing risk analysis 

source("J:/DPhil/First year/HF prognosis/Data analysis/CumIncidence.R")

fit_cmrk_est = with (df_cmrk_phd, 
                     CumIncidence (futime, 
                                   status, 1, 
                                   cencode = 0, 
                                   xlab = "Years", 
                                   t=seq(0, 9, 1/365)))


fit_cmrk_ci = with (df_cmrk_phd, 
                    CumIncidence (futime, 
                                  status, 1, 
                                  cencode = 0, 
                                  xlab = "Years", 
                                  t=seq(0, 9, 1), 
                                  level = 0.95))


fit_surv <- list(length = 2)

for (i in 1:2) {
 fit_surv[[i]] <- survfit(Surv(futime, status == i) ~ 1, data = df_cmrk_phd)
 fit_surv[[i]] <- summary(fit_surv[[i]], times = 0:9) 
}



# Create a matrix of CIF estimate and time for plotting line graph 
df_cif_line_phd <- as.data.frame(t(rbind(time = seq(0, 9, 1/365), 
                                         cif = fit_cmrk_est$est[2, ])
                                   )
                                 ) %>% dplyr::mutate(disease = "phd")

df_ci_phd       <- as.data.frame(cbind(time = 0:9, 
                                       t(fit_cmrk_ci$ci[, , 2 ]),
                                       cif = fit_cmrk_ci$est[2, ],
                                       n.event.death = fit_surv[[1]]$n.event, 
                                       n.risk.death  = fit_surv[[1]]$n.risk,
                                       n.event.recur = fit_surv[[2]]$n.event, 
                                       n.risk.recur  = fit_surv[[2]]$n.risk)) %>% 
  
                   dplyr::mutate(disease = "phd", 
                                 cif_95ci = paste(round(cif*100), "%", " (", round(lower*100), " - ", round(upper*100), ")", sep = ""))

```


### Merging HF and PHD datasets

```{r}

# merge HF and PHD datasets
df_cif_line <- rbind(df_cif_line_hf, df_cif_line_phd) %>% dplyr::mutate(disease = factor(disease))
df_ci       <- rbind(df_ci_hf, df_ci_phd) %>% dplyr::mutate(disease = factor(disease))

df_ci_list  <- list(length = length(levels(df_ci$disease)))



for (i in seq_along(levels(df_ci$disease))) {
  
  df_ci_list[[i]] <- 
        df_ci %>% 
        filter(disease == levels(df_ci$disease)[i]) %>% 
        select(time, 
               n.risk  = n.risk.recur, 
               n.recur = n.event.recur, 
               n.death = n.event.death, 
               cif_95ci, 
               disease)

  
  rownames(df_ci_list[[i]]) <- df_ci_list[[i]]$time
  df_ci_list[[i]]           <- t(df_ci_list[[i]])

}

# 
# write.csv(df_ci_list[[1]], "recurrence_HF.csv")
# write.csv(df_ci_list[[2]], "recurrence_PHD.csv")

```


```{r}


df_cif_line <- list(df_cif_line_hf, df_cif_line_phd) 
df_ci       <- list(df_ci_hf, df_ci_phd)


## Calculate censored events 
#  (n.risk in previous time - [current n.risk + death + recurrence])

require(data.table)

df_ci_censored <- 
  map(.x = df_ci, 
      ~mutate(
          .x, 
          n.censor.recur = lag(n.risk.recur) - (n.risk.recur + n.event.recur + n.event.death),
          # replace NA in censored with 0
          n.censor.recur = ifelse(is.na(n.censor.recur), 0, n.censor.recur))
      )


# Transpose the df_ci for reporting

df_ci_report <- 
  
  map(
    .x = df_ci_censored, 
    ~select(
      .x, 
      time, 
      n.risk  = n.risk.recur, 
      n.recur = n.event.recur, 
      n.death = n.event.death,
      cif_95ci, 
      disease, 
      n.censor.recur) %>% t(.)
    )




# write.csv(df_ci_report[[1]], "recurrence_HF.csv")
# write.csv(df_ci_report[[2]], "recurrence_PHD.csv")

```



### Age-specific 5-year recurrence rate

```{r compute age-specific 5-year recurrence}

#Data 
data       <- list(df_cmrk_hf, df_cmrk_phd)
data_label <- c('hf', 'phd')


#Merged age categories to have sufficient numbers 

data <- 
  
  map(
    .x = data,
    ~mutate(
      .x, 
      age_merged3 = factor(
                       case_when(
                           age_diag_merge == "70-79" | age_diag_merge == "80-89" ~  "70+",
                           age_diag_merge == "30-59" ~ "30-59",
                           age_diag_merge == "60-69" ~ "60-69"),
                       levels = c("30-59", "60-69", "70+"))
      )
    )



strata <- "age_merged3"

temp_surv_0_9_df_list <-  list(length = length(strata)) #To hold datasets temporarily 
surv_0_9_df_list      <-  list(length = length(data))   #To hold datasets


for (df in seq_along(data)) {
  
  data_temp <- data[[df]]
  
        
      for (v in seq_along(strata)) { 
                
              group <- data_temp[[strata[[v]]]] 
                         
              fit_cmrk_sg_ci = with (data_temp, 
                                     CumIncidence(futime, 
                                                  status, 
                                                  group, 
                                                  cencode = 0, 
                                                  xlab = "Years", 
                                                  t=seq(0, 5, 1), 
                                                  level = 0.95))
              
              fit_cmrk_sg_est = with (data_temp, 
                                     CumIncidence (futime, 
                                                   status, 
                                                   group, 
                                                   cencode = 0, 
                                                   xlab = "Years",
                                                   t=seq(0, 5, 1/365)))
              
              sub_est <- (nrow(fit_cmrk_sg_est$est)-length(levels(factor(group)))+1):nrow(fit_cmrk_sg_est$est)
              
         
# Run "ordinary" survival analysis to obtain number of death, recurrence, and censored
      fit_surv <- list(length = 2)
      
      for (i in 1:2) {
           fit_surv[[i]] <- survfit(Surv(futime, status == i) ~ group, data = data_temp)
           fit_surv[[i]] <- summary(fit_surv[[i]], times = 0:5) 
      }


#Extract confidence intervals 
est_rbind <- list(length = length(sub_est))
ci_rbind  <- list(length = length(sub_est))

      for (i in seq_along(sub_est)) {
        
              # Extract estimates
              df_temp           <- fit_cmrk_sg_ci$est[sub_est[[i]], ]
              df_temp           <- as.data.frame(df_temp)
              df_temp$strata    <- levels(factor(group))[i]
              est_rbind[[i]]    <- df_temp
              
              # Extract confidence intervals 
              df_temp_ci        <- t(fit_cmrk_sg_ci$ci[, , sub_est[[i]]]) 
              df_temp_ci        <- as.data.frame(df_temp_ci)
              df_temp_ci$strata <- levels(factor(group))[i]
              ci_rbind[[i]]     <- df_temp_ci
        
      } 


df_ci_short <- bind_rows(ci_rbind) %>% 
                   dplyr::mutate(time = rep(seq(0, 5, 1), length(sub_est))) %>% 
                   `row.names<-` (NULL)


df_est <- bind_rows(est_rbind) %>% 
               dplyr::mutate(time = rep(seq(0, 5, 1), length(sub_est))) %>% 
               `row.names<-`(NULL)
               

df_est_ci <- inner_join(df_est, df_ci_short, by = c("time", "strata")) %>% rename("cif" = "df_temp")



df_ci_short <- 
  
  as.data.frame(
     cbind(df_est_ci,
           n.event.death  = fit_surv[[1]]$n.event, 
           n.risk.death   = fit_surv[[1]]$n.risk,
           n.censor.death = fit_surv[[1]]$n.censor,
           n.event.recur  = fit_surv[[2]]$n.event, 
           n.risk.recur   = fit_surv[[2]]$n.risk,  
           n.censor.recur = fit_surv[[2]]$n.censor)) %>% 
  
     dplyr::mutate(cif_95ci = paste0(round(cif*100), "%", " (", round(lower*100), " - ", round(upper*100), ")"))

# Capture datasets for eact strata 
temp_surv_0_9_df_list[[v]] <-  df_ci_short 


#End of for loop

        }
  
  #Capture datasets 
  surv_0_9_df <- bind_rows(temp_surv_0_9_df_list) %>% dplyr::mutate(disease = data_label[df])
  surv_0_9_df_list[[df]] <- surv_0_9_df
  
  
  rm(data_temp)
   
  #End of For loop
}



#Run age-specific analysis

df_age_cif <- 
  
  map(.x = surv_0_9_df_list, 
      ~filter(.x, time == 5) %>%
        dplyr::mutate(se = (cif - lower)/1.96, var = se^2)) %>% 
  
  map(~rma(yi=cif, vi=var, method = "FE", data = .x)) %>%
  map( 
    ~tibble(cif     = .x$b[1,1],
            lci     = .x$ci.lb,
            uci     = .x$ci.ub,
            est_ci  = paste0(round(cif*100), " (", round(lci*100), " - ", round(uci*100), "), %"), 
            outcome = c("hf", "phd")[[df]])
    )


```



### Plotting recurrent hospitalisation

```{r}

 
# Labels-- 
font_style    <- ""

x_risk_title  = -3
y_risk_title  = -0.25
x_event_text  = 0.2

plot.title    <- c("C. Heart failure\n", "D. Pulmonary heart disease\n")
y_label       <- c("Cumulative risk, % (95% CI)", "")


# Wrangling --- 
lab_risk <- map(.x = df_ci_censored, 
                ~dplyr::mutate(.x, risk_censor = paste0(n.risk.recur, "\n", n.censor.recur)) %>% 
                 dplyr::select(time, risk_censor, disease)
                )

surv_df_1_9 <- map(.x = df_ci_censored, ~filter(.x, time > 0 & time <= 9)) 
surv_all_df <- map(.x = df_cif_line, ~filter(.x, time < 9.1))


# Visualisation --- 
plot_list_cif <- 
  
  map2(
    .x = surv_all_df, 
    .y = seq_along(surv_all_df), 
    
    ~ggplot (data = .x, aes (x = time,  y=cif)) +
      
      geom_step(linewidth = 0.7) +
      geom_point(
           aes(x = time, y = cif), 
           shape = 15, 
           size  = 1, 
           data  = surv_df_1_9[[.y]])  +
      
      geom_errorbar(
          aes(x = time, y = cif, ymin = lower, ymax = upper),
          width = 0.1, 
          linewidth = 0.7, 
          data = surv_df_1_9[[.y]]) +

      #Setting theme 
      theme_void() + 
      
      #Theme text 
      theme(text         = element_text(family = font_style),
            axis.text.x  = element_text(size = 13, vjust = 0),
            axis.text.y  = element_text(size = 13, hjust = 1), 
            axis.title.x = element_text(size = 14, vjust = -1), 
            axis.title.y = element_text(size = 14, angle = 90)) +
    
      theme(legend.position   = "none",  
            axis.line         = element_line(colour = "black", size = 0.6, linetype = "solid"), 
            axis.ticks        = element_line(size = 0.6),
            axis.ticks.length = unit(0.25, "cm"), 
            plot.margin       = list(unit(c(2, 0.5, 2, 1.5), "cm"), unit(c(2, 1, 2, 0.5), "cm"))[[.y]]) +  
      
      # Scales
      coord_cartesian(xlim = c(0, 9), ylim = c(0, 1), clip = "off") +
      scale_x_continuous(expand = c(0, 0), breaks = c(0:9)) +  
      scale_y_continuous(expand = c(0, 0), breaks = seq(0, 1, 0.2), labels = seq(0, 100, 20)) + 
      
  #Number at risk 
  geom_text(x = 0.3, y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[1]],  size = 3.5, family = font_style, color = "black") +
  geom_text(x = 3,   y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[4]],  size = 3.5, family = font_style, color = "black") +
  geom_text(x = 5,   y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[6]],  size = 3.5, family = font_style, color = "black") +
  geom_text(x = 7,   y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[8]],  size = 3.5, family = font_style, color = "black") +
  geom_text(x = 9,   y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[10]], size = 3.5, family = font_style, color = "black") +
 
  
  # Plot heading --
  geom_text(
    x      = x_risk_title, 
    y      = 1.15, 
    label  = c("Recurrent hospitalisation risk", "")[.y],  
    size   = 4.5, 
    fontface = 2,
    family = font_style, 
    color  = "black", 
    hjust  = 0) +
    
  # Panel title 
  geom_text(
    x     = -0.5,
    y     = 1.02,
    label = plot.title[[.y]],
    size  = 4.5, 
    family = font_style, 
    color = "black",
    hjust = 0, 
    fontface = 2) +
 
  # Cumulative event rate
  geom_text(
    x        = x_event_text, 
    y        = 0.95,    
    label    = paste0("5-year cumulative risk (95% CI), %", "\n", df_age_cif[[.y]]$est_ci), 
    size     = 4, 
    family   = font_style, 
    color    = "black", 
    hjust    = 0) +
   
  # Risk/Censored heading 
  geom_text(
    x      = x_risk_title, 
    y      = -0.17, 
    label  = c("Cause-specific recurrence", "")[.y],  
    size   = 3.5, 
    fontface = 2,
    family = font_style, 
    color  = "black", 
    hjust  = 0) +
  
  # Risk/Censored
  geom_text(
    x      = x_risk_title, 
    y      = y_risk_title, 
    label  = c(paste0("At risk(n):  ", "\n", "Censored(n):  "), "")[.y],  
    size   = 3.5, 
    family = font_style, 
    lineheight = 1,
    color  = "black", 
    hjust  = 0) +  
    
  ylab(y_label[[.y]]) + 
  xlab("Time since diagnosis (years)")
  
)

 
 
```


### Combine mortality and recurrence plots --

```{r}

plot <- ggarrange (plot_list_cmr[[1]], 
                   plot_list_cmr[[2]],
                   plot_list_cif[[1]], 
                   plot_list_cif[[2]],
                   ncol       = 2,
                   nrow       = 2,
                   widths     = c(1, 1), 
                   heights    = c(1.1, 1.1))


png("Figure 4 - mortality and Recurrent hospitalisation2.png", 
     units     = "in", 
     width     = 8.3, 
     height    = 11.7, 
     res       = 300,
     pointsize = 2,
     bg        = "white")
 
 plot 
 
 dev.off()
 

```




```{r subgroup Competing risk analysis}


#Variables for subgroup
strata <- c("age_diag65", "sex", "area")


#Data 
data       <- list(df_cmrk_hf, df_cmrk_phd)
data_label <- c('hf', 'phd')


#To hold datasets temporarily 
temp_surv_all_df_list <-  list(length = length(strata))
temp_surv_0_9_df_list <-  list(length = length(strata))

#To hold datasets
surv_all_df_list <-  list(length = length(data))
surv_0_9_df_list <-  list(length = length(data))


for (df in seq_along(data)) {
  
  
  data_temp <- data[[df]]
  
  
        for (v in seq_along(strata)) { 
          
            group       <- data_temp[[strata[[v]]]] 
            strata_name <- strata[[v]]
                      
            fit_cmrk_sg_est = with (data_temp, 
                                     CumIncidence (futime, 
                                                   status, 
                                                   group, 
                                                   cencode = 0, 
                                                   xlab = "Years",
                                                   t=seq(0, 6, 1/365)))
            
            fit_cmrk_sg_ci = with (data_temp, 
                                     CumIncidence (futime, 
                                                   status, 
                                                   group, 
                                                   cencode = 0, 
                                                   xlab = "Years", 
                                                   t=seq(0, 6, 1), 
                                                   level = 0.95))

# Run "ordinary" survival analysis to obtain number of death, recurrence, and censored
fit_surv <- list(length = 2) 

for (i in 1:2) {
     fit_surv[[i]] <- survfit(Surv(futime, status == i) ~ group, data = data_temp)
     fit_surv[[i]] <- summary(fit_surv[[i]], times = 0:6) 
}

sub_est <- (nrow(fit_cmrk_sg_est$est)-length(levels(factor(group)))+1):nrow(fit_cmrk_sg_est$est)

  
# Create a matrix of CIF estimate and time for plotting line graph 

# Rowbind estimates
est_rbind <- list(length = length(sub_est))

for (i in seq_along(sub_est)) {
  
    df_temp <- fit_cmrk_sg_est$est[sub_est[[i]], ]
    df_temp <- as.data.frame(df_temp)
    
    df_temp$strata <- levels(factor(group))[i]
    est_rbind[[i]] <- df_temp
  
}

df_bind <- map_dfr(
            .x = est_rbind, 
             ~rbind(.x)) %>% 
                dplyr::rename("cif" = "df_temp") %>% 
                dplyr::mutate(exposure = strata_name)

rownames(df_bind) <- NULL

time = rep(seq(0, 6, 1/365), length(sub_est))


df_cif_long <- as.data.frame(cbind(time, df_bind))                              # Dataframe for line plot 


#Extract confidence intervals 
ci_rbind <- list(length  = length(sub_est))

for (i in seq_along(sub_est)) {
  
        # Extract estimates
        df_temp <- fit_cmrk_sg_ci$est[sub_est[[i]], ]
        df_temp <- as.data.frame(df_temp)
        df_temp$strata <- levels(factor(group))[i]
        est_rbind[[i]] <- df_temp
        
        # Extract confidence intervals 
        df_temp_ci <- t(fit_cmrk_sg_ci$ci[, , sub_est[[i]]])
        df_temp_ci <- as.data.frame(df_temp_ci)
        ci_rbind[[i]] <- df_temp_ci
  
}

df_est_bind <- map_dfr(
  .x = est_rbind, 
  ~rbind(.x)) %>%
      dplyr::rename("cif" = "df_temp") %>%
      dplyr::mutate(exposure = strata_name)

df_ci_bind  <- map_dfr(.x = ci_rbind, ~rbind(.x)) 

time = rep(seq(0, 6, 1), length(sub_est))

df_ci_short <- as.data.frame(cbind(time, df_est_bind, df_ci_bind))
rownames(df_ci_short) <- NULL


df_ci_short <- as.data.frame(cbind(
                               df_ci_short,
                               n.event.death  = fit_surv[[1]]$n.event, 
                               n.risk.death   = fit_surv[[1]]$n.risk,
                               n.censor.death = fit_surv[[1]]$n.censor,
                               n.event.recur  = fit_surv[[2]]$n.event, 
                               n.risk.recur   = fit_surv[[2]]$n.risk, 
                               n.censor.recur = fit_surv[[2]]$n.censor)) %>% 

             dplyr::mutate(cif_95ci = paste(round(cif*100), "%", " (", 
                                            round(lower*100), " - ", round(upper*100), ")", sep = ""))

# Capture datasets for eact strata 
temp_surv_all_df_list[[v]] <-  df_cif_long
temp_surv_0_9_df_list[[v]] <-  df_ci_short


  #End of for loop

        }
  
  #Capture datasets 
  surv_all_df <- map_dfr(temp_surv_all_df_list, ~rbind(.x)) %>% dplyr::mutate(disease = data_label[df])
  surv_0_9_df <- map_dfr(temp_surv_0_9_df_list, ~rbind(.x)) %>% dplyr::mutate(disease = data_label[df])
  
   
  surv_all_df_list[[df]] <- surv_all_df
  surv_0_9_df_list[[df]] <- surv_0_9_df
  
  
  #End of For loop
}

```


###Wrangling data before plotting 
```{r}

## Overall --

surv_all_df_list
surv_0_9_df_list 


# Obtain datasets

# Split datasets and prepare for plotting --- 

# Convert exposure as factor and maintain order of exposures before splitting
order_exposure <- map(.x = surv_0_9_df_list, ~unique(.x$exposure))
strata_levels  <- map(.x = surv_0_9_df_list, ~unique(.x$strata))



surv_0_9_df_list <- 
  
  map2(
    .x = surv_0_9_df_list,
    .y = seq_along(surv_0_9_df_list), 
                          
    ~mutate(
      .x, 
      exposure = factor(exposure, levels = order_exposure[[.y]]), 
      strata   = factor(strata, levels = strata_levels[[.y]]))
    )

surv_all_df_list <- 
  
  map2(
    .x = surv_all_df_list, 
    .y = seq_along(surv_all_df_list), 
                          
    ~mutate(
      .x, 
      exposure = factor(exposure, levels = order_exposure[[.y]]), 
      strata   = factor(strata, levels = strata_levels[[.y]]))
    )


# Split data and flatten remove hierarchical structure 
df_sub_all_split  <- map(.x = surv_all_df_list, ~dplyr::group_by(.x, exposure) %>% group_split()) %>% flatten() 
df_sub_desc_split <- map(.x = surv_0_9_df_list, ~dplyr::group_by(.x, exposure) %>% group_split()) %>% flatten()

df_ci   <- map(.x = df_sub_desc_split, ~dplyr::filter(.x, time > 0)) 
recur5  <- map(.x = df_sub_desc_split, ~dplyr::filter(.x, time == 5) %>% pull(cif_95ci)) 



```


### Make plots for subgroups 
```{r}
# Create plot for subgroups 

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/my_gg_theme_text.R")

strata_label <- c(
  list("Age at diagnosis, years", "Sex", "Area"), 
  rep(list(""), 3)) 

x_label <- c(
  rep(list(""), 3), 
  rep(list("Time since first admission (years)"), 3))

y_label <- rep(list("Cumulative risk, % (95% CI)", "", ""), 2)

y_tick_label <- rep(list(seq(0, 100, 20), NULL, NULL), 2)

  
#Turn off legend for bottom plots ---
leg_position  <- c(list(c(0.19, 0.95), c(0.15, 0.95), c(0.15, 0.95)), rep(list("none"), 3))

# cust_margins  <- list(c(2, 1, 2, 1.5), c(2, 1, 2, 1.5), c(2, 1, 2, 1.5), 
#                       c(2, 1, 2, 1.5), c(2, 1, 2, 1.5), c(2, 1, 2, 1.5))


# Get group levels ---
group_levels <- map(.x = surv_0_9_df_list, 
                    ~group_by(.x, exposure) %>% group_split() %>% 
                      map(
                        ~pull(.x, strata) %>% 
                          as.character(.) %>% 
                          unique(.) %>% 
                          stringr::str_to_sentence(.) %>% 
                          paste0(., ":"))) 


# Number at risk ---

n_risk <- 
  map(
    .x = surv_0_9_df_list, 
    ~dplyr::group_by(.x, time) %>% 
     dplyr::summarise(num_risk = paste0(round(n.risk.recur), collapse = "\n")))

n_risk_size = 4
n_risk_title <- c(list("Number at risk"), rep(list(""), 5))

n_risk_body  <- list(pluck(group_levels[[1]], 1), 
                     pluck(group_levels[[1]], 2), 
                     pluck(group_levels[[1]], 3),
                     NULL, 
                     NULL, 
                     NULL)


data_label   <- list('Heart failure', "", "", 'Pulmonary heart disease', "", "")
font_style   <- ""


# Positioning text on plot 

x_risk_title = -1.7
y_risk_title =c(rep( -0.1, 3), rep(-0.135, 3))
y_decrement_risk = y_risk_title - 0.05

x_event_text = 0.1     

# Order of "y_decrement event: Main, group 1, group 2
y_event <- list(0.9, 0.9, 0.9, 0.2, 0.2, 0.2)


# Order of "y_decrement event: Main, group 1, group 2
y_decrement_event <- list(
                      c(0.95, 0.90, 0.85), 
                      c(0.95, 0.90, 0.85), 
                      c(0.95, 0.90, 0.85),
                      c(0.95, 0.90, 0.85), 
                      c(0.95, 0.90, 0.85), 
                      c(0.95, 0.90, 0.85))

y_event <- list(0.9, 0.9, 0.9, 0.2, 0.2, 0.2)

rm("strata") #Remove objects named strata to avoid conflicts. 



# Get number at risk -- 

# Make plots ---         
plot_list <- 
  
  map2(
    .x = df_sub_all_split,
    .y = seq_along(df_sub_all_split),
    
    ~ggplot(data = .x, mapping = aes(x=time, y=cif)) +
      
      geom_step(aes(linetype = strata), linewidth = 0.7) +
      
      geom_errorbar(
        data    = df_ci[[.y]], 
        mapping = aes(x = time, y = cif, ymin  = lower, ymax = upper, linetype = strata), 
        width   = 0.1, linewidth = 0.7) +
      
      geom_point(
       data    = df_ci[[.y]],
       mapping = aes(x = time, y = cif), 
       shape   = 15, 
       size    = 1) + 
                    
    #Setting theme --
  
    theme_void() + 
    
    theme(axis.text.x  = element_text(size = 13, vjust = 0),
          axis.text.y  = element_text(size = 13, hjust = 1), 
          axis.title.x = element_text(size = 14, vjust = -1), 
          axis.title.y = element_text(size = 14, angle = 90, vjust = 1.5)) +

    theme(legend.position   = leg_position[[.y]],  
          axis.line         = element_line(colour = "black", linewidth = 0.6, linetype = "solid"), 
          axis.ticks        = element_line(size = 0.6),
          axis.ticks.length = unit(0.25, "cm"), 
          plot.margin       = unit(c(2, 1, 2, 1.5), "cm")) + 

    guides(linetype = guide_legend(title       = "", 
                                   title.hjust = 0,
                                   label.hjust = 0,
                                   title.theme = element_text(size = 12, face = "bold"),   
                                   label.theme = element_text(size = 12))) + 
    
    # Modify axes--
    coord_cartesian(xlim = c(0, 6.0), ylim = c(0, 0.6), clip = "off") + 
    scale_x_continuous(
      expand = c(0, 0), 
      breaks = 0:6, 
      labels = c(rep(list(NULL), 3), rep(list(0:6), 3))[[.y]]) +  
      
    scale_y_continuous(
      expand = c(0, 0), 
      breaks = seq(0, 0.6, 0.1), 
      labels = rep(list(seq(0, 60, 10), NULL, NULL), 2)[[.y]]) + 
  
    # scale_color_manual(values = colour_values[[.y]], labels = group_levels[[.y]]) + 
     
    # Write number at risk (heading)
    geom_text(x        = c(-2.4, -1.65, -1.45, rep(x_risk_title, 3))[.y], 
              y        = -0.10, 
              label    = paste0(n_risk_title[[.y]], "\n", paste0(n_risk_body[[.y]], collapse = "\n")), 
              size     = n_risk_size, 
              color    = "black",
              hjust    = 0) + 

  
    # Number at risk --
    #Category 1
    geom_text(
      x = 0, 
      y = y_risk_title[.y], 
      size = n_risk_size, 
      family = font_style, 
      color = "black",
      label  = paste0(
                 "\n",  
                 paste0(df_sub_desc_split[[.y]][df_sub_desc_split[[.y]]$time == 0, ]$n.risk.recur, collapse = "\n"))) +
  
    geom_text(
      x = 2, 
      y = y_risk_title[.y], 
      size = n_risk_size, 
      family = font_style,
      color = "black",
      label  = paste0(
                  "\n",  
                  paste0(df_sub_desc_split[[.y]][df_sub_desc_split[[.y]]$time == 2, ]$n.risk.recur, collapse = "\n"))) +
  
    geom_text(
      x = 4, 
      y = y_risk_title[.y], 
      size = n_risk_size, 
      family = font_style,
      color = "black",
      label  = paste0(
                 "\n",  
                 paste0(df_sub_desc_split[[.y]][df_sub_desc_split[[.y]]$time == 4, ]$n.risk.recur, collapse = "\n"))) +
  
    geom_text(
      x = 6, 
      y = y_risk_title[.y], 
      size = n_risk_size, 
      family = font_style,
      color = "black",
      label  = paste0(
                "\n",  
                paste0(df_sub_desc_split[[.y]][df_sub_desc_split[[.y]]$time == 6, ]$n.risk.recur, collapse = "\n"))) +
   
  
    # CIF (95% CI) (main title)---
    # geom_text(
    #   x = x_event_text, 
    #   y = 0.95,
    #   size  = 4.5, 
    #   color = "black",  
    #   family = font_style, 
    #   hjust = 0, 
    #   fontface = 2,
    #   label = rep(list("Age-adjusted 5-year cumulative risk, % (95% CI)\n", "", ""), 2)[[.y]]) +
    
    # CIF (95% CI) (subtitle)
    # geom_text(
    #   x = x_event_text, 
    #   y = rep(c(0.83, 0.91, 0.91), 2)[.y], 
    #   size = 4.5, 
    #   family = font_style, 
    #   hjust = 0,
    #   color = "black",
    #   label  = paste0(group_levels[[.y]], ":", collapse = "\n"))  +
  
    # CIF (95% CI) (numbers)
    geom_text(
      x      = list(2.3, 1.9, 1.8, 0.14, 0.14, 0.14)[[.y]],
      y      = 0.55,
      size   = 3.8, 
      lineheight = 1.3, 
      hjust  = 0,
      color  = "black",
      label  = paste0(recur5[[.y]], collapse = "\n")) +
  
    # Plot subtitle
    geom_text(
      x        = -0.3, 
      y        = 0.64, 
      size     = 4.5,  
      hjust    = 0, 
      color    = "black",
      fontface = 2,
      label    = strata_label[[.y]]) +
    
    # Plot title
    geom_text(
      x     = -2.5,
      y     = c(0.70, 0, 0, 0.65, 0, 0)[.y],
      label = data_label[[.y]], 
      size  = 5.2, 
      color = "black",
      hjust = 0, 
      fontface = 2) +
                 
    ylab(y_label[[.y]]) +
    xlab(x_label[[.y]])
    )



 plot <- ggarrange (plot_list[[1]],
                    plot_list[[2]],
                    plot_list[[3]],
                    plot_list[[4]],
                    plot_list[[5]],
                    plot_list[[6]],
                    ncol = 3, 
                    nrow = 2,
                    widths  = rep(1, 6), 
                    heights = rep(1.5, 6))


 ckbplotr::save_figure(
   plot, 
   ext = c("png", "png"),
   pagedim = unit(c(15, 13), "in"),
   margin  = unit(c(
                2.5, 
                1, 
                2, 
                1.5), 
                units = "cm"),
   landscape = FALSE, 
   name = "Fig S5 Recurrence subgroup age, sex, area", 
   title.gpar  = list(fontsize = 16, fontface = "bold"),
   title = "Figure S5: Five-year cumulative risk of recurrent hospitalisation among survivors\nadmitted for heart failure and pulmonary heart disease by age, sex, and region",
   args = list(
            bg = "white", 
            pointsize = 6
            ),
   footer.gpar = list(fontsize = 13),
   footer.pos  = grid::unit.c(unit(1.9, "cm"), unit(1/2, "cm")),
   footer = "
   Cumulative risk curves were directly standardised by age at diagnosis, sex and area as appropriate. Death from causes other than heart failure
             or pulmonary heart disease were consider as competing events"
 )   



```



Request updated dataset for this. 



## 2. Risk of recurrence for any cause --



## Data manipulation: Heart failure

**Steps involved in manipulation**

1.  Filter participants with any events

2.  Match HF patients present in the any event dataset using the CSID.
    Filter out events occurring before first HF diagnosis to avoid
    negative follow up time.

3.  Drop outpatient events. We are only concerned about inpatient
    events. Drop all **fatal** first HF events (This analysis only
    involves participants with **non-fatal** first events)

4.  Aim:

    -   define events that occurred after the first event (`time.event`)
        and drop outpatient recurrent events
    -   For the purpose of this analysis, only consider one event per
        day. If two events occurred on the same day, consider only one
        event and drop the rest.

    Events occurring after the first were coded as **2**. **1**
    indicates the first event
    Define recurrence as events occurring AFTER the first 28 days of
    diagnosis.

    -   For **non-fatal recurrent events** we dropped
    -   Filter out recurrent non-fatal outpatient events (No need to
        worry about fatal events because they only occur once)
    -   Mark events **from the same participant** occurring on the same
        date as duplicated records and delete. Only one of the events
        will be used for analysis

5.  Further manipulation to convert the dataset from long to wide (to
    use source of reporting as columns) to work with. Replace NA with 0
    (no event was report from this source).

6.  Create new headings for the different data sources to indicate
    whether an event was reported from that source (**1**) or not
    (**0**).

7.  Drop events occurring after the first recurrent event by selecting
    the earliest event

8.  Join (by CSID) the resulting event dataset with the dataset for HF
    containing other covariates.

9.  For those (CSID) with more than one event (duplicates), filter out
    the first event (n_event == 1 == "First event")

10. Define follow-up time for analysis and drop deaths (from any cause)
    that occurred on the same day as first event

11. Run competing risk analysis using the CumIncidence function



```{r Manipulating events for competing risk analysis}

endpoint_events <- read_csv("K:/kadoorie/Staff_Folders/Valirien/DAR-2022-00245-V1 - Copy/event_endpoints.csv", col_types = cols())

#Steps 1-3
any_event <- endpoint_events %>% filter(epid == 25543)
rm("endpoint_events")

temp_df   <- any_event[any_event$csid %in% data_hf$csid, ]


temp_df <- temp_df %>% 
                   inner_join(data_hf %>% 
                                      select(csid, HF_combined_datedeveloped)) %>%  
  
                   dplyr::mutate(datedeveloped = as.Date(datedeveloped), 
                                 HF_combined_datedeveloped = as.Date(HF_combined_datedeveloped)) %>% 
  
                   dplyr::group_split(csid) %>% 
                   map_dfr( ~ .x %>% 
                                 filter(datedeveloped >= HF_combined_datedeveloped) %>% 
                                 filter(!(type %in% c("da", "du") & datedeveloped == min(HF_combined_datedeveloped)))) 


# Step 4

df_cmprisk <- temp_df %>%   
                dplyr::group_by(csid) %>% 
                dplyr::mutate (time.event  = ifelse(datedeveloped > 
                                                     HF_combined_datedeveloped, 2,1),
                               
                               after_28d   = HF_combined_datedeveloped + 28, 
                               
                               recur.event = case_when(datedeveloped > 
                                                         HF_combined_datedeveloped + 28 ~ "Recurrence", 
                                                       
                                                       TRUE ~ "No recurrence")) %>%   
  
                ungroup () %>% 

                filter(!(is_outpatient == 1 & 
                         time.event == 2 & 
                         !(type %in% c("da", "du")))) %>% 

                dplyr::arrange(csid) %>% 
                select(c(csid, type, datedeveloped, time.event, recur.event)) 


df_cmprisk <- df_cmprisk %>% 
                      dplyr::mutate(df_dup = duplicated(.[ , c("csid", "datedeveloped")])) %>% 
                      filter(df_dup == FALSE)


#Step 5
df_cmprisk_wider <- df_cmprisk %>% 
                             pivot_wider(names_from = type, 
                                         values_from = time.event, 
                                         values_fill = 0) %>% 
  
                             select(-df_dup)

 

#Step 6

col_headers <- names(df_cmprisk_wider)[-c(1:3)] 

for (c in seq_along(col_headers)) {
  
  new_col_name <- paste0(col_headers[[c]], "_ep", sep = "")
  
  df_cmprisk_wider[ ,new_col_name] <- ifelse(df_cmprisk_wider[[col_headers[c]]] > 0, 1, 0)    
  
}
   
   
# Step 7
df_cmprisk_wider <- df_cmprisk_wider %>%
                          dplyr::mutate(death_all_ep  = ifelse(da_ep > 0, 1, 0)) %>% 
  
                          #Capture the number of events per participant
                          dplyr::group_by(csid) %>% 
                          dplyr::arrange(csid, datedeveloped) %>%
                          dplyr::mutate(n_event = 1:n(), 
                                        n_event_cat = factor(ifelse(n_event > 3, "3+", n_event-1))) %>%  
  
                          ungroup() 

# Calculate the number of recurrent events per participant

# df_cmprisk_wider %>%
#                 group_split(csid) %>%
#                 map_dfr(~ .x %>% filter(n_event >= max(n_event))) %>%
#                 {table(.$n_event_cat)}

# Number of recurrent events
 #   0    1    2   3+ 
 # 996 1197  893 2577  


#For each participant and based on the recurrence status, keep the earliest event 

df_cmprisk_wider <- df_cmprisk_wider %>% 
                          group_split(csid, recur.event) %>%
  
                          map_dfr( ~ .x %>% 
                                        filter(datedeveloped <= min(datedeveloped))) %>% 
  
                          select(csid, datedeveloped, recur.event, death_all_ep, n_event)


df_cmprisk_wider <- df_cmprisk_wider %>% 
                          dplyr::group_by(csid) %>% 
                          dplyr::mutate(n_event = 1:n()) %>% # Recode n_event to facilitate manipulation 
                          ungroup()


# Step 8

df_cmrk <- df_cmprisk_wider %>% 
                        dplyr::group_by(csid) %>%
                        inner_join(data_hf, by= "csid") %>% ungroup()  %>% 
  
                        # Select relevant variables for competing risk analysis 
                        select(csid:n_event, 
                               
                               censoring_date, censoring_reason, 
                               copd, HF_combined_ep, HF_combined_datedeveloped, 
                               
                               age65, age_diag_merge, sex, area, region, edu3, 
                               smoking_status, current_drinkers, HTN, bmi_cat, 
                               diabetes, develop_IHD, develop_copd, stroke_tia) %>%  
  
                        dplyr::mutate(dupl_csid = duplicated(.[ , "csid"]), 
                                      
                                      #define outcome status 
                                      status = factor(ifelse(n_event == 2 & death_all_ep == 0,  2,                          # 2: "recurrence"
                                                      ifelse(n_event == 2 & death_all_ep == 1,  1,                          # 1: "death"
                                                      ifelse(n_event == 1 & censoring_reason != "Dead", 0,                  # 0: "censored"
                                                      ifelse(n_event == 1 & censoring_reason == "Dead", 1, NA)))))) %>% 
  
                        relocate(status, .after = censoring_reason)

# Step 9 
dupl_csid <- df_cmrk %>% filter(dupl_csid == TRUE) %>% pull(csid) 

df_cmrk   <- df_cmrk[!(df_cmrk$csid %in% dupl_csid & df_cmrk$n_event == 1), ]

# Step 10
df_cmrk_hf <- df_cmrk %>% 
                  dplyr::mutate(futime    = ifelse(status == 2, 
                                                  interval(HF_combined_datedeveloped, datedeveloped)/dyears(1),
                                                  interval(HF_combined_datedeveloped, censoring_date)/dyears(1)), 
                                        
                                futime_day = ifelse(status == 2, 
                                                  interval(HF_combined_datedeveloped, datedeveloped)/ddays(1),
                                                  interval(HF_combined_datedeveloped, censoring_date)/ddays(1))) %>% 
  
                         relocate(futime,futime_day, .after = status)


df_cmrk_hf <- df_cmrk_hf %>% filter(!(futime_day == 0 & status == 1))

```


```{r Fit univariate competing risk model}

# Running the competing risk analysis ####

source("J:/DPhil/First year/HF prognosis/Data analysis/CumIncidence.R")

fit_cmrk_est = with (df_cmrk_hf, CumIncidence (futime, 
                                               status, 1, 
                                               cencode = 0, 
                                               xlab = "Years", 
                                               t=seq(0, 9, 1/365)))

fit_cmrk_ci  = with (df_cmrk_hf, CumIncidence (futime, 
                                               status, 1, 
                                               cencode = 0, 
                                               xlab = "Years", 
                                               t=seq(0, 9, 1), level = 0.95))


fit_surv <- list(length = 2)

for (i in 1:2) {
 fit_surv[[i]] <- survfit(Surv(futime, status == i) ~ 1, data = df_cmrk_hf)
 fit_surv[[i]] <- summary(fit_surv[[i]], times = 0:9) 
}



# Create a matrix of CIF estimate and time for plotting line graph 
df_cif_line_hf <- as.data.frame(t(rbind(time = seq(0, 9, 1/365), 
                                        cif = fit_cmrk_est$est[2, ]))) %>% dplyr::mutate(disease = "hf")

df_ci_hf <- as.data.frame(cbind(time = 0:9, 
                             t(fit_cmrk_ci$ci[, , 2 ]),
                             cif = fit_cmrk_ci$est[2, ],
                             n.event.death = fit_surv[[1]]$n.event, 
                             n.risk.death  = fit_surv[[1]]$n.risk,
                             n.event.recur = fit_surv[[2]]$n.event, 
                             n.risk.recur  = fit_surv[[2]]$n.risk)) %>%  
  
            dplyr::mutate(disease = "hf", 
                          cif_95ci = paste(round(cif*100), "%", " (", 
                                           round(lower*100), " - ", 
                                           round(upper*100), ")", sep = ""))


```



### Pulmonary heart disease


```{r Data manipulation}

phd_events <- endpoint_events %>% filter(epid == "CKB0012", type != "hiop")   
temp_df    <- phd_events[phd_events$csid %in% data_phd$csid, ]    


temp_df    <- temp_df %>% 
                inner_join(data_phd %>% select(csid, PHD_combined_datedeveloped)) %>%  

                dplyr::mutate(
                        datedeveloped = as.Date(datedeveloped), 
                        PHD_combined_datedeveloped = as.Date(PHD_combined_datedeveloped)) %>% 

                dplyr::group_by(csid) %>% 
                           filter(!(type %in% c("da", "du") & datedeveloped == min(PHD_combined_datedeveloped))) %>% ungroup()


# Remove remove duplicated events occurring on the same day --------------------------------------------------------------------

df_dup     <- duplicated(temp_df[ , c("csid", "datedeveloped")])
df_dedup   <- temp_df[!df_dup, ]   


# Define first and recurrent events 
df_cmprisk <- df_dedup %>%  dplyr::group_by(csid) %>% 
                            dplyr::mutate (first.event = ifelse(datedeveloped == min(PHD_combined_datedeveloped), 1, 2), 
                                           
                                           after_28d   = PHD_combined_datedeveloped + 28, 
                               
                                           recur.event = case_when(datedeveloped > after_28d ~ "Recurrence", 
                                                                                     TRUE ~ "No recurrence")) %>% 
                            dplyr::arrange(csid) %>% 
                            select(c(csid, type, datedeveloped, first.event, recur.event)) %>%
                            ungroup()


df_cmprisk_wider <- df_cmprisk %>% 
                         pivot_wider(names_from  = type, 
                                     values_from = first.event, 
                                     values_fill = 0)                


#Create new events column ------------------------------------------------------------------------------------------------------

col_headers <- names(df_cmprisk_wider)[-c(1:3)]

for (c in seq_along(col_headers)) {
  
    new_col_name <- paste0(col_headers[[c]], "_ep", sep = "")
    df_cmprisk_wider[ ,new_col_name] <- ifelse(df_cmprisk_wider[[col_headers[c]]] > 0, 1, 0)    
  
}
        

df_cmprisk_wider <- df_cmprisk_wider %>%
  
                          #Capture the number of events per participant
                          dplyr::arrange(csid, datedeveloped) %>%
                          dplyr::group_by(csid) %>% 
                          dplyr::mutate(n_event = 1:n(), 
                                        n_event_cat = factor(ifelse(n_event > 3, "3+", n_event))) %>% 
  
                          ungroup()  

#  df_cmprisk_wider %>% 
#                 group_split(csid) %>%
#                 map_dfr(~ .x %>% filter(n_event >= max(n_event))) %>%
#                 {table(.$n_event_cat)}
# 
# 
#    1    2    3   3+ 
# 1705  637  249  330                          
 
 
# Controlled filtering by recurrence status---------------------------------------------------------------------------------------
 
df_cmprisk_wider <- df_cmprisk_wider %>% 
                          group_split(csid, recur.event) %>%
  
                          map_dfr( ~ .x %>% 
                                        filter(datedeveloped <= min(datedeveloped))) %>% 
  
                          select(csid, datedeveloped, recur.event, n_event, da_ep) %>% 
  
                          # Recode n_event to facilitate manipulation
                          dplyr::group_by(csid) %>% 
                          dplyr::mutate(n_event = 1:n()) %>%  ungroup()


df_cmrk <- df_cmprisk_wider %>% 
                  dplyr::group_by(csid) %>%
                  inner_join(data_phd, by= "csid") %>% ungroup()  %>% 

                  select(csid:da_ep, 
                         
                         censoring_date, censoring_reason, 
                         copd, PHD_combined_ep, PHD_combined_datedeveloped, 
                         
                         age_diag65, age_diag_merge, sex, area, region, edu3, 
                         smoking_status, ever_reg_smoker, alcohol_recode, current_drinkers, HTN, bmi_cat, 
                         diabetes, develop_IHD, develop_copd, stroke_tia, co_hf_phd
                         ) %>%  

                  dplyr::mutate(dupl_csid = duplicated(.[ , "csid"]), 
                                
                                #define outcome status 
                                status = factor(ifelse(n_event == 2 & da_ep == 0,  2,                          # 2: "recurrence"
                                                ifelse(n_event == 2 & da_ep == 1,  1,                          # 1: "death"
                                                ifelse(n_event == 1 & censoring_reason != "Dead", 0,           # 0: "censored"
                                                ifelse(n_event == 1 & censoring_reason == "Dead", 1, NA)))))
                                ) %>% 

                  relocate(status, .after = censoring_reason)


# Drop first event for those with duplicate events

dupl_csid <- df_cmrk %>% filter(dupl_csid == TRUE) %>% pull(csid) 

df_cmrk   <- df_cmrk[!(df_cmrk$csid %in% dupl_csid & df_cmrk$n_event == 1), ]


# Define follow-up time for analysis 
df_cmrk_phd <- df_cmrk %>% dplyr::mutate(futime = ifelse(status == 2, 
                                                         interval(PHD_combined_datedeveloped, datedeveloped)/dyears(1),
                                                         interval(PHD_combined_datedeveloped, censoring_date)/dyears(1)), 
                                        
                                        futime_day = ifelse(status == 2, 
                                                         interval(PHD_combined_datedeveloped, datedeveloped)/ddays(1),
                                                         interval(PHD_combined_datedeveloped, censoring_date)/ddays(1))
                                        ) %>% 
  
                              relocate(futime, futime_day, .after = status)

## Drop deaths (from any cause) that occurred on the same day as first event 
df_cmrk_phd <- df_cmrk_phd %>% filter(!(futime_day == 0 & status == 1))

```


```{r fit univariate competing risk model}

# Running competing risk analysis 

source("J:/DPhil/First year/HF prognosis/Data analysis/CumIncidence.R")

fit_cmrk_est = with (df_cmrk_phd, 
                     CumIncidence (futime, 
                                   status, 1, 
                                   cencode = 0, 
                                   xlab = "Years", 
                                   t=seq(0, 9, 1/365)))


fit_cmrk_ci = with (df_cmrk_phd, 
                    CumIncidence (futime, 
                                  status, 1, 
                                  cencode = 0, 
                                  xlab = "Years", 
                                  t=seq(0, 9, 1), 
                                  level = 0.95))


fit_surv <- list(length = 2)

for (i in 1:2) {
 fit_surv[[i]] <- survfit(Surv(futime, status == i) ~ 1, data = df_cmrk_phd)
 fit_surv[[i]] <- summary(fit_surv[[i]], times = 0:9) 
}



# Create a matrix of CIF estimate and time for plotting line graph 
df_cif_line_phd <- as.data.frame(t(rbind(time = seq(0, 9, 1/365), 
                                         cif = fit_cmrk_est$est[2, ])
                                   )
                                 ) %>% dplyr::mutate(disease = "phd")

df_ci_phd       <- as.data.frame(cbind(time = 0:9, 
                                       t(fit_cmrk_ci$ci[, , 2 ]),
                                       cif = fit_cmrk_ci$est[2, ],
                                       n.event.death = fit_surv[[1]]$n.event, 
                                       n.risk.death  = fit_surv[[1]]$n.risk,
                                       n.event.recur = fit_surv[[2]]$n.event, 
                                       n.risk.recur  = fit_surv[[2]]$n.risk)) %>% 
  
                   dplyr::mutate(disease = "phd", 
                                 cif_95ci = paste(round(cif*100), "%", " (", round(lower*100), " - ", round(upper*100), ")", sep = ""))

```


### Merging HF and PHD datasets

```{r}

# merge HF and PHD datasets
df_cif_line <- rbind(df_cif_line_hf, df_cif_line_phd) %>% dplyr::mutate(disease = factor(disease))
df_ci       <- rbind(df_ci_hf, df_ci_phd) %>% dplyr::mutate(disease = factor(disease))

df_ci_list  <- list(length = length(levels(df_ci$disease)))



for (i in seq_along(levels(df_ci$disease))) {
  
  df_ci_list[[i]] <- 
        df_ci %>% 
        filter(disease == levels(df_ci$disease)[i]) %>% 
        select(time, 
               n.risk  = n.risk.recur, 
               n.recur = n.event.recur, 
               n.death = n.event.death, 
               cif_95ci, 
               disease)

  
  rownames(df_ci_list[[i]]) <- df_ci_list[[i]]$time
  df_ci_list[[i]]           <- t(df_ci_list[[i]])

}

# 
# write.csv(df_ci_list[[1]], "recurrence_HF.csv")
# write.csv(df_ci_list[[2]], "recurrence_PHD.csv")

```


```{r}


df_cif_line <- list(df_cif_line_hf, df_cif_line_phd) 
df_ci       <- list(df_ci_hf, df_ci_phd)


## Calculate censored events 
#  (n.risk in previous time - [current n.risk + death + recurrence])

require(data.table)

df_ci_censored <- 
  map(.x = df_ci, 
      ~mutate(
          .x, 
          n.censor.recur = lag(n.risk.recur) - (n.risk.recur + n.event.recur + n.event.death),
          # replace NA in censored with 0
          n.censor.recur = ifelse(is.na(n.censor.recur), 0, n.censor.recur))
      )


# Transpose the df_ci for reporting

df_ci_report <- 
  
  map(
    .x = df_ci_censored, 
    ~select(
      .x, 
      time, 
      n.risk  = n.risk.recur, 
      n.recur = n.event.recur, 
      n.death = n.event.death,
      cif_95ci, 
      disease, 
      n.censor.recur) %>% t(.)
    )




# write.csv(df_ci_report[[1]], "recurrence_HF.csv")
# write.csv(df_ci_report[[2]], "recurrence_PHD.csv")

```



### Age-specific 5-year recurrence rate

```{r compute age-specific 5-year recurrence}

#Data 
data       <- list(df_cmrk_hf, df_cmrk_phd)
data_label <- c('hf', 'phd')


#Merged age categories to have sufficient numbers 

data <- 
  
  map(
    .x = data,
    ~mutate(
      .x, 
      age_merged3 = factor(
                       case_when(
                           age_diag_merge == "70-79" | age_diag_merge == "80-89" ~  "70+",
                           age_diag_merge == "30-59" ~ "30-59",
                           age_diag_merge == "60-69" ~ "60-69"),
                       levels = c("30-59", "60-69", "70+"))
      )
    )



strata <- "age_merged3"

temp_surv_0_9_df_list <-  list(length = length(strata)) #To hold datasets temporarily 
surv_0_9_df_list      <-  list(length = length(data))   #To hold datasets


for (df in seq_along(data)) {
  
  data_temp <- data[[df]]
  
        
      for (v in seq_along(strata)) { 
                
              group <- data_temp[[strata[[v]]]] 
                         
              fit_cmrk_sg_ci = with (data_temp, 
                                     CumIncidence(futime, 
                                                  status, 
                                                  group, 
                                                  cencode = 0, 
                                                  xlab = "Years", 
                                                  t=seq(0, 5, 1), 
                                                  level = 0.95))
              
              fit_cmrk_sg_est = with (data_temp, 
                                     CumIncidence (futime, 
                                                   status, 
                                                   group, 
                                                   cencode = 0, 
                                                   xlab = "Years",
                                                   t=seq(0, 5, 1/365)))
              
              sub_est <- (nrow(fit_cmrk_sg_est$est)-length(levels(factor(group)))+1):nrow(fit_cmrk_sg_est$est)
              
         
# Run "ordinary" survival analysis to obtain number of death, recurrence, and censored
      fit_surv <- list(length = 2)
      
      for (i in 1:2) {
           fit_surv[[i]] <- survfit(Surv(futime, status == i) ~ group, data = data_temp)
           fit_surv[[i]] <- summary(fit_surv[[i]], times = 0:5) 
      }


#Extract confidence intervals 
est_rbind <- list(length = length(sub_est))
ci_rbind  <- list(length = length(sub_est))

      for (i in seq_along(sub_est)) {
        
              # Extract estimates
              df_temp           <- fit_cmrk_sg_ci$est[sub_est[[i]], ]
              df_temp           <- as.data.frame(df_temp)
              df_temp$strata    <- levels(factor(group))[i]
              est_rbind[[i]]    <- df_temp
              
              # Extract confidence intervals 
              df_temp_ci        <- t(fit_cmrk_sg_ci$ci[, , sub_est[[i]]]) 
              df_temp_ci        <- as.data.frame(df_temp_ci)
              df_temp_ci$strata <- levels(factor(group))[i]
              ci_rbind[[i]]     <- df_temp_ci
        
      } 


df_ci_short <- bind_rows(ci_rbind) %>% 
                   dplyr::mutate(time = rep(seq(0, 5, 1), length(sub_est))) %>% 
                   `row.names<-` (NULL)


df_est <- bind_rows(est_rbind) %>% 
               dplyr::mutate(time = rep(seq(0, 5, 1), length(sub_est))) %>% 
               `row.names<-`(NULL)
               

df_est_ci <- inner_join(df_est, df_ci_short, by = c("time", "strata")) %>% rename("cif" = "df_temp")



df_ci_short <- 
  
  as.data.frame(
     cbind(df_est_ci,
           n.event.death  = fit_surv[[1]]$n.event, 
           n.risk.death   = fit_surv[[1]]$n.risk,
           n.censor.death = fit_surv[[1]]$n.censor,
           n.event.recur  = fit_surv[[2]]$n.event, 
           n.risk.recur   = fit_surv[[2]]$n.risk,  
           n.censor.recur = fit_surv[[2]]$n.censor)) %>% 
  
     dplyr::mutate(cif_95ci = paste0(round(cif*100), "%", " (", round(lower*100), " - ", round(upper*100), ")"))

# Capture datasets for eact strata 
temp_surv_0_9_df_list[[v]] <-  df_ci_short 


#End of for loop

        }
  
  #Capture datasets 
  surv_0_9_df <- bind_rows(temp_surv_0_9_df_list) %>% dplyr::mutate(disease = data_label[df])
  surv_0_9_df_list[[df]] <- surv_0_9_df
  
  
  rm(data_temp)
   
  #End of For loop
}



#Run age-specific analysis

df_age_cif <- 
  
  map(.x = surv_0_9_df_list, 
      ~filter(.x, time == 5) %>%
        dplyr::mutate(se = (cif - lower)/1.96, var = se^2)) %>% 
  
  map(~rma(yi=cif, vi=var, method = "FE", data = .x)) %>%
  map( 
    ~tibble(cif     = .x$b[1,1],
            lci     = .x$ci.lb,
            uci     = .x$ci.ub,
            est_ci  = paste0(round(cif*100), " (", round(lci*100), " - ", round(uci*100), "), %"), 
            outcome = c("hf", "phd")[[df]])
    )


```



### Plotting recurrent hospitalisation

```{r}

 
# Labels-- 
font_style    <- ""

x_risk_title  = -3
y_risk_title  = -0.25
x_event_text  = 0.2

plot.title    <- c("C. Heart failure\n", "D. Pulmonary heart disease\n")
y_label       <- c("Cumulative risk, % (95% CI)", "")


# Wrangling --- 
lab_risk <- map(.x = df_ci_censored, 
                ~dplyr::mutate(.x, risk_censor = paste0(n.risk.recur, "\n", n.censor.recur)) %>% 
                 dplyr::select(time, risk_censor, disease)
                )

surv_df_1_9 <- map(.x = df_ci_censored, ~filter(.x, time > 0 & time <= 9)) 
surv_all_df <- map(.x = df_cif_line, ~filter(.x, time < 9.1))


# Visualisation --- 
plot_list_cif <- 
  
  map2(
    .x = surv_all_df, 
    .y = seq_along(surv_all_df), 
    
    ~ggplot (data = .x, aes (x = time,  y=cif)) +
      
      geom_step(linewidth = 0.7) +
      geom_point(
           aes(x = time, y = cif), 
           shape = 15, 
           size  = 1, 
           data  = surv_df_1_9[[.y]])  +
      
      geom_errorbar(
          aes(x = time, y = cif, ymin = lower, ymax = upper),
          width = 0.1, 
          linewidth = 0.7, 
          data = surv_df_1_9[[.y]]) +

      #Setting theme 
      theme_void() + 
      
      #Theme text 
      theme(text         = element_text(family = font_style),
            axis.text.x  = element_text(size = 13, vjust = 0),
            axis.text.y  = element_text(size = 13, hjust = 1), 
            axis.title.x = element_text(size = 14, vjust = -1), 
            axis.title.y = element_text(size = 14, angle = 90)) +
    
      theme(legend.position   = "none",  
            axis.line         = element_line(colour = "black", size = 0.6, linetype = "solid"), 
            axis.ticks        = element_line(size = 0.6),
            axis.ticks.length = unit(0.25, "cm"), 
            plot.margin       = list(unit(c(2, 0.5, 2, 1.5), "cm"), unit(c(2, 1, 2, 0.5), "cm"))[[.y]]) +  
      
      # Scales
      coord_cartesian(xlim = c(0, 9), ylim = c(0, 1), clip = "off") +
      scale_x_continuous(expand = c(0, 0), breaks = c(0:9)) +  
      scale_y_continuous(expand = c(0, 0), breaks = seq(0, 1, 0.2), labels = seq(0, 100, 20)) + 
      
  #Number at risk 
  geom_text(x = 0.3, y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[1]],  size = 3.5, family = font_style, color = "black") +
  geom_text(x = 3,   y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[4]],  size = 3.5, family = font_style, color = "black") +
  geom_text(x = 5,   y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[6]],  size = 3.5, family = font_style, color = "black") +
  geom_text(x = 7,   y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[8]],  size = 3.5, family = font_style, color = "black") +
  geom_text(x = 9,   y = y_risk_title, label = lab_risk[[.y]]$risk_censor[[10]], size = 3.5, family = font_style, color = "black") +
 
  
  # Plot heading --
  geom_text(
    x      = x_risk_title, 
    y      = 1.15, 
    label  = c("Recurrent hospitalisation risk", "")[.y],  
    size   = 4.5, 
    fontface = 2,
    family = font_style, 
    color  = "black", 
    hjust  = 0) +
    
  # Panel title 
  geom_text(
    x     = -0.5,
    y     = 1.02,
    label = plot.title[[.y]],
    size  = 4.5, 
    family = font_style, 
    color = "black",
    hjust = 0, 
    fontface = 2) +
 
  # Cumulative event rate
  geom_text(
    x        = x_event_text, 
    y        = 0.95,    
    label    = paste0("5-year cumulative risk (95% CI), %", "\n", df_age_cif[[.y]]$est_ci), 
    size     = 4, 
    family   = font_style, 
    color    = "black", 
    hjust    = 0) +
   
  # Risk/Censored heading 
  geom_text(
    x      = x_risk_title, 
    y      = -0.17, 
    label  = c("Cause-specific recurrence", "")[.y],  
    size   = 3.5, 
    fontface = 2,
    family = font_style, 
    color  = "black", 
    hjust  = 0) +
  
  # Risk/Censored
  geom_text(
    x      = x_risk_title, 
    y      = y_risk_title, 
    label  = c(paste0("At risk(n):  ", "\n", "Censored(n):  "), "")[.y],  
    size   = 3.5, 
    family = font_style, 
    lineheight = 1,
    color  = "black", 
    hjust  = 0) +  
    
  ylab(y_label[[.y]]) + 
  xlab("Time since diagnosis (years)")
  
)

 
 
```


### Combine mortality and recurrence plots --

```{r}

plot <- ggarrange (plot_list_cmr[[1]], 
                   plot_list_cmr[[2]],
                   plot_list_cif[[1]], 
                   plot_list_cif[[2]],
                   ncol       = 2,
                   nrow       = 2,
                   widths     = c(1, 1), 
                   heights    = c(1.1, 1.1))


png("Figure 4 - mortality and Recurrent hospitalisation2.png", 
     units     = "in", 
     width     = 8.3, 
     height    = 11.7, 
     res       = 300,
     pointsize = 2,
     bg        = "white")
 
 plot 
 
 dev.off()
 

```


```{r subgroup Competing risk analysis}


#Variables for subgroup
strata <- c("age_diag65", "sex", "area")


#Data 
data       <- list(df_cmrk_hf, df_cmrk_phd)
data_label <- c('hf', 'phd')


#To hold datasets temporarily 
temp_surv_all_df_list <-  list(length = length(strata))
temp_surv_0_9_df_list <-  list(length = length(strata))

#To hold datasets
surv_all_df_list <-  list(length = length(data))
surv_0_9_df_list <-  list(length = length(data))


for (df in seq_along(data)) {
  
  
  data_temp <- data[[df]]
  
  
        for (v in seq_along(strata)) { 
          
            group       <- data_temp[[strata[[v]]]] 
            strata_name <- strata[[v]]
                      
            fit_cmrk_sg_est = with (data_temp, 
                                     CumIncidence (futime, 
                                                   status, 
                                                   group, 
                                                   cencode = 0, 
                                                   xlab = "Years",
                                                   t=seq(0, 6, 1/365)))
            
            fit_cmrk_sg_ci = with (data_temp, 
                                     CumIncidence (futime, 
                                                   status, 
                                                   group, 
                                                   cencode = 0, 
                                                   xlab = "Years", 
                                                   t=seq(0, 6, 1), 
                                                   level = 0.95))

# Run "ordinary" survival analysis to obtain number of death, recurrence, and censored
fit_surv <- list(length = 2) 

for (i in 1:2) {
     fit_surv[[i]] <- survfit(Surv(futime, status == i) ~ group, data = data_temp)
     fit_surv[[i]] <- summary(fit_surv[[i]], times = 0:6) 
}

sub_est <- (nrow(fit_cmrk_sg_est$est)-length(levels(factor(group)))+1):nrow(fit_cmrk_sg_est$est)

  
# Create a matrix of CIF estimate and time for plotting line graph 

# Rowbind estimates
est_rbind <- list(length = length(sub_est))

for (i in seq_along(sub_est)) {
  
    df_temp <- fit_cmrk_sg_est$est[sub_est[[i]], ]
    df_temp <- as.data.frame(df_temp)
    
    df_temp$strata <- levels(factor(group))[i]
    est_rbind[[i]] <- df_temp
  
}

df_bind <- map_dfr(
            .x = est_rbind, 
             ~rbind(.x)) %>% 
                dplyr::rename("cif" = "df_temp") %>% 
                dplyr::mutate(exposure = strata_name)

rownames(df_bind) <- NULL

time = rep(seq(0, 6, 1/365), length(sub_est))


df_cif_long <- as.data.frame(cbind(time, df_bind))                              # Dataframe for line plot 


#Extract confidence intervals 
ci_rbind <- list(length  = length(sub_est))

for (i in seq_along(sub_est)) {
  
        # Extract estimates
        df_temp <- fit_cmrk_sg_ci$est[sub_est[[i]], ]
        df_temp <- as.data.frame(df_temp)
        df_temp$strata <- levels(factor(group))[i]
        est_rbind[[i]] <- df_temp
        
        # Extract confidence intervals 
        df_temp_ci <- t(fit_cmrk_sg_ci$ci[, , sub_est[[i]]])
        df_temp_ci <- as.data.frame(df_temp_ci)
        ci_rbind[[i]] <- df_temp_ci
  
}

df_est_bind <- map_dfr(
  .x = est_rbind, 
  ~rbind(.x)) %>%
      dplyr::rename("cif" = "df_temp") %>%
      dplyr::mutate(exposure = strata_name)

df_ci_bind  <- map_dfr(.x = ci_rbind, ~rbind(.x)) 

time = rep(seq(0, 6, 1), length(sub_est))

df_ci_short <- as.data.frame(cbind(time, df_est_bind, df_ci_bind))
rownames(df_ci_short) <- NULL


df_ci_short <- as.data.frame(cbind(
                               df_ci_short,
                               n.event.death  = fit_surv[[1]]$n.event, 
                               n.risk.death   = fit_surv[[1]]$n.risk,
                               n.censor.death = fit_surv[[1]]$n.censor,
                               n.event.recur  = fit_surv[[2]]$n.event, 
                               n.risk.recur   = fit_surv[[2]]$n.risk, 
                               n.censor.recur = fit_surv[[2]]$n.censor)) %>% 

             dplyr::mutate(cif_95ci = paste(round(cif*100), "%", " (", 
                                            round(lower*100), " - ", round(upper*100), ")", sep = ""))

# Capture datasets for eact strata 
temp_surv_all_df_list[[v]] <-  df_cif_long
temp_surv_0_9_df_list[[v]] <-  df_ci_short


  #End of for loop

        }
  
  #Capture datasets 
  surv_all_df <- map_dfr(temp_surv_all_df_list, ~rbind(.x)) %>% dplyr::mutate(disease = data_label[df])
  surv_0_9_df <- map_dfr(temp_surv_0_9_df_list, ~rbind(.x)) %>% dplyr::mutate(disease = data_label[df])
  
   
  surv_all_df_list[[df]] <- surv_all_df
  surv_0_9_df_list[[df]] <- surv_0_9_df
  
  
  #End of For loop
}

```


### Make plots for subgroups 
```{r}
# Create plot for subgroups 

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/my_gg_theme_text.R")

## Overall --

surv_all_df_list
surv_0_9_df_list 


strata_label <- rep(list("Age at diagnosis, years", "Sex", "Area"), 2) 

y_label <- c(rep(list("Cumulative risk, % (95% CI)"), 3), rep(list(""), 3))

y_tick_label <- list(seq(0, 100, 20), NULL, NULL, 
                     seq(0, 100, 20), NULL, NULL)
  
#Turn off legend for bottom plots ---
leg_position  <- c(
        list(c(0.14, 0.6), 
             c(0.12, 0.6), 
             c(0.12, 0.6)), 
        rep(list("none"), 3)
        )

colour_values <- rep(list(c("#B30437", "#009FC3"), 
                          c("#2B6A99", "#D88546"), 
                          c("black",   "#01C698")), 2)

cust_margins  <- list(c(2, 1, 2, 1.5), 
                      c(1, 1, 2, 1.5), 
                      c(1, 1, 2, 1.5), 
                      c(2, 1, 2, 1), 
                      c(1, 1, 2, 1), 
                      c(1, 1, 2, 1))


# Get group levels ---
group_levels <- map(.x = df_sub_desc_split, ~unique(as.character(.x$strata)))

# Number at risk ---

n_risk_title <- c(rep(list("Number at risk"), 3), rep(list(""), 3))

n_risk_body  <- list(pluck(group_levels, 1), 
                     pluck(group_levels, 2), 
                     pluck(group_levels, 3),
                     NULL, 
                     NULL, 
                     NULL)

legend_label <- list(pluck(group_levels, 1), 
                     pluck(group_levels, 2), 
                     pluck(group_levels, 3),
                     NULL, 
                     NULL, 
                     NULL)

data_label   <- list('Heart failure\n', "", "", 'Pulmonary heart disease\n', "", "")
font_style   <- ""


# Positioning text on plot 

x_risk_title = -1.0
y_risk_title = -0.2
y_decrement_risk = y_risk_title - 0.05

x_event_text = 0.1    
n_risk_size  = 4

# Order of "y_decrement event: Main, group 1, group 2
y_decrement_event <- list(
                      c(0.95, 0.90, 0.85), 
                      c(0.95, 0.90, 0.85), 
                      c(0.95, 0.90, 0.85),
                      c(0.95, 0.90, 0.85), 
                      c(0.95, 0.90, 0.85), 
                      c(0.95, 0.90, 0.85))

y_event <- list(0.9, 0.9, 0.9, 0.2, 0.2, 0.2)

rm("strata") #Remove objects named strata to avoid conflicts. 


# Obtain datasets

# Split datasets and prepare for plotting --- 

# Convert exposure as factor and maintain order of exposures before splitting
order_exposure <- map(.x = surv_0_9_df_list, ~unique(.x$exposure))
strata_levels  <- map(.x = surv_0_9_df_list, ~unique(.x$strata))



surv_0_9_df_list <- 
  
  map2(
    .x = surv_0_9_df_list,
    .y = seq_along(surv_0_9_df_list), 
                          
    ~mutate(
      .x, 
      exposure = factor(exposure, levels = order_exposure[[.y]]), 
      strata   = factor(strata, levels = strata_levels[[.y]]))
    )

surv_all_df_list <- 
  
  map2(
    .x = surv_all_df_list, 
    .y = seq_along(surv_all_df_list), 
                          
    ~mutate(
      .x, 
      exposure = factor(exposure, levels = order_exposure[[.y]]), 
      strata   = factor(strata, levels = strata_levels[[.y]]))
    )


# Split data and flatten remove hierarchical structure 
df_sub_all_split  <- map(.x = surv_all_df_list, ~dplyr::group_by(.x, exposure) %>% group_split()) %>% flatten() 
df_sub_desc_split <- map(.x = surv_0_9_df_list, ~dplyr::group_by(.x, exposure) %>% group_split()) %>% flatten()

df_ci   <- map(.x = df_sub_desc_split, ~dplyr::filter(.x, time > 0)) 
recur5  <- map(.x = df_sub_desc_split, ~dplyr::filter(.x, time == 5) %>% pull(cif_95ci)) 


# Get number at risk -- 

# Make plots ---         
plot_list <- 
  
  map2(
    .x = df_sub_all_split,
    .y = seq_along(df_sub_all_split),
    
    ~ggplot(data = .x, mapping = aes(x=time, y=cif)) +
      
      geom_step(aes(linetype = strata), linewidth = 0.7) +
      
      geom_errorbar(
        data    = df_ci[[.y]], 
        mapping = aes(x = time, y = cif, ymin  = lower, ymax = upper, linetype = strata), 
        width   = 0.1, linewidth = 0.7) +
      
      geom_point(
       data    = df_ci[[.y]],
       mapping = aes(x = time, y = cif), 
       shape   = 15, 
       size    = 1) + 
                    
    #Setting theme --
  
    theme_void() + 
    
    theme(axis.text.x  = element_text(size = 13, vjust = 0),
          axis.text.y  = element_text(size = 13, hjust = 1), 
          axis.title.x = element_text(size = 14, vjust = -1), 
          axis.title.y = element_text(size = 14, angle = 90)) +

    theme(legend.position   = leg_position[[.y]],  
          axis.line         = element_line(colour = "black", size = 0.6, linetype = "solid"), 
          axis.ticks        = element_line(size = 0.6),
          axis.ticks.length = unit(0.25, "cm"), 
          plot.margin       = unit(cust_margins[[.y]], "cm")) + 

    guides(linetype = guide_legend(title       = "", 
                                   title.hjust = 0,
                                   label.hjust = 0,
                                   title.theme = element_text(size = 12, face = "bold", family = font_style),   
                                   label.theme = element_text(size = 11, family = font_style))) + 
    
    # Modify axes--
    coord_cartesian(xlim = c(0, 6.0), ylim = c(0, 1), clip = "off") + 
    scale_x_continuous(expand = c(0, 0), breaks = 0:6, labels = 0:6) +  
    scale_y_continuous(expand = c(0, 0), breaks = seq(0, 1, 0.2), labels = seq(0, 100, 20)) + 
  
    
     
    scale_color_manual(values = colour_values[[.y]],  
                       labels = group_levels [[.y]]) + 
     
    # Write number at risk (heading)
    geom_text(x        = rep(c(-1.4, -1.0, -1.0), 2)[[.y]], 
              y        = y_risk_title, 
              label    = paste0(n_risk_title[[.y]], "\n", paste0(n_risk_body[[.y]], collapse = "\n")), 
              size     = n_risk_size, 
              family   = font_style, 
              color    = "black",
              hjust    = 0) + 

  
    # Number at risk --
    #Category 1
    geom_text(
      x = 0.2, 
      y = y_risk_title, 
      size = n_risk_size, 
      family = font_style, 
      color = "black",
      label  = paste0(
                 "\n",  
                 paste0(df_sub_desc_split[[.y]][df_sub_desc_split[[.y]]$time == 0, ]$n.risk.recur, collapse = "\n"))) +
  
    geom_text(
      x = 2, 
      y = y_risk_title, 
      size = n_risk_size, 
      family = font_style,
      color = "black",
      label  = paste0(
                  "\n",  
                  paste0(df_sub_desc_split[[.y]][df_sub_desc_split[[.y]]$time == 2, ]$n.risk.recur, collapse = "\n"))) +
  
    geom_text(
      x = 4, 
      y = y_risk_title, 
      size = n_risk_size, 
      family = font_style,
      color = "black",
      label  = paste0(
                 "\n",  
                 paste0(df_sub_desc_split[[.y]][df_sub_desc_split[[.y]]$time == 4, ]$n.risk.recur, collapse = "\n"))) +
  
    geom_text(
      x = 6, 
      y = y_risk_title, 
      size = n_risk_size, 
      family = font_style,
      color = "black",
      label  = paste0(
                "\n",  
                paste0(df_sub_desc_split[[.y]][df_sub_desc_split[[.y]]$time == 6, ]$n.risk.recur, collapse = "\n"))) +
   
  
    # CIF (95% CI) (main title)---
    geom_text(
      x = x_event_text, 
      y = 0.95,
      size  = 4.5, 
      color = "black",  
      family = font_style, 
      hjust = 0, 
      fontface = 2,
      label = rep(list("Age-adjusted 5-year cumulative risk, % (95% CI)\n", "", ""), 2)[[.y]]) +
    
    # CIF (95% CI) (subtitle)
    geom_text(
      x = x_event_text, 
      y = rep(c(0.83, 0.91, 0.91), 2)[.y], 
      size = 4.5, 
      family = font_style, 
      hjust = 0,
      color = "black",
      label  = paste0(group_levels[[.y]], ":", collapse = "\n"))  +
  
    # CIF (95% CI) (numbers)
    geom_text(
      x      = 2.5,
      y      = rep(c(0.83, 0.91, 0.91), 2)[.y],
      size   = 4.5, 
      family = font_style,
      color  = "black",
      label  = paste0(recur5[[.y]], collapse = "\n")) +
  
    # Plot subtitle
    geom_text(
      x        = -0.1, 
      y        = 1.05, 
      size     = 4.5,  
      hjust    = 0, 
      color    = "black",
      fontface = 2,
      label    = paste0(LETTERS[[.y]], ". ", strata_label[[.y]])) +
    
    # Plot title
    geom_text(
      x     = -0.1,
      y     = 1.10,
      label = data_label[[.y]], 
      size  = 6, 
      family = font_style, 
      color = "black",
      hjust = 0, 
      fontface = 2) +
                 
    ylab(y_label[[.y]]) +
    xlab("Time since first admission (years)"))



 plot <- ggarrange (plot_list[[1]],
                    plot_list[[4]],
                    plot_list[[2]],
                    plot_list[[5]],
                    plot_list[[3]],
                    plot_list[[6]],
                    nrow = 3,
                    ncol = 2, 
                    widths  = rep(1, 6), 
                    heights = rep(2, 6))


grob_title_plot <-  annotate_figure(plot,
                 top = text_grob("Figure S8: Cumulative risk of recurrent hospitalisation among survivors admitted for\nheart failure and pulmonary heart disease by age, sex and area",
                                 color = "black",
                                 face  = "bold",
                                 size  = 18
                                 )
                 )
 

 ckbplotr::save_figure(
   grob_title_plot, 
   ext = c("png", "png"),
   pagedim = unit(c(12, 18), "in"),
   margin  = unit(c(
                1, 
                1, 
                1.5, 
                1), 
                units = "cm"),
   landscape = FALSE, 
   name = "Fig S8 Recurrence subgroup age, sex, area", 
   title = "",
   args = list(
            bg = "white", 
            pointsize = 12
            ),
   footer.gpar = list(fontsize = 14),
   footer.pos  = grid::unit.c(unit(1.9, "cm"), unit(1/2, "cm")),
   footer = "Cumulative risk curves were directly standardised by age at diagnosis, sex and area as appropriate. Death from causes other than heart failure
             or pulmonary heart disease were consider as competing events"
 )   



```


































# Graphical abstract barplot

```{r Standardised mortality after HF and PHD (By strata)}

# Make dataset in long format ---

df_graphbar <- data.frame(
  
  outcome_bar = factor(
                  rep(c("28-day CFR", "5-year CMR", "5-year recurrence"), 2), 
                  levels = c("28-day CFR", "5-year CMR", "5-year recurrence")
                 ),
  
  condition = c(rep("Heart failure", 3), rep("Pulmonary heart disease", 3)), 
  prop      = c(c(18, 48, 22), c(53, 70, 34)), 
  lci       = c(c(17, 47, 20), c(52, 69, 32)),
  uci       = c(c(19, 50, 23), c(54, 71, 36))
  
)


# Add NAs roles to plot ticks between bars 

source("J:/DPhil/First year/HF prognosis/Data analysis/My functions/prepare_lancet_barplot_data.R")


df_graphbar <- barplot_data(dataset = df_graphbar, 
                           region_var = "outcome_bar",
                           include_area_df = FALSE)    
   
bar_labels <- c("", "28-day\ncase-fatality", 
                "", "5-year cumulative\nmortality", 
                "", "5-year recurrent\nhospitalisation", 
                "") 


# Make barplot ---

# Create barplot 
outcome_title  <- c("A. Heart failure", "B. Pulmonary heart disease")
lab_eventr     <-  list("28-day CFR, % (95% CI)", "")
font_style     <- ""



abstract_barplot <- 
  
     ggplot(data = df_graphbar, aes(x = outcome_bar, y = prop, fill = condition)) + 
     geom_col(position = position_dodge(), colour = "black", alpha = 0.9, width = 0.9)  +
     geom_errorbar(
       aes(ymin = lci, ymax = uci),
       color = "black",
       width = 0.3,
       size = 0.4,
       fontface = 2,
       position = position_dodge(0.8)
       ) +
  
    geom_text(
      aes(y = uci, label = round(prop)), 
      position = position_dodge(0.8), 
      vjust = -0.4, 
      fontface = 2, 
      size = 3.9
    ) + 

        #Setting theme  
    theme_void() + 
    
    #Theme text 
    theme(
        text              = element_text(family = font_style),
        axis.text.x       = element_text(size = 12, angle = 0, lineheight = 1.3),
        axis.text.y       = element_text(size = 12, hjust = 1), 
        axis.title.x      = element_text(size = 14,   vjust = -1, face = "bold"), 
        axis.title.y      = element_text(size = 14,   angle = 90, face = "bold")
        ) +
   
    theme(
        # legend.position   = c(0.068, 0.55),
        legend.position   = c(0.3, 0.92),
        axis.line         = element_line(colour = "black", linewidth = 0.6, linetype = "solid"), 
        axis.ticks        = element_line(linewidth = 0.6),
        axis.ticks.x      = element_line(colour = c(rep(c("black", NA), 3), "black")),
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin       = unit(c(1, 1, 1, 1), "cm")
        ) +                
  
    guides(
        fill = guide_legend(title       = "", 
                            title.theme = element_text(size = 11.5, 
                                                       face = "bold", 
                                                       family = font_style), title.hjust = 0,  
                            
                            label.theme = element_text(size = 11.5, 
                                                       family = font_style), label.hjust = 0)
        ) +
    
    scale_fill_manual(values = c("#ff4d00", "#2E83C4"), limits = c("Heart failure", "Pulmonary heart disease")) +
    
    coord_cartesian(xlim = c(1,  7.1), ylim = c(0, 100), clip = "off") +
    
    scale_x_discrete  (expand  = c(0, 0), 
                       breaks  = unique(df_graphbar$outcome_bar), 
                       labels  = bar_labels) +
    
    scale_y_continuous(#limits = c(0, 1),
                       expand  = c(0, 0),  
                       breaks  = seq(0, 100, 20), 
                       labels  = seq(0, 100, 20)) +
  
    
    #     Add title 
  
    ylab("Risk, %") + 
    xlab("\n Outcome") 
    
 
#  
 ckbplotr::save_figure(
   
   abstract_barplot, 
   ext = c("png", "png"),
   pagedim = unit(c(14, 15.5), "cm"),
   # pagedim = "A4",
   margin  = unit(c(
                0.1, 
                0.1, 
                0.1, 
                0.1), 
                units = "cm"),
   landscape = TRUE, 
   cropped = TRUE,
   name = "Fig graphical abstract", 
   title = "",  
   args = list(
            bg = "white", 
            pointsize = 10
            ), 
   args_cropped = list(
            bg = "white", 
            pointsize = 10
            )
 )   
 





```

